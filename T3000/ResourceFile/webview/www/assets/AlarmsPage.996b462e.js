import{j as e}from"./react.3bc90b5d.js";import{r as a,R as s}from"./client.58f92968.js";import{R as r,aN as t,M as l,u as o,E as n,T as i,h as d,N as c,i as p,P as x,Q as m,I as h,a3 as u,aM as j,S as _,U as f,V as g,X as w,B as b,b5 as v,$ as C}from"./App.4ea21eda.js";import{c as N,D as y,a as S,b as I,d as k,e as D,f as B}from"./DataGridHeaderCell.c083631d.js";import{T as A}from"./TableCellLayout.777c5080.js";import"./index.f111124c.js";import"./Serializer.f6a5f515.js";import"./axios.65f6a2c9.js";import"./T3Data.f6c34e59.js";import"./_commonjsHelpers.a5007c1f.js";class W{static async refreshAllFromDevice(e){return r.refreshAllAlarms(e)}static async refreshSingleFromDevice(e,a){return r.refreshSingleAlarm(e,a)}static async loadAllFromDB(e){return new t(`${l}/api`).alarms.getAll(e)}static async loadFromDB(e,a){const s=new t(`${l}/api`);return(await s.alarms.getAll(e)).find((e=>e.Alarm_ID===a))}static async loadByIdFromDB(e){const[a,s]=e.split("-"),r=parseInt(a),o=parseInt(s);if(isNaN(r)||isNaN(o))return;const n=new t(`${l}/api`);return await n.alarms.get(r,o)||void 0}static async validate(e){const a=[];return(e.index<0||e.index>31)&&a.push("Index must be between 0-31"),e.label&&""!==e.label.trim()||a.push("Label is required"),{valid:0===a.length,errors:a}}}var R={container:"_container_97ww0_35",bladeContentContainer:"_bladeContentContainer_97ww0_59",bladeContentWrapper:"_bladeContentWrapper_97ww0_75",bladeContent:"_bladeContent_97ww0_59",partContent:"_partContent_97ww0_107",toolbar:"_toolbar_97ww0_125",toolbarContainer:"_toolbarContainer_97ww0_143",toolbarButton:"_toolbarButton_97ww0_159",toolbarSeparator:"_toolbarSeparator_97ww0_237",searchInputWrapper:"_searchInputWrapper_97ww0_253",searchIcon:"_searchIcon_97ww0_267",searchInput:"_searchInput_97ww0_253",bladeDescription:"_bladeDescription_97ww0_347",overviewHr:"_overviewHr_97ww0_387",dockingBody:"_dockingBody_97ww0_403",loading:"_loading_97ww0_421",noData:"_noData_97ww0_423",loadingBar:"_loadingBar_97ww0_441",editableCell:"_editableCell_97ww0_761",editInput:"_editInput_97ww0_789",saveButton:"_saveButton_97ww0_861",refreshIconButton:"_refreshIconButton_97ww0_929",rotating:"_rotating_97ww0_1021"};var F=()=>{const{selectedDevice:r,treeData:t,selectDevice:F}=o(),[H,T]=a.exports.useState([]),[z,$]=a.exports.useState(!1),[E,M]=a.exports.useState(null),[L,P]=a.exports.useState(!1),[Y,V]=a.exports.useState({}),[O,U]=a.exports.useState(!1),[q,G]=a.exports.useState(null),[Q,X]=a.exports.useState("ascending"),[J,K]=a.exports.useState(""),[Z,ee]=a.exports.useState(!1),[ae,se]=a.exports.useState(new Set),[re,te]=a.exports.useState(!1),le=a.exports.useRef(!1);a.exports.useEffect((()=>{if(!r&&t.length>0){const e=a=>{for(const s of a){if(s.data)return s;if(s.children&&s.children.length>0){const a=e(s.children);if(a)return a}}return null},a=e(t);(null==a?void 0:a.data)&&F(a.data)}}),[r,t,F]);const oe=a.exports.useCallback((async()=>{if(r){$(!0),M(null);try{const e=await fetch(`${l}/api/t3_device/devices/${r.serialNumber}/table/ALARMS`);if(!e.ok)throw new Error("Failed to fetch alarms");const a=await e.json();T(a.data||[])}catch(e){M(e instanceof Error?e.message:"Failed to fetch alarms"),T([])}finally{$(!1)}}else T([])}),[r]);a.exports.useEffect((()=>{oe(),te(!1),le.current=!1}),[oe]),a.exports.useEffect((()=>{if(z||!r||re||le.current)return;(async()=>{le.current=!0;try{const e=r.serialNumber;await W.refreshAllFromDevice(e);await oe(),te(!0)}catch(e){}})()}),[z,r,re,oe]);const ne=(e,a)=>{var s,r,t;const l=e.alarm_id;return null!=(t=null!=(r=null==(s=Y[l])?void 0:s[a])?r:e[a])?t:""},ie=e=>{const a="Yes"===ne(e,"acknowledged")?"No":"Yes";var s,r,t;s=e.alarm_id,r="acknowledged",t=a,V((e=>({...e,[s]:{...e[s]||{},[r]:t}}))),U(!0)},de=s.useMemo((()=>0===H.length?Array(10).fill(null).map(((e,a)=>({alarm_id:"",panel:"",message:"",time_stamp:"",acknowledged:"",status:""}))):H),[H]),ce=e=>!e.alarm_id&&0===H.length,pe=a.exports.useMemo((()=>[N({columnId:"alarm_id",compare:(e,a)=>Number(e.alarm_id)-Number(a.alarm_id),renderHeaderCell:()=>e.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>{var e;q===(e="alarm_id")?X("ascending"===Q?"descending":"ascending"):(G(e),X("ascending"))},children:[e.exports.jsx("span",{children:"NUM"}),"alarm_id"===q?"ascending"===Q?e.exports.jsx(f,{}):e.exports.jsx(g,{}):e.exports.jsx(w,{style:{opacity:.5}})]}),renderCell:a=>{const s=a.alarm_id&&ae.has(a.alarm_id);return e.exports.jsx(A,{className:R.numCell,children:!ce(a)&&e.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.exports.jsx("button",{className:`${R.refreshIconButton} ${s?R.rotating:""}`,onClick:e=>{e.stopPropagation(),(async e=>{if(!r||!e.alarm_id)return;const a=e.alarm_id;se((e=>new Set(e).add(a)));try{const s=r.serialNumber,t=parseInt(e.alarm_id);await W.refreshSingleFromDevice(s,t),await oe()}catch(s){}finally{se((e=>{const s=new Set(e);return s.delete(a),s}))}})(a)},disabled:s,title:"Refresh this alarm from device","aria-label":"Refresh alarm",children:e.exports.jsx(d,{fontSize:16})}),e.exports.jsx("span",{children:a.alarm_id})]})})}}),N({columnId:"panel",compare:(e,a)=>(e.panel||"").localeCompare(a.panel||""),renderHeaderCell:()=>e.exports.jsx("div",{className:R.headerText,children:"Panel"}),renderCell:a=>e.exports.jsx(A,{className:R.readOnlyCell,children:!ce(a)&&ne(a,"panel")})}),N({columnId:"message",compare:(e,a)=>(e.message||"").localeCompare(a.message||""),renderHeaderCell:()=>e.exports.jsx("div",{className:R.headerText,children:"Message"}),renderCell:a=>e.exports.jsx(A,{className:R.messageCell,children:!ce(a)&&ne(a,"message")})}),N({columnId:"time_stamp",compare:(e,a)=>(e.time_stamp||"").localeCompare(a.time_stamp||""),renderHeaderCell:()=>e.exports.jsx("div",{className:R.headerText,children:"Time"}),renderCell:a=>e.exports.jsx(A,{className:R.timeCell,children:!ce(a)&&ne(a,"time_stamp")})}),N({columnId:"acknowledged",compare:(e,a)=>(e.acknowledged||"").localeCompare(a.acknowledged||""),renderHeaderCell:()=>e.exports.jsx("div",{className:R.headerText,children:"Acknowledge"}),renderCell:a=>{const s="Yes"===ne(a,"acknowledged");return e.exports.jsx(A,{children:!ce(a)&&e.exports.jsx("div",{className:R.acknowledgeContainer,children:e.exports.jsx(b,{appearance:s?"primary":"secondary",size:"small",icon:s?e.exports.jsx(v,{}):void 0,onClick:()=>ie(a),children:s?"Acknowledged":"Acknowledge"})})})}}),N({columnId:"status",compare:(e,a)=>(e.status||"").localeCompare(a.status||""),renderHeaderCell:()=>e.exports.jsx("div",{className:R.headerText,children:"Res"}),renderCell:a=>{const s=ne(a,"status"),r="Resolved"===s||"Yes"===s;return e.exports.jsx(A,{children:!ce(a)&&e.exports.jsx(C,{appearance:r?"success":"important",className:R.statusBadge,children:r?"Resolved":"Active"})})}}),N({columnId:"delete",renderHeaderCell:()=>e.exports.jsx("div",{className:R.headerText,children:"Delete"}),renderCell:a=>e.exports.jsx(A,{children:!ce(a)&&e.exports.jsx(b,{appearance:"secondary",size:"small",onClick:()=>{},children:"Delete"})})})]),[Y]);H.filter((e=>"Resolved"!==e.status&&"Yes"!==e.status)).length;return H.length,e.exports.jsx("div",{className:R.container,children:e.exports.jsx("div",{className:R.bladeContentContainer,children:e.exports.jsx("div",{className:R.bladeContentWrapper,children:e.exports.jsx("div",{className:R.bladeContent,children:e.exports.jsxs("div",{className:R.partContent,children:[E&&e.exports.jsxs("div",{style:{marginBottom:"12px",padding:"8px 12px",backgroundColor:"#fef6f6",borderRadius:"4px",display:"flex",alignItems:"center",gap:"8px"},children:[e.exports.jsx(n,{style:{color:"#d13438",fontSize:"16px",flexShrink:0}}),e.exports.jsx(i,{style:{color:"#d13438",fontWeight:500,fontSize:"13px"},children:E})]}),r&&e.exports.jsxs(e.exports.Fragment,{children:[e.exports.jsx("div",{className:R.toolbar,children:e.exports.jsxs("div",{className:R.toolbarContainer,children:[e.exports.jsxs("button",{className:R.toolbarButton,onClick:async()=>{if(r){ee(!0),M(null);try{const e=r.serialNumber;await W.refreshAllFromDevice(e);await oe()}catch(e){M(e instanceof Error?e.message:"Failed to refresh from device")}finally{ee(!1)}}},disabled:Z,title:"Refresh from Device","aria-label":"Refresh from Device",children:[e.exports.jsx(d,{className:Z?R.rotating:""}),e.exports.jsx("span",{children:Z?"Refreshing...":"Refresh from Device"})]}),e.exports.jsxs("button",{className:R.toolbarButton,onClick:()=>{},title:"Export to CSV","aria-label":"Export to CSV",children:[e.exports.jsx(c,{}),e.exports.jsx("span",{children:"Export to CSV"})]}),e.exports.jsx("div",{className:R.toolbarSeparator,role:"separator"}),e.exports.jsxs("button",{className:R.toolbarButton,onClick:()=>{},title:"Settings","aria-label":"Settings",children:[e.exports.jsx(p,{}),e.exports.jsx("span",{children:"Settings"})]}),e.exports.jsxs("div",{className:R.searchInputWrapper,children:[e.exports.jsx(x,{className:R.searchIcon}),e.exports.jsx("input",{className:R.searchInput,type:"text",placeholder:"Search alarms...",value:J,onChange:e=>{K(e.target.value)},spellCheck:"false",role:"searchbox","aria-label":"Search alarms"})]}),r&&e.exports.jsx(m,{content:`Showing alarm log for ${r.nameShowOnTree} (SN: ${r.serialNumber}). This table displays all alarm records including active and resolved alarms.`,relationship:"description",children:e.exports.jsx("button",{className:R.toolbarButton,style:{marginLeft:"8px"},title:"Information","aria-label":"Information about this page",children:e.exports.jsx(h,{})})}),O&&e.exports.jsxs(e.exports.Fragment,{children:[e.exports.jsx("div",{className:R.toolbarSeparator,role:"separator"}),e.exports.jsxs("button",{className:R.toolbarButton,onClick:()=>{V({}),U(!1)},title:"Discard Changes","aria-label":"Discard Changes",children:[e.exports.jsx(u,{}),e.exports.jsx("span",{children:"Discard"})]}),e.exports.jsxs("button",{className:`${R.toolbarButton} ${R.toolbarButtonPrimary}`,onClick:async()=>{P(!0);try{V({}),U(!1)}catch(e){}finally{P(!1)}},disabled:L,title:"Save All","aria-label":"Save All",children:[e.exports.jsx(j,{}),e.exports.jsx("span",{children:L?"Saving...":"Save All"})]})]})]})}),e.exports.jsx("div",{style:{padding:"0"},children:e.exports.jsx("hr",{className:R.overviewHr})})]}),e.exports.jsxs("div",{className:R.dockingBody,children:[z&&0===H.length&&e.exports.jsxs("div",{className:R.loadingBar,children:[e.exports.jsx(_,{size:"tiny"}),e.exports.jsx(i,{size:200,weight:"regular",children:"Loading alarms..."})]}),!r&&!z&&e.exports.jsx("div",{className:R.noData,children:e.exports.jsxs("div",{style:{textAlign:"center"},children:[e.exports.jsx(i,{size:400,weight:"semibold",children:"No device selected"}),e.exports.jsx("br",{}),e.exports.jsx(i,{size:200,children:"Please select a device from the tree to view alarms"})]})}),r&&!z&&!E&&e.exports.jsx(e.exports.Fragment,{children:e.exports.jsxs(y,{items:de,columns:pe,sortable:!0,resizableColumns:!0,columnSizingOptions:{alarm_id:{minWidth:60,defaultWidth:80},panel:{minWidth:100,defaultWidth:120},message:{minWidth:200,defaultWidth:300},time_stamp:{minWidth:140,defaultWidth:180},acknowledged:{minWidth:100,defaultWidth:120},status:{minWidth:80,defaultWidth:100},actions:{minWidth:80,defaultWidth:100}},children:[e.exports.jsx(S,{children:e.exports.jsx(I,{children:({renderHeaderCell:a})=>e.exports.jsx(k,{children:a()})})}),e.exports.jsx(D,{children:({item:a,rowId:s})=>e.exports.jsx(I,{children:({renderCell:s})=>e.exports.jsx(B,{children:s(a)})},s)})]})})]})]})})})})})};export{F as default};

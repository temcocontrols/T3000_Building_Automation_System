import{j as e}from"./react.8639cc86.js";import{r as a,R as s}from"./client.58f92968.js";import{R as r,aN as t,M as l,l as o,n,T as i,y as c,N as d,z as p,P as x,Q as m,I as h,a3 as u,aM as g,S as f,U as _,V as j,X as v,B as b,b5 as C,$ as w}from"./App.7c34790a.js";import{c as N,D as S,a as y,b as I,d as k,e as D,f as B}from"./DataGridHeaderCell.ec45a911.js";import{T as A}from"./TableCellLayout.d4b0b796.js";import"./index.3bd6c859.js";import"./Serializer.f6a5f515.js";import"./axios.65f6a2c9.js";import"./T3Data.63f93fe7.js";import"./_commonjsHelpers.a5007c1f.js";class W{static async refreshAllFromDevice(e){return r.refreshAllAlarms(e)}static async refreshSingleFromDevice(e,a){return r.refreshSingleAlarm(e,a)}static async loadAllFromDB(e){return new t(`${l}/api`).alarms.getAll(e)}static async loadFromDB(e,a){const s=new t(`${l}/api`);return(await s.alarms.getAll(e)).find((e=>e.Alarm_ID===a))}static async loadByIdFromDB(e){const[a,s]=e.split("-"),r=parseInt(a),o=parseInt(s);if(isNaN(r)||isNaN(o))return;const n=new t(`${l}/api`);return await n.alarms.get(r,o)||void 0}static async validate(e){const a=[];return(e.index<0||e.index>31)&&a.push("Index must be between 0-31"),e.label&&""!==e.label.trim()||a.push("Label is required"),{valid:0===a.length,errors:a}}}var R={container:"_container_181aw_18",bladeContentContainer:"_bladeContentContainer_181aw_30",bladeContentWrapper:"_bladeContentWrapper_181aw_38",bladeContent:"_bladeContent_181aw_30",partContent:"_partContent_181aw_54",toolbar:"_toolbar_181aw_63",toolbarContainer:"_toolbarContainer_181aw_72",toolbarButton:"_toolbarButton_181aw_80",toolbarSeparator:"_toolbarSeparator_181aw_119",searchInputWrapper:"_searchInputWrapper_181aw_127",searchIcon:"_searchIcon_181aw_134",searchInput:"_searchInput_181aw_127",bladeDescription:"_bladeDescription_181aw_174",overviewHr:"_overviewHr_181aw_194",dockingBody:"_dockingBody_181aw_202",loading:"_loading_181aw_211",noData:"_noData_181aw_212",loadingBar:"_loadingBar_181aw_221",editableCell:"_editableCell_181aw_381",editInput:"_editInput_181aw_395",saveButton:"_saveButton_181aw_431",refreshIconButton:"_refreshIconButton_181aw_465",rotating:"_rotating_181aw_511"};var F=()=>{const{selectedDevice:r,treeData:t,selectDevice:F}=o(),[z,H]=a.exports.useState([]),[T,$]=a.exports.useState(!1),[E,M]=a.exports.useState(null),[L,P]=a.exports.useState(!1),[V,Y]=a.exports.useState({}),[O,U]=a.exports.useState(!1),[q,G]=a.exports.useState(null),[Q,X]=a.exports.useState("ascending"),[J,K]=a.exports.useState(""),[Z,ee]=a.exports.useState(!1),[ae,se]=a.exports.useState(new Set),[re,te]=a.exports.useState(!1),le=a.exports.useRef(!1);a.exports.useEffect((()=>{if(!r&&t.length>0){const e=a=>{for(const s of a){if(s.data)return s;if(s.children&&s.children.length>0){const a=e(s.children);if(a)return a}}return null},a=e(t);(null==a?void 0:a.data)&&F(a.data)}}),[r,t,F]);const oe=a.exports.useCallback((async()=>{if(r){$(!0),M(null);try{const e=await fetch(`${l}/api/t3_device/devices/${r.serialNumber}/table/ALARMS`);if(!e.ok)throw new Error("Failed to fetch alarms");const a=await e.json();H(a.data||[])}catch(e){console.error("Error fetching alarms:",e),M(e instanceof Error?e.message:"Failed to fetch alarms"),H([])}finally{$(!1)}}else H([])}),[r]);a.exports.useEffect((()=>{oe(),te(!1),le.current=!1}),[oe]),a.exports.useEffect((()=>{if(T||!r||re||le.current)return;(async()=>{le.current=!0,console.log("ðŸ”„ Auto-refreshing alarms from device on page load...");try{const e=r.serialNumber,a=await W.refreshAllFromDevice(e);console.log("âœ… Auto-refresh response:",a),await oe(),te(!0)}catch(e){console.error("âŒ Auto-refresh failed:",e)}})()}),[T,r,re,oe]);const ne=(e,a)=>{var s,r,t;const l=e.alarm_id;return null!=(t=null!=(r=null==(s=V[l])?void 0:s[a])?r:e[a])?t:""},ie=e=>{const a="Yes"===ne(e,"acknowledged")?"No":"Yes";var s,r,t;s=e.alarm_id,r="acknowledged",t=a,Y((e=>({...e,[s]:{...e[s]||{},[r]:t}}))),U(!0)},ce=s.useMemo((()=>0===z.length?Array(10).fill(null).map(((e,a)=>({alarm_id:"",panel:"",message:"",time_stamp:"",acknowledged:"",status:""}))):z),[z]),de=e=>!e.alarm_id&&0===z.length,pe=a.exports.useMemo((()=>[N({columnId:"alarm_id",compare:(e,a)=>Number(e.alarm_id)-Number(a.alarm_id),renderHeaderCell:()=>e.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>{var e;q===(e="alarm_id")?X("ascending"===Q?"descending":"ascending"):(G(e),X("ascending"))},children:[e.exports.jsx("span",{children:"NUM"}),"alarm_id"===q?"ascending"===Q?e.exports.jsx(_,{}):e.exports.jsx(j,{}):e.exports.jsx(v,{style:{opacity:.5}})]}),renderCell:a=>{const s=a.alarm_id&&ae.has(a.alarm_id);return e.exports.jsx(A,{className:R.numCell,children:!de(a)&&e.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.exports.jsx("button",{className:`${R.refreshIconButton} ${s?R.rotating:""}`,onClick:e=>{e.stopPropagation(),(async e=>{if(!r||!e.alarm_id)return;const a=e.alarm_id;se((e=>new Set(e).add(a)));try{const s=r.serialNumber,t=parseInt(e.alarm_id);console.log(`ðŸ”„ Refreshing single alarm from device: ${t}`);const l=await W.refreshSingleFromDevice(s,t);console.log("âœ… Single alarm refresh response:",l),await oe()}catch(s){console.error("âŒ Single alarm refresh failed:",s)}finally{se((e=>{const s=new Set(e);return s.delete(a),s}))}})(a)},disabled:s,title:"Refresh this alarm from device","aria-label":"Refresh alarm",children:e.exports.jsx(c,{fontSize:16})}),e.exports.jsx("span",{children:a.alarm_id})]})})}}),N({columnId:"panel",compare:(e,a)=>(e.panel||"").localeCompare(a.panel||""),renderHeaderCell:()=>e.exports.jsx("div",{className:R.headerText,children:"Panel"}),renderCell:a=>e.exports.jsx(A,{className:R.readOnlyCell,children:!de(a)&&ne(a,"panel")})}),N({columnId:"message",compare:(e,a)=>(e.message||"").localeCompare(a.message||""),renderHeaderCell:()=>e.exports.jsx("div",{className:R.headerText,children:"Message"}),renderCell:a=>e.exports.jsx(A,{className:R.messageCell,children:!de(a)&&ne(a,"message")})}),N({columnId:"time_stamp",compare:(e,a)=>(e.time_stamp||"").localeCompare(a.time_stamp||""),renderHeaderCell:()=>e.exports.jsx("div",{className:R.headerText,children:"Time"}),renderCell:a=>e.exports.jsx(A,{className:R.timeCell,children:!de(a)&&ne(a,"time_stamp")})}),N({columnId:"acknowledged",compare:(e,a)=>(e.acknowledged||"").localeCompare(a.acknowledged||""),renderHeaderCell:()=>e.exports.jsx("div",{className:R.headerText,children:"Acknowledge"}),renderCell:a=>{const s="Yes"===ne(a,"acknowledged");return e.exports.jsx(A,{children:!de(a)&&e.exports.jsx("div",{className:R.acknowledgeContainer,children:e.exports.jsx(b,{appearance:s?"primary":"secondary",size:"small",icon:s?e.exports.jsx(C,{}):void 0,onClick:()=>ie(a),children:s?"Acknowledged":"Acknowledge"})})})}}),N({columnId:"status",compare:(e,a)=>(e.status||"").localeCompare(a.status||""),renderHeaderCell:()=>e.exports.jsx("div",{className:R.headerText,children:"Res"}),renderCell:a=>{const s=ne(a,"status"),r="Resolved"===s||"Yes"===s;return e.exports.jsx(A,{children:!de(a)&&e.exports.jsx(w,{appearance:r?"success":"important",className:R.statusBadge,children:r?"Resolved":"Active"})})}}),N({columnId:"delete",renderHeaderCell:()=>e.exports.jsx("div",{className:R.headerText,children:"Delete"}),renderCell:a=>e.exports.jsx(A,{children:!de(a)&&e.exports.jsx(b,{appearance:"secondary",size:"small",onClick:()=>(e=>{console.log("Delete alarm:",e.alarm_id)})(a),children:"Delete"})})})]),[V]);z.filter((e=>"Resolved"!==e.status&&"Yes"!==e.status)).length;return z.length,e.exports.jsx("div",{className:R.container,children:e.exports.jsx("div",{className:R.bladeContentContainer,children:e.exports.jsx("div",{className:R.bladeContentWrapper,children:e.exports.jsx("div",{className:R.bladeContent,children:e.exports.jsxs("div",{className:R.partContent,children:[E&&e.exports.jsxs("div",{style:{marginBottom:"12px",padding:"8px 12px",backgroundColor:"#fef6f6",borderRadius:"4px",display:"flex",alignItems:"center",gap:"8px"},children:[e.exports.jsx(n,{style:{color:"#d13438",fontSize:"16px",flexShrink:0}}),e.exports.jsx(i,{style:{color:"#d13438",fontWeight:500,fontSize:"13px"},children:E})]}),r&&e.exports.jsxs(e.exports.Fragment,{children:[e.exports.jsx("div",{className:R.toolbar,children:e.exports.jsxs("div",{className:R.toolbarContainer,children:[e.exports.jsxs("button",{className:R.toolbarButton,onClick:async()=>{if(r){ee(!0),M(null);try{const e=r.serialNumber;console.log("ðŸ”„ Refreshing all alarms from device...");const a=await W.refreshAllFromDevice(e);console.log("âœ… Device refresh response:",a),await oe()}catch(e){console.error("âŒ Refresh from device failed:",e),M(e instanceof Error?e.message:"Failed to refresh from device")}finally{ee(!1)}}},disabled:Z,title:"Refresh from Device","aria-label":"Refresh from Device",children:[e.exports.jsx(c,{className:Z?R.rotating:""}),e.exports.jsx("span",{children:Z?"Refreshing...":"Refresh from Device"})]}),e.exports.jsxs("button",{className:R.toolbarButton,onClick:()=>{console.log("Export alarms to CSV")},title:"Export to CSV","aria-label":"Export to CSV",children:[e.exports.jsx(d,{}),e.exports.jsx("span",{children:"Export to CSV"})]}),e.exports.jsx("div",{className:R.toolbarSeparator,role:"separator"}),e.exports.jsxs("button",{className:R.toolbarButton,onClick:()=>{console.log("Settings clicked")},title:"Settings","aria-label":"Settings",children:[e.exports.jsx(p,{}),e.exports.jsx("span",{children:"Settings"})]}),e.exports.jsxs("div",{className:R.searchInputWrapper,children:[e.exports.jsx(x,{className:R.searchIcon}),e.exports.jsx("input",{className:R.searchInput,type:"text",placeholder:"Search alarms...",value:J,onChange:e=>{K(e.target.value)},spellCheck:"false",role:"searchbox","aria-label":"Search alarms"})]}),r&&e.exports.jsx(m,{content:`Showing alarm log for ${r.nameShowOnTree} (SN: ${r.serialNumber}). This table displays all alarm records including active and resolved alarms.`,relationship:"description",children:e.exports.jsx("button",{className:R.toolbarButton,style:{marginLeft:"8px"},title:"Information","aria-label":"Information about this page",children:e.exports.jsx(h,{})})}),O&&e.exports.jsxs(e.exports.Fragment,{children:[e.exports.jsx("div",{className:R.toolbarSeparator,role:"separator"}),e.exports.jsxs("button",{className:R.toolbarButton,onClick:()=>{Y({}),U(!1)},title:"Discard Changes","aria-label":"Discard Changes",children:[e.exports.jsx(u,{}),e.exports.jsx("span",{children:"Discard"})]}),e.exports.jsxs("button",{className:`${R.toolbarButton} ${R.toolbarButtonPrimary}`,onClick:async()=>{P(!0);try{console.log("Saving changes:",V),Y({}),U(!1)}catch(e){console.error("Error saving changes:",e)}finally{P(!1)}},disabled:L,title:"Save All","aria-label":"Save All",children:[e.exports.jsx(g,{}),e.exports.jsx("span",{children:L?"Saving...":"Save All"})]})]})]})}),e.exports.jsx("div",{style:{padding:"0"},children:e.exports.jsx("hr",{className:R.overviewHr})})]}),e.exports.jsxs("div",{className:R.dockingBody,children:[T&&0===z.length&&e.exports.jsxs("div",{className:R.loadingBar,children:[e.exports.jsx(f,{size:"tiny"}),e.exports.jsx(i,{size:200,weight:"regular",children:"Loading alarms..."})]}),!r&&!T&&e.exports.jsx("div",{className:R.noData,children:e.exports.jsxs("div",{style:{textAlign:"center"},children:[e.exports.jsx(i,{size:400,weight:"semibold",children:"No device selected"}),e.exports.jsx("br",{}),e.exports.jsx(i,{size:200,children:"Please select a device from the tree to view alarms"})]})}),r&&!T&&!E&&e.exports.jsx(e.exports.Fragment,{children:e.exports.jsxs(S,{items:ce,columns:pe,sortable:!0,resizableColumns:!0,columnSizingOptions:{alarm_id:{minWidth:60,defaultWidth:80},panel:{minWidth:100,defaultWidth:120},message:{minWidth:200,defaultWidth:300},time_stamp:{minWidth:140,defaultWidth:180},acknowledged:{minWidth:100,defaultWidth:120},status:{minWidth:80,defaultWidth:100},actions:{minWidth:80,defaultWidth:100}},children:[e.exports.jsx(y,{children:e.exports.jsx(I,{children:({renderHeaderCell:a})=>e.exports.jsx(k,{children:a()})})}),e.exports.jsx(D,{children:({item:a,rowId:s})=>e.exports.jsx(I,{children:({renderCell:s})=>e.exports.jsx(B,{children:s(a)})},s)})]})})]})]})})})})})};export{F as default};

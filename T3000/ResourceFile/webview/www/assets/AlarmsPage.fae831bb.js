var e,s,t=Object.defineProperty;import{j as a}from"./react.2da10d74.js";import{r}from"./client.b9d1bbf8.js";import{A as l,w as n,x as o,T as i,y as d,z as c,S as p,C as x,D as m,I as h,M as u,F as b,B as f,H as j,J as g,K as _,b2 as C}from"./App.2c62e2d1.js";import{c as v,D as y,a as w,b as k,d as N,e as S,f as I,T}from"./DataGridHeaderCell.34491fc4.js";import{B}from"./Badge.bfe12ada.js";import{S as A}from"./chunk-14.975a9417.js";import"./index.5672de35.js";import"./Serializer.f6a5f515.js";import"./useFocusableGroup.6d334b5b.js";class W{static async refreshAllAlarms(e){const s=await fetch(`${this.baseUrl}/alarms/${e}/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});if(!s.ok){const e=await s.text();throw new Error(`HTTP ${s.status}: ${e||s.statusText}`)}return await s.json()}static async saveRefreshedAlarms(e,s){const t=await fetch(`${this.baseUrl}/alarms/${e}/save-refreshed`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:s})});if(!t.ok){const e=await t.text();throw new Error(`HTTP ${t.status}: ${e||t.statusText}`)}return await t.json()}static async refreshAlarm(e,s){const t=await fetch(`${this.baseUrl}/alarms/${e}/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({index:s})});if(!t.ok){const e=await t.text();throw new Error(`HTTP ${t.status}: ${e||t.statusText}`)}return await t.json()}}s=`${l}/api/t3_device`,((e,s,a)=>{s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[s]=a})(W,"symbol"!=typeof(e="baseUrl")?e+"":e,s);var $={container:"_container_bnp9k_35",bladeContentContainer:"_bladeContentContainer_bnp9k_59",bladeContentWrapper:"_bladeContentWrapper_bnp9k_75",bladeContent:"_bladeContent_bnp9k_59",partContent:"_partContent_bnp9k_107",toolbar:"_toolbar_bnp9k_125",toolbarContainer:"_toolbarContainer_bnp9k_143",toolbarButton:"_toolbarButton_bnp9k_159",toolbarSeparator:"_toolbarSeparator_bnp9k_237",searchInputWrapper:"_searchInputWrapper_bnp9k_253",searchIcon:"_searchIcon_bnp9k_267",searchInput:"_searchInput_bnp9k_253",bladeDescription:"_bladeDescription_bnp9k_347",overviewHr:"_overviewHr_bnp9k_387",dockingBody:"_dockingBody_bnp9k_403",loading:"_loading_bnp9k_421",noData:"_noData_bnp9k_423",loadingBar:"_loadingBar_bnp9k_441",editableCell:"_editableCell_bnp9k_721",editInput:"_editInput_bnp9k_749",saveButton:"_saveButton_bnp9k_821",refreshIconButton:"_refreshIconButton_bnp9k_889",rotating:"_rotating_bnp9k_981"};var D=()=>{const{selectedDevice:e,treeData:s,selectDevice:t}=n(),[D,H]=r.exports.useState([]),[R,z]=r.exports.useState(!1),[E,P]=r.exports.useState(null),[O,M]=r.exports.useState(!1),[F,U]=r.exports.useState({}),[V,Y]=r.exports.useState(!1),[J,L]=r.exports.useState(null),[Z,G]=r.exports.useState("ascending"),[K,q]=r.exports.useState(""),[Q,X]=r.exports.useState(!1),[ee,se]=r.exports.useState(new Set),[te,ae]=r.exports.useState(!1);r.exports.useEffect((()=>{if(!e&&s.length>0){const e=s=>{for(const t of s){if(t.data)return t;if(t.children&&t.children.length>0){const s=e(t.children);if(s)return s}}return null},a=e(s);(null==a?void 0:a.data)&&t(a.data)}}),[e,s,t]);const re=r.exports.useCallback((async()=>{if(e){z(!0),P(null);try{const s=await fetch(`${l}/api/t3_device/devices/${e.serialNumber}/table/ALARMS`);if(!s.ok)throw new Error("Failed to fetch alarms");const t=await s.json();H(t.data||[])}catch(s){P(s instanceof Error?s.message:"Failed to fetch alarms"),H([])}finally{z(!1)}}else H([])}),[e]);r.exports.useEffect((()=>{re()}),[re]),r.exports.useEffect((()=>{if(R||!e||te)return;const s=setTimeout((async()=>{try{const s=e.serialNumber,t=await W.refreshAllAlarms(s);t&&t.items&&(await W.saveRefreshedAlarms(s,t.items),await re()),ae(!0)}catch(s){}}),500);return()=>clearTimeout(s)}),[R,e,te,re]);const le=(e,s)=>{var t,a,r;const l=e.alarm_id;return null!=(r=null!=(a=null==(t=F[l])?void 0:t[s])?a:e[s])?r:""},ne=e=>{const s="Yes"===le(e,"acknowledged")?"No":"Yes";((e,s,t)=>{U((a=>({...a,[e]:{...a[e]||{},[s]:t}}))),Y(!0)})(e.alarm_id,"acknowledged",s)},oe=r.exports.useMemo((()=>[v({columnId:"alarm_id",compare:(e,s)=>Number(e.alarm_id)-Number(s.alarm_id),renderHeaderCell:()=>a.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>{var e;J===(e="alarm_id")?G("ascending"===Z?"descending":"ascending"):(L(e),G("ascending"))},children:[a.exports.jsx("span",{children:"NUM"}),"alarm_id"===J?"ascending"===Z?a.exports.jsx(j,{}):a.exports.jsx(g,{}):a.exports.jsx(_,{style:{opacity:.5}})]}),renderCell:s=>{const t=s.alarm_id&&ee.has(s.alarm_id);return a.exports.jsx(T,{className:$.numCell,children:a.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[a.exports.jsx("button",{className:`${$.refreshIconButton} ${t?$.rotating:""}`,onClick:t=>{t.stopPropagation(),(async s=>{if(!e||!s.alarm_id)return;const t=s.alarm_id;se((e=>new Set(e).add(t)));try{const a=e.serialNumber,r=parseInt(s.alarm_id),l=await W.refreshAlarm(a,r);l&&l.items&&(await W.saveRefreshedAlarms(a,l.items),await re())}catch(a){}finally{se((e=>{const s=new Set(e);return s.delete(t),s}))}})(s)},disabled:t,title:"Refresh this alarm from device","aria-label":"Refresh alarm",children:a.exports.jsx(d,{fontSize:16})}),a.exports.jsx("span",{children:s.alarm_id})]})})}}),v({columnId:"panel",compare:(e,s)=>(e.panel||"").localeCompare(s.panel||""),renderHeaderCell:()=>a.exports.jsx("div",{className:$.headerText,children:"Panel"}),renderCell:e=>a.exports.jsx(T,{className:$.readOnlyCell,children:le(e,"panel")})}),v({columnId:"message",compare:(e,s)=>(e.message||"").localeCompare(s.message||""),renderHeaderCell:()=>a.exports.jsx("div",{className:$.headerText,children:"Message"}),renderCell:e=>a.exports.jsx(T,{className:$.messageCell,children:le(e,"message")})}),v({columnId:"time_stamp",compare:(e,s)=>(e.time_stamp||"").localeCompare(s.time_stamp||""),renderHeaderCell:()=>a.exports.jsx("div",{className:$.headerText,children:"Time"}),renderCell:e=>a.exports.jsx(T,{className:$.timeCell,children:le(e,"time_stamp")})}),v({columnId:"acknowledged",compare:(e,s)=>(e.acknowledged||"").localeCompare(s.acknowledged||""),renderHeaderCell:()=>a.exports.jsx("div",{className:$.headerText,children:"Acknowledge"}),renderCell:e=>{const s="Yes"===le(e,"acknowledged");return a.exports.jsx(T,{children:a.exports.jsx("div",{className:$.acknowledgeContainer,children:a.exports.jsx(f,{appearance:s?"primary":"secondary",size:"small",icon:s?a.exports.jsx(C,{}):void 0,onClick:()=>ne(e),children:s?"Acknowledged":"Acknowledge"})})})}}),v({columnId:"status",compare:(e,s)=>(e.status||"").localeCompare(s.status||""),renderHeaderCell:()=>a.exports.jsx("div",{className:$.headerText,children:"Res"}),renderCell:e=>{const s=le(e,"status"),t="Resolved"===s||"Yes"===s;return a.exports.jsx(T,{children:a.exports.jsx(B,{appearance:t?"success":"important",className:$.statusBadge,children:t?"Resolved":"Active"})})}}),v({columnId:"delete",renderHeaderCell:()=>a.exports.jsx("div",{className:$.headerText,children:"Delete"}),renderCell:e=>a.exports.jsx(T,{children:a.exports.jsx(f,{appearance:"secondary",size:"small",onClick:()=>{},children:"Delete"})})})]),[F]);D.filter((e=>"Resolved"!==e.status&&"Yes"!==e.status)).length;return D.length,a.exports.jsx("div",{className:$.container,children:a.exports.jsx("div",{className:$.bladeContentContainer,children:a.exports.jsx("div",{className:$.bladeContentWrapper,children:a.exports.jsx("div",{className:$.bladeContent,children:a.exports.jsxs("div",{className:$.partContent,children:[E&&a.exports.jsxs("div",{style:{marginBottom:"12px",padding:"8px 12px",backgroundColor:"#fef6f6",borderRadius:"4px",display:"flex",alignItems:"center",gap:"8px"},children:[a.exports.jsx(o,{style:{color:"#d13438",fontSize:"16px",flexShrink:0}}),a.exports.jsx(i,{style:{color:"#d13438",fontWeight:500,fontSize:"13px"},children:E})]}),e&&a.exports.jsx("div",{className:$.toolbar,children:a.exports.jsxs("div",{className:$.toolbarContainer,children:[a.exports.jsxs("button",{className:$.toolbarButton,onClick:async()=>{if(e){X(!0),P(null);try{const s=e.serialNumber,t=await W.refreshAllAlarms(s);t&&t.items&&(await W.saveRefreshedAlarms(s,t.items),await re())}catch(s){P(s instanceof Error?s.message:"Failed to refresh from device")}finally{X(!1)}}},disabled:Q,title:"Refresh from Device","aria-label":"Refresh from Device",children:[a.exports.jsx(d,{className:Q?$.rotating:""}),a.exports.jsx("span",{children:Q?"Refreshing...":"Refresh from Device"})]}),a.exports.jsxs("button",{className:$.toolbarButton,onClick:()=>{},title:"Export to CSV","aria-label":"Export to CSV",children:[a.exports.jsx(c,{}),a.exports.jsx("span",{children:"Export to CSV"})]}),a.exports.jsx("div",{className:$.toolbarSeparator,role:"separator"}),a.exports.jsxs("button",{className:$.toolbarButton,onClick:()=>{},title:"Settings","aria-label":"Settings",children:[a.exports.jsx(p,{}),a.exports.jsx("span",{children:"Settings"})]}),a.exports.jsxs("div",{className:$.searchInputWrapper,children:[a.exports.jsx(x,{className:$.searchIcon}),a.exports.jsx("input",{className:$.searchInput,type:"text",placeholder:"Search alarms...",value:K,onChange:e=>{q(e.target.value)},spellCheck:"false",role:"searchbox","aria-label":"Search alarms"})]}),e&&a.exports.jsx(m,{content:`Showing alarm log for ${e.nameShowOnTree} (SN: ${e.serialNumber}). This table displays all alarm records including active and resolved alarms.`,relationship:"description",children:a.exports.jsx("button",{className:$.toolbarButton,style:{marginLeft:"8px"},title:"Information","aria-label":"Information about this page",children:a.exports.jsx(h,{})})}),V&&a.exports.jsxs(a.exports.Fragment,{children:[a.exports.jsx("div",{className:$.toolbarSeparator,role:"separator"}),a.exports.jsxs("button",{className:$.toolbarButton,onClick:()=>{U({}),Y(!1)},title:"Discard Changes","aria-label":"Discard Changes",children:[a.exports.jsx(u,{}),a.exports.jsx("span",{children:"Discard"})]}),a.exports.jsxs("button",{className:`${$.toolbarButton} ${$.toolbarButtonPrimary}`,onClick:async()=>{M(!0);try{U({}),Y(!1)}catch(e){}finally{M(!1)}},disabled:O,title:"Save All","aria-label":"Save All",children:[a.exports.jsx(A,{}),a.exports.jsx("span",{children:O?"Saving...":"Save All"})]})]})]})}),a.exports.jsx("div",{style:{padding:"0"},children:a.exports.jsx("hr",{className:$.overviewHr})}),a.exports.jsxs("div",{className:$.dockingBody,children:[R&&0===D.length&&a.exports.jsxs("div",{className:$.loadingBar,children:[a.exports.jsx(b,{size:"tiny"}),a.exports.jsx(i,{size:200,weight:"regular",children:"Loading alarms..."})]}),!e&&!R&&a.exports.jsx("div",{className:$.noData,children:a.exports.jsxs("div",{style:{textAlign:"center"},children:[a.exports.jsx(i,{size:500,weight:"semibold",children:"No device selected"}),a.exports.jsx("br",{}),a.exports.jsx(i,{size:300,children:"Please select a device from the tree to view alarms"})]})}),e&&!R&&!E&&a.exports.jsxs(a.exports.Fragment,{children:[a.exports.jsxs(y,{items:D,columns:oe,sortable:!0,resizableColumns:!0,columnSizingOptions:{alarm_id:{minWidth:60,defaultWidth:80},panel:{minWidth:100,defaultWidth:120},message:{minWidth:200,defaultWidth:300},time_stamp:{minWidth:140,defaultWidth:180},acknowledged:{minWidth:100,defaultWidth:120},status:{minWidth:80,defaultWidth:100},actions:{minWidth:80,defaultWidth:100}},children:[a.exports.jsx(w,{children:a.exports.jsx(k,{children:({renderHeaderCell:e})=>a.exports.jsx(N,{children:e()})})}),a.exports.jsx(S,{children:({item:e,rowId:s})=>a.exports.jsx(k,{children:({renderCell:s})=>a.exports.jsx(I,{children:s(e)})},s)})]}),0===D.length&&a.exports.jsxs("div",{style:{marginTop:"24px",textAlign:"center",padding:"0 20px"},children:[a.exports.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",marginBottom:"8px"},children:[a.exports.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",style:{opacity:.5},children:a.exports.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4ZM10 8V16H14V8H10Z",fill:"currentColor"})}),a.exports.jsx(i,{size:400,weight:"semibold",children:"No alarms found"})]}),a.exports.jsx(i,{size:300,style:{display:"block",marginBottom:"16px",color:"#605e5c",textAlign:"center"},children:"This device has no alarm logs"}),a.exports.jsx(f,{appearance:"subtle",icon:a.exports.jsx(d,{}),onClick:re,style:{minWidth:"120px",fontWeight:"normal"},children:"Refresh"})]})]})]})]})})})})})};export{D as default};

import{j as e}from"./react.8639cc86.js";import{r,R as s}from"./client.58f92968.js";import{aN as a,M as t,l as i,L as o,n as l,T as n,y as c,N as p,z as d,P as h,Q as x,I as g,S as u,R as m,U as j,V as f,X as _,B as b,s as v}from"./App.7c34790a.js";import{c as N,D as C,a as w,b as q,d as L,e as S,f as z}from"./DataGridHeaderCell.ec45a911.js";import{T as F}from"./TableCellLayout.d4b0b796.js";import"./index.3bd6c859.js";import"./Serializer.f6a5f515.js";import"./axios.65f6a2c9.js";import"./T3Data.63f93fe7.js";import"./_commonjsHelpers.a5007c1f.js";var I="_container_1qzq2_13",y="_bladeContentContainer_1qzq2_37",D="_bladeContentWrapper_1qzq2_53",P="_bladeContent_1qzq2_37",$="_partContent_1qzq2_85",k="_toolbar_1qzq2_103",T="_toolbarContainer_1qzq2_121",A="_toolbarButton_1qzq2_137",G="_toolbarSeparator_1qzq2_223",E="_searchInputWrapper_1qzq2_239",R="_searchIcon_1qzq2_253",H="_searchInput_1qzq2_239",B="_overviewHr_1qzq2_333",O="_dockingBody_1qzq2_349",U="_autoLoadIndicator_1qzq2_365",V="_noData_1qzq2_389",W="_loadingBar_1qzq2_407",M="_headerCellSort_1qzq2_769",Q="_sortIconFaded_1qzq2_795",X="_errorNotice_1qzq2_803",Y="_iconError_1qzq2_823",J="_textError_1qzq2_835",K="_marginLeft8_1qzq2_847",Z="_noPadding_1qzq2_855",ee="_centerText_1qzq2_881",re="_scrollContainer_1qzq2_999";const se=()=>{const{selectedDevice:se,treeData:ae,selectDevice:te,getNextDevice:ie,getFilteredDevices:oe}=i(),le=o((e=>e.setMessage)),[ne,ce]=r.exports.useState([]),[pe,de]=r.exports.useState(!1),[he,xe]=r.exports.useState(null),[ge,ue]=r.exports.useState(!1),[me,je]=r.exports.useState(!1),fe=r.exports.useRef(!1),_e=r.exports.useRef(null),[be,ve]=r.exports.useState(!1),Ne=r.exports.useRef(!1);r.exports.useEffect((()=>{if(!se&&ae.length>0){const e=oe();if(console.log("[GraphicsPage] Auto-select check:",{hasSelectedDevice:!!se,treeDataLength:ae.length,filteredDevicesCount:e.length}),e.length>0){const r=e[0];console.log(`[GraphicsPage] Auto-selecting first device: ${r.nameShowOnTree} (SN: ${r.serialNumber})`),te(r)}}}),[se,ae,te,oe]);const Ce=r.exports.useCallback((async()=>{if(se){de(!0),xe(null);try{const e=await class{static async loadAllFromDB(e){return new a(`${t}/api`).graphics.getAll(e)}static async loadFromDB(e,r){const s=new a(`${t}/api`);return(await s.graphics.getAll(e)).find((e=>e.index===r))}static async loadByIdFromDB(e){const[r,s]=e.split("-"),i=parseInt(r),o=parseInt(s);if(isNaN(i)||isNaN(o))return;const l=new a(`${t}/api`);return await l.graphics.get(i,o)||void 0}static async refreshAllFromDevice(e){throw new Error("GraphicRefreshApi.refreshAllFromDevice not yet implemented - use Action 0/1")}static async refreshSingleFromDevice(e,r){throw new Error("GraphicRefreshApi.refreshSingleFromDevice not yet implemented - use Action 7")}}.loadAllFromDB(se.serialNumber);ce(e||[])}catch(e){const r=e instanceof Error?e.message:"Failed to load graphics";xe(r),console.error("Error fetching graphics:",e)}finally{de(!1)}}else ce([])}),[se]);r.exports.useEffect((()=>{Ce(),je(!1),fe.current=!1}),[Ce]),r.exports.useEffect((()=>{if(pe||!se||me||fe.current)return;(async()=>{if(fe.current=!0,ne.length>0)return console.log("[GraphicsPage] Database has data, skipping auto-refresh"),void je(!0);console.log("[GraphicsPage] Database empty, auto-refreshing from device using Action 17..."),de(!0);try{const e=await m.refreshFromDevice({serialNumber:se.serialNumber,type:"graphic",onLoadingChange:e=>{e&&le(`Loading graphics from ${se.nameShowOnTree} (Action 17)...`,"info")}});le(`âœ“ Synced ${e.itemCount} graphics from ${se.nameShowOnTree}`,"success")}catch(e){console.error("[GraphicsPage] Auto-refresh failed:",e),le(`Failed to sync graphics: ${e instanceof Error?e.message:"Unknown error"}`,"error")}finally{await Ce(),de(!1),je(!0)}})()}),[pe,se,me,Ce,ne.length,le]);const we=r.exports.useCallback((()=>{const e=ie();e&&(ve(!0),te(e),setTimeout((()=>{ve(!1)}),500))}),[ie,te]),qe=r.exports.useCallback((e=>{if(be||pe)return;const r=e.currentTarget;r.scrollHeight-r.scrollTop-r.clientHeight<=1&&ne.length>0?Ne.current=!0:Ne.current=!1}),[be,pe,ne.length]),Le=r.exports.useCallback((e=>{be||pe||0===ne.length||e.deltaY>0&&Ne.current&&(Ne.current=!1,we())}),[be,pe,ne.length,we]);r.exports.useEffect((()=>{se&&_e.current&&_e.current.scrollTo({top:0,behavior:be?"smooth":"auto"})}),[se,be]);const Se=r.exports.useCallback((e=>{if(!se||!e.Graphic_ID)return;const r=`${t}/api/t3_device/devices/${se.serialNumber}/graphics/${e.Graphic_ID}/webview`;console.log("ðŸ–¼ï¸ [GraphicsPage] Opening webview for graphic:",{serialNumber:se.serialNumber,graphicId:e.Graphic_ID,label:e.Label,url:r}),window.open(r,"_blank")}),[se]),[ze,Fe]=r.exports.useState(""),[Ie,ye]=r.exports.useState(null),[De,Pe]=r.exports.useState("ascending"),$e=e=>{Ie===e?Pe("ascending"===De?"descending":"ascending"):(ye(e),Pe("ascending"))},ke=[...ne.filter((e=>{var r,s,a,t;return""===ze||(null==(r=e.graphicLabel)?void 0:r.toLowerCase().includes(ze.toLowerCase()))||(null==(s=e.graphicFullLabel)?void 0:s.toLowerCase().includes(ze.toLowerCase()))||(null==(a=e.graphicId)?void 0:a.toLowerCase().includes(ze.toLowerCase()))||(null==(t=e.graphicPictureFile)?void 0:t.toLowerCase().includes(ze.toLowerCase()))}))].sort(((e,r)=>{if(!Ie)return 0;const s=e[Ie]||"",a=r[Ie]||"";return"ascending"===De?s.toString().localeCompare(a.toString()):a.toString().localeCompare(s.toString())})),Te=s.useMemo((()=>0===ke.length?Array(10).fill(null).map(((e,r)=>({GraphicId:-(r+1),serialNumber:(null==se?void 0:se.serialNumber)||0,graphicId:"",switchNode:"",graphicLabel:"",graphicFullLabel:"",graphicPictureFile:"",graphicTotalPoint:"0"}))):ke),[ke,se]),Ae=e=>!e.graphicId&&0===ke.length,Ge=[N({columnId:"Graphic_ID",renderHeaderCell:()=>e.exports.jsxs("div",{className:M,onClick:()=>$e("graphicId"),children:[e.exports.jsx("span",{children:"Graphic"}),"graphicId"===Ie?"ascending"===De?e.exports.jsx(j,{}):e.exports.jsx(f,{}):e.exports.jsx(_,{className:Q})]}),renderCell:r=>e.exports.jsx(F,{children:!Ae(r)&&(r.graphicId||"")})}),N({columnId:"Full_Label",renderHeaderCell:()=>e.exports.jsxs("div",{className:M,onClick:()=>$e("graphicFullLabel"),children:[e.exports.jsx("span",{children:"Full Label"}),"graphicFullLabel"===Ie?"ascending"===De?e.exports.jsx(j,{}):e.exports.jsx(f,{}):e.exports.jsx(_,{className:Q})]}),renderCell:r=>e.exports.jsx(F,{children:!Ae(r)&&(r.graphicFullLabel||"")})}),N({columnId:"Label",renderHeaderCell:()=>e.exports.jsxs("div",{className:M,onClick:()=>$e("graphicLabel"),children:[e.exports.jsx("span",{children:"Label"}),"graphicLabel"===Ie?"ascending"===De?e.exports.jsx(j,{}):e.exports.jsx(f,{}):e.exports.jsx(_,{className:Q})]}),renderCell:r=>e.exports.jsx(F,{children:!Ae(r)&&(r.graphicLabel||"")})}),N({columnId:"Picture_File",renderHeaderCell:()=>e.exports.jsxs("div",{className:M,onClick:()=>$e("graphicPictureFile"),children:[e.exports.jsx("span",{children:"Picture File"}),"graphicPictureFile"===Ie?"ascending"===De?e.exports.jsx(j,{}):e.exports.jsx(f,{}):e.exports.jsx(_,{className:Q})]}),renderCell:r=>e.exports.jsx(F,{children:!Ae(r)&&(r.graphicPictureFile||"")})}),N({columnId:"Element_Count",renderHeaderCell:()=>e.exports.jsxs("div",{className:M,onClick:()=>$e("graphicTotalPoint"),children:[e.exports.jsx("span",{children:"Element Count"}),"graphicTotalPoint"===Ie?"ascending"===De?e.exports.jsx(j,{}):e.exports.jsx(f,{}):e.exports.jsx(_,{className:Q})]}),renderCell:r=>e.exports.jsx(F,{children:!Ae(r)&&(r.graphicTotalPoint||"0")})}),N({columnId:"actions",renderHeaderCell:()=>e.exports.jsx("span",{children:"Action"}),renderCell:r=>Ae(r)?e.exports.jsx(F,{}):e.exports.jsx(F,{children:e.exports.jsx(b,{size:"small",icon:e.exports.jsx(v,{}),onClick:e=>{e.stopPropagation(),Se(r)},title:"View webview for this graphic",children:"View Webview"})})})];return e.exports.jsx("div",{className:I,children:e.exports.jsx("div",{className:y,children:e.exports.jsx("div",{className:D,children:e.exports.jsx("div",{className:P,children:e.exports.jsxs("div",{className:$,children:[he&&e.exports.jsxs("div",{className:X,children:[e.exports.jsx(l,{className:Y}),e.exports.jsx(n,{className:J,children:he})]}),se&&e.exports.jsxs(e.exports.Fragment,{children:[e.exports.jsx("div",{className:k,children:e.exports.jsxs("div",{className:T,children:[e.exports.jsxs("button",{className:A,onClick:async()=>{if(se){ue(!0);try{console.log("[GraphicsPage] Refreshing graphics from device using Action 17...");const e=await m.refreshFromDevice({serialNumber:se.serialNumber,type:"graphic",onLoadingChange:e=>{e&&le(`Loading graphics from ${se.nameShowOnTree} (Action 17)...`,"info")}});le(`âœ“ Synced ${e.itemCount} graphics from ${se.nameShowOnTree}`,"success"),await Ce()}catch(e){console.error("[GraphicsPage] Refresh failed:",e);const r=e instanceof Error?e.message:"Failed to refresh graphics";xe(r),le(`Failed to sync graphics: ${r}`,"error")}finally{ue(!1)}}},disabled:ge,title:"Refresh all graphics from device",children:[e.exports.jsx(c,{}),e.exports.jsx("span",{children:ge?"Refreshing...":"Refresh from Device"})]}),e.exports.jsxs("button",{className:A,onClick:()=>{if(0===ne.length)return;const e=[["Graphic ID","Label","Full Label","Picture File","Switch Node","Element Count"].join(","),...ne.map((e=>[e.graphicId||"",e.graphicLabel||"",e.graphicFullLabel||"",e.graphicPictureFile||"",e.switchNode||"",e.graphicTotalPoint||""].join(",")))].join("\n"),r=new Blob([e],{type:"text/csv"}),s=URL.createObjectURL(r),a=document.createElement("a");a.href=s,a.download=`graphics_${(null==se?void 0:se.serialNumber)||"export"}.csv`,a.click(),URL.revokeObjectURL(s)},disabled:0===ne.length,title:"Export to CSV",children:[e.exports.jsx(p,{}),e.exports.jsx("span",{children:"Export"})]}),e.exports.jsx("div",{className:G,role:"separator"}),e.exports.jsxs("button",{className:A,onClick:()=>{},title:"Settings","aria-label":"Settings",children:[e.exports.jsx(d,{}),e.exports.jsx("span",{children:"Settings"})]}),e.exports.jsxs("div",{className:E,children:[e.exports.jsx(h,{className:R}),e.exports.jsx("input",{className:H,type:"text",placeholder:"Search graphics...",value:ze,onChange:e=>{Fe(e.target.value)},spellCheck:"false",role:"searchbox","aria-label":"Search graphics"})]}),e.exports.jsx(x,{content:`Showing graphics for ${se.nameShowOnTree} (SN: ${se.serialNumber}). This table displays all configured graphic floor plans and their associated elements.`,relationship:"description",children:e.exports.jsx("button",{className:`${A} ${K}`,title:"Information","aria-label":"Information about this page",children:e.exports.jsx(g,{})})})]})}),e.exports.jsx("div",{className:Z,children:e.exports.jsx("hr",{className:B})})]}),e.exports.jsxs("div",{className:O,children:[pe&&0===ne.length&&e.exports.jsxs("div",{className:W,children:[e.exports.jsx(u,{size:"tiny"}),e.exports.jsx(n,{size:200,weight:"regular",children:"Loading graphics..."})]}),!se&&!pe&&e.exports.jsx("div",{className:V,children:e.exports.jsxs("div",{className:ee,children:[e.exports.jsx(n,{size:400,weight:"semibold",children:"No device selected"}),e.exports.jsx("br",{}),e.exports.jsx(n,{size:200,children:"Please select a device from the tree to view graphics"})]})}),se&&!pe&&e.exports.jsx("div",{ref:_e,className:re,onScroll:qe,onWheel:Le,children:e.exports.jsxs(C,{items:Te,columns:Ge,sortable:!0,getRowId:e=>{var r,s,a;const t=null!=(s=null!=(r=e.GraphicId)?r:e.graphicId)?s:`empty-${Te.indexOf(e)}`;return`${null!=(a=e.serialNumber)?a:"unknown"}-${t}`},children:[e.exports.jsx(w,{children:e.exports.jsx(q,{children:({renderHeaderCell:r})=>e.exports.jsx(L,{children:r()})})}),e.exports.jsx(S,{children:({item:r,rowId:s})=>e.exports.jsx(q,{children:({renderCell:s})=>e.exports.jsx(z,{children:s(r)})},s)})]})}),be&&e.exports.jsxs("div",{className:U,children:[e.exports.jsx(u,{size:"tiny"}),e.exports.jsx(n,{size:200,children:"Loading next device..."})]})]})]})})})})})};export{se as GraphicsPage};

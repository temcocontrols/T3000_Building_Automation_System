var e,s,t=Object.defineProperty;import{j as r}from"./react.2da10d74.js";import{r as a}from"./client.b9d1bbf8.js";import{A as l,w as o,x as i,T as n,y as d,z as x,S as c,C as p,D as h,I as u,F as m,B as y,H as f,J as j,K as b}from"./App.2c62e2d1.js";import{c as g,D as v,a as _,b as C,d as w,e as N,f as I,T as S}from"./DataGridHeaderCell.34491fc4.js";import{I as T}from"./Input.16f797a0.js";import{S as H}from"./Switch.411cd684.js";import"./index.5672de35.js";import"./Serializer.f6a5f515.js";import"./useFocusableGroup.6d334b5b.js";class k{static async refreshAllHolidays(e){const s=await fetch(`${this.baseUrl}/holidays/${e}/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});if(!s.ok){const e=await s.text();throw new Error(`HTTP ${s.status}: ${e||s.statusText}`)}return await s.json()}static async saveRefreshedHolidays(e,s){const t=await fetch(`${this.baseUrl}/holidays/${e}/save-refreshed`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:s})});if(!t.ok){const e=await t.text();throw new Error(`HTTP ${t.status}: ${e||t.statusText}`)}return await t.json()}static async refreshHoliday(e,s){const t=await fetch(`${this.baseUrl}/holidays/${e}/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({index:s})});if(!t.ok){const e=await t.text();throw new Error(`HTTP ${t.status}: ${e||t.statusText}`)}return await t.json()}}s=`${l}/api/t3_device`,((e,s,r)=>{s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[s]=r})(k,"symbol"!=typeof(e="baseUrl")?e+"":e,s);var $="_container_1x24h_13",z="_bladeContentContainer_1x24h_37",L="_bladeContentWrapper_1x24h_53",D="_bladeContent_1x24h_37",E="_partContent_1x24h_85",W="_toolbar_1x24h_103",A="_toolbarContainer_1x24h_121",M="_toolbarButton_1x24h_137",R="_errorMessage_1x24h_205",B="_toolbarSeparator_1x24h_283",F="_searchInputWrapper_1x24h_299",O="_searchIcon_1x24h_313",P="_searchInput_1x24h_299",U="_overviewHr_1x24h_433",V="_dockingBody_1x24h_449",J="_scrollContainer_1x24h_465",K="_autoLoadIndicator_1x24h_481",Z="_noData_1x24h_505",G="_loadingBar_1x24h_523",Y="_refreshIconButton_1x24h_973",q="_rotating_1x24h_1065";const Q=()=>{const{selectedDevice:e,treeData:s,selectDevice:t,getNextDevice:Q,getFilteredDevices:X}=o(),[ee,se]=a.exports.useState([]),[te,re]=a.exports.useState(!1),[ae,le]=a.exports.useState(null),[oe,ie]=a.exports.useState(!1),[ne,de]=a.exports.useState(""),[xe,ce]=a.exports.useState(null),[pe,he]=a.exports.useState(""),[ue,me]=a.exports.useState(!1),[ye,fe]=a.exports.useState(null),[je,be]=a.exports.useState("ascending"),[ge,ve]=a.exports.useState(new Set),[_e,Ce]=a.exports.useState(!1),we=a.exports.useRef(null),[Ne,Ie]=a.exports.useState(!1),Se=a.exports.useRef(!1);a.exports.useEffect((()=>{if(!e){const e=X();e.length>0&&t(e[0])}}),[e,X,t]);const Te=a.exports.useCallback((async()=>{if(e){re(!0),le(null);try{const s=`${l}/api/t3_device/devices/${e.serialNumber}/table/ANNUAL_TABLE`,t=await fetch(s);if(!t.ok)throw new Error(`Failed to fetch holidays: ${t.statusText}`);const r=await t.json();se(r.data||[])}catch(s){const e=s instanceof Error?s.message:"Failed to load holidays";le(e)}finally{re(!1)}}else se([])}),[e]);a.exports.useEffect((()=>{Te()}),[Te]),a.exports.useEffect((()=>{if(te||!e||_e)return;const s=setTimeout((async()=>{try{const s=e.serialNumber,t=await k.refreshAllHolidays(s);t&&t.items&&(await k.saveRefreshedHolidays(s,t.items),await Te()),Ce(!0)}catch(s){}}),500);return()=>clearTimeout(s)}),[te,e,_e,Te]);const He=e=>{ye===e?be("ascending"===je?"descending":"ascending"):(fe(e),be("ascending"))},ke=a.exports.useCallback((()=>{const e=Q();e&&(Ie(!0),t(e),setTimeout((()=>{Ie(!1)}),500))}),[Q,t]),$e=a.exports.useCallback((e=>{if(Ne||te)return;const s=e.currentTarget;s.scrollHeight-s.scrollTop-s.clientHeight<=1&&ee.length>0?Se.current=!0:Se.current=!1}),[Ne,te,ee.length]),ze=a.exports.useCallback((e=>{Ne||te||0===ee.length||e.deltaY>0&&Se.current&&(Se.current=!1,ke())}),[Ne,te,ee.length,ke]);a.exports.useEffect((()=>{e&&we.current&&we.current.scrollTo({top:0,behavior:Ne?"smooth":"auto"})}),[e,Ne]);const Le=(e,s,t)=>{ce({serialNumber:e.serialNumber,holidayId:e.holidayId||"",field:s}),he(t||"")},De=async()=>{if(xe&&pe.trim()){me(!0);try{se((e=>e.map((e=>e.serialNumber===xe.serialNumber&&e.holidayId===xe.holidayId?{...e,[xe.field]:pe}:e)))),ce(null)}catch(e){}finally{me(!1)}}else ce(null)},Ee=e=>{"Enter"===e.key?De():"Escape"===e.key&&ce(null)},We=[g({columnId:"holidayId",renderHeaderCell:()=>r.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>He("holidayId"),children:[r.exports.jsx("span",{children:"NUM"}),"holidayId"===ye?"ascending"===je?r.exports.jsx(f,{}):r.exports.jsx(j,{}):r.exports.jsx(b,{style:{opacity:.5}})]}),renderCell:s=>{const t=s.holidayId&&ge.has(s.holidayId);return r.exports.jsx(S,{children:r.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[r.exports.jsx("button",{className:`${Y} ${t?q:""}`,onClick:t=>{t.stopPropagation(),(async s=>{if(!e||!s.holidayId)return;const t=s.holidayId;ve((e=>new Set(e).add(t)));try{const r=e.serialNumber,a=parseInt(s.holidayId),l=await k.refreshHoliday(r,a);l&&l.items&&(await k.saveRefreshedHolidays(r,l.items),await Te())}catch(r){}finally{ve((e=>{const s=new Set(e);return s.delete(t),s}))}})(s)},disabled:t,title:"Refresh this holiday from device","aria-label":"Refresh holiday",children:r.exports.jsx(d,{fontSize:16})}),r.exports.jsx("span",{children:s.holidayId||"---"})]})})}}),g({columnId:"fullLabel",renderHeaderCell:()=>r.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>He("fullLabel"),children:[r.exports.jsx("span",{children:"Full Label"}),"fullLabel"===ye?"ascending"===je?r.exports.jsx(f,{}):r.exports.jsx(j,{}):r.exports.jsx(b,{style:{opacity:.5}})]}),renderCell:e=>{const s=(null==xe?void 0:xe.serialNumber)===e.serialNumber&&(null==xe?void 0:xe.holidayId)===e.holidayId&&"fullLabel"===(null==xe?void 0:xe.field);return r.exports.jsx(S,{children:s?r.exports.jsx(T,{value:pe,onChange:(e,s)=>he(s.value),onBlur:De,onKeyDown:Ee,autoFocus:!0,disabled:ue,size:"small",style:{width:"100%"}}):r.exports.jsx("div",{onDoubleClick:()=>Le(e,"fullLabel",e.fullLabel||""),style:{cursor:"text",minHeight:"20px"},children:r.exports.jsx(n,{size:200,children:e.fullLabel||"Unnamed"})})})}}),g({columnId:"autoManual",renderHeaderCell:()=>r.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:r.exports.jsx("span",{children:"Auto/Manual"})}),renderCell:e=>{var s;const t="1"===e.autoManual||"auto"===(null==(s=e.autoManual)?void 0:s.toLowerCase());return r.exports.jsx(S,{children:r.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[r.exports.jsx(H,{checked:t,onChange:()=>(async e=>{const s="1"===e.autoManual?"0":"1";se((t=>t.map((t=>t.serialNumber===e.serialNumber&&t.holidayId===e.holidayId?{...t,autoManual:s}:t))))})(e)}),r.exports.jsx(n,{size:200,children:t?"Auto":"Manual"})]})})}}),g({columnId:"value",renderHeaderCell:()=>r.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>He("value"),children:[r.exports.jsx("span",{children:"Value"}),"value"===ye?"ascending"===je?r.exports.jsx(f,{}):r.exports.jsx(j,{}):r.exports.jsx(b,{style:{opacity:.5}})]}),renderCell:e=>r.exports.jsx(S,{children:e.value||"---"})}),g({columnId:"label",renderHeaderCell:()=>r.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>He("label"),children:[r.exports.jsx("span",{children:"Label"}),"label"===ye?"ascending"===je?r.exports.jsx(f,{}):r.exports.jsx(j,{}):r.exports.jsx(b,{style:{opacity:.5}})]}),renderCell:e=>{const s=(null==xe?void 0:xe.serialNumber)===e.serialNumber&&(null==xe?void 0:xe.holidayId)===e.holidayId&&"label"===(null==xe?void 0:xe.field);return r.exports.jsx(S,{children:s?r.exports.jsx(T,{value:pe,onChange:(e,s)=>he(s.value),onBlur:De,onKeyDown:Ee,autoFocus:!0,disabled:ue,size:"small",style:{width:"100%"}}):r.exports.jsx("div",{onDoubleClick:()=>Le(e,"label",e.label||""),style:{cursor:"text",minHeight:"20px"},children:r.exports.jsx(n,{size:200,children:e.label||"---"})})})}})];return r.exports.jsx("div",{className:$,children:r.exports.jsx("div",{className:z,children:r.exports.jsx("div",{className:L,children:r.exports.jsx("div",{className:D,children:r.exports.jsxs("div",{className:E,children:[ae&&r.exports.jsxs("div",{className:R,children:[r.exports.jsx(i,{style:{color:"#d13438",fontSize:"14px",flexShrink:0}}),r.exports.jsx(n,{style:{color:"#d13438",fontWeight:500,fontSize:"12px"},children:ae})]}),e&&r.exports.jsx("div",{className:W,children:r.exports.jsxs("div",{className:A,children:[r.exports.jsxs("button",{className:M,onClick:async()=>{if(e){ie(!0),le(null);try{const s=e.serialNumber,t=await k.refreshAllHolidays(s);t&&t.items&&(await k.saveRefreshedHolidays(s,t.items),await Te())}catch(s){le(s instanceof Error?s.message:"Failed to refresh from device")}finally{ie(!1)}}},disabled:oe,title:"Refresh from Device","aria-label":"Refresh from Device",children:[r.exports.jsx(d,{className:oe?q:""}),r.exports.jsx("span",{children:oe?"Refreshing...":"Refresh from Device"})]}),r.exports.jsxs("button",{className:M,onClick:()=>{},title:"Export to CSV","aria-label":"Export to CSV",children:[r.exports.jsx(x,{}),r.exports.jsx("span",{children:"Export to CSV"})]}),r.exports.jsx("div",{className:B,role:"separator"}),r.exports.jsxs("button",{className:M,onClick:()=>{},title:"Settings","aria-label":"Settings",children:[r.exports.jsx(c,{}),r.exports.jsx("span",{children:"Settings"})]}),r.exports.jsxs("div",{className:F,children:[r.exports.jsx(p,{className:O}),r.exports.jsx("input",{className:P,type:"text",placeholder:"Search holidays...",value:ne,onChange:e=>{de(e.target.value)},spellCheck:"false",role:"searchbox","aria-label":"Search holidays"})]}),r.exports.jsx(h,{content:`Showing holidays for ${e.nameShowOnTree} (SN: ${e.serialNumber}). This table displays all configured annual routine/holiday schedules including labels, auto/manual modes, and values.`,relationship:"description",children:r.exports.jsx("button",{className:M,style:{marginLeft:"8px"},title:"Information","aria-label":"Information about this page",children:r.exports.jsx(u,{})})})]})}),r.exports.jsx("div",{style:{padding:"0"},children:r.exports.jsx("hr",{className:U})}),r.exports.jsxs("div",{className:V,children:[te&&0===ee.length&&r.exports.jsxs("div",{className:G,children:[r.exports.jsx(m,{size:"tiny"}),r.exports.jsx(n,{size:200,weight:"regular",children:"Loading holidays..."})]}),!e&&!te&&r.exports.jsx("div",{className:Z,children:r.exports.jsxs("div",{style:{textAlign:"center"},children:[r.exports.jsx(n,{size:500,weight:"semibold",children:"No device selected"}),r.exports.jsx("br",{}),r.exports.jsx(n,{size:300,children:"Please select a device from the tree to view holidays"})]})}),e&&!te&&r.exports.jsxs("div",{ref:we,className:J,onScroll:$e,onWheel:ze,children:[r.exports.jsxs(v,{items:ee,columns:We,sortable:!0,resizableColumns:!0,columnSizingOptions:{holidayId:{minWidth:60,defaultWidth:80},fullLabel:{minWidth:150,defaultWidth:200},autoManual:{minWidth:100,defaultWidth:120},value:{minWidth:80,defaultWidth:100},label:{minWidth:90,defaultWidth:120}},children:[r.exports.jsx(_,{children:r.exports.jsx(C,{children:({renderHeaderCell:e})=>r.exports.jsx(w,{children:e()})})}),r.exports.jsx(N,{children:({item:e,rowId:s})=>r.exports.jsx(C,{children:({renderCell:s})=>r.exports.jsx(I,{children:s(e)})},s)})]}),0===ee.length&&r.exports.jsxs("div",{style:{marginTop:"24px",textAlign:"center",padding:"0 20px"},children:[r.exports.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",marginBottom:"8px"},children:[r.exports.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",style:{opacity:.5},children:r.exports.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4ZM10 8V16H14V8H10Z",fill:"currentColor"})}),r.exports.jsx(n,{size:400,weight:"semibold",children:"No holidays found"})]}),r.exports.jsx(n,{size:300,style:{display:"block",marginBottom:"16px",color:"#605e5c",textAlign:"center"},children:"This device has no configured holiday points"}),r.exports.jsx(y,{appearance:"subtle",icon:r.exports.jsx(d,{}),onClick:async()=>{ie(!0),await Te(),ie(!1)},style:{minWidth:"120px",fontWeight:"normal"},children:"Refresh"})]}),Ne&&r.exports.jsxs("div",{className:K,children:[r.exports.jsx(m,{size:"tiny"}),r.exports.jsx(n,{children:"Loading next device..."})]})]})]})]})})})})})};export{Q as HolidaysPage};

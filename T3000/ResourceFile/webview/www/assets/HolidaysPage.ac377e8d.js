import{j as e}from"./react.8639cc86.js";import{r as s,R as a}from"./client.58f92968.js";import{l,M as r,n as o,T as t,y as i,N as n,z as d,P as c,Q as x,I as h,S as p,R as u,U as m,V as f,X as j,Z as _}from"./App.7c34790a.js";import{c as b,D as g,a as v,b as y,d as N,e as k,f as C}from"./DataGridHeaderCell.ec45a911.js";import{T as I}from"./TableCellLayout.d4b0b796.js";import{I as S}from"./Input.7691f421.js";import"./index.3bd6c859.js";import"./Serializer.f6a5f515.js";import"./axios.65f6a2c9.js";import"./T3Data.63f93fe7.js";import"./_commonjsHelpers.a5007c1f.js";var w="_container_1ak63_7",D="_bladeContentContainer_1ak63_19",E="_bladeContentWrapper_1ak63_27",L="_bladeContent_1ak63_19",H="_partContent_1ak63_43",z="_toolbar_1ak63_52",W="_toolbarContainer_1ak63_61",R="_toolbarButton_1ak63_69",M="_errorMessage_1ak63_103",T="_toolbarSeparator_1ak63_142",A="_searchInputWrapper_1ak63_150",$="_searchIcon_1ak63_157",F="_searchInput_1ak63_150",B="_overviewHr_1ak63_217",V="_dockingBody_1ak63_225",P="_scrollContainer_1ak63_233",G="_autoLoadIndicator_1ak63_261",O="_noData_1ak63_273",K="_loadingBar_1ak63_282",U="_editableCell_1ak63_423",Y="_refreshIconButton_1ak63_507",Q="_rotating_1ak63_553",X="_headerCellSort_1ak63_558",Z="_headerCellWith8Gap_1ak63_565",q="_flexCenter8Gap_1ak63_571",J="_marginLeft8_1ak63_577",ee="_headerCell_1ak63_558",se="_sortIconFaded_1ak63_587",ae="_iconError_1ak63_616",le="_textError_1ak63_622",re="_noPadding_1ak63_632",oe="_centerText_1ak63_636",te="_fullWidth_1ak63_658";const ie=()=>{const{selectedDevice:ie,selectDevice:ne,getNextDevice:de,getFilteredDevices:ce}=l(),[xe,he]=s.exports.useState([]),[pe,ue]=s.exports.useState(!1),[me,fe]=s.exports.useState(null),[je,_e]=s.exports.useState(!1),[be,ge]=s.exports.useState(""),[ve,ye]=s.exports.useState(null),[Ne,ke]=s.exports.useState(""),[Ce,Ie]=s.exports.useState(!1),[Se,we]=s.exports.useState(null),[De,Ee]=s.exports.useState("ascending"),[Le,He]=s.exports.useState(new Set),[ze,We]=s.exports.useState(!1),Re=s.exports.useRef(!1),Me=s.exports.useRef(null),[Te,Ae]=s.exports.useState(!1),$e=s.exports.useRef(!1);s.exports.useEffect((()=>{if(!ie){const e=ce();e.length>0&&ne(e[0])}}),[ie,ce,ne]);const Fe=s.exports.useCallback((async()=>{if(ie){ue(!0),fe(null);try{const e=`${r}/api/t3_device/devices/${ie.serialNumber}/table/HOLIDAYS`,s=await fetch(e);if(!s.ok)throw new Error(`Failed to fetch holidays: ${s.statusText}`);const a=await s.json();he(a.data||[])}catch(e){const s=e instanceof Error?e.message:"Failed to load holidays";fe(s),console.error("Error fetching holidays:",e)}finally{ue(!1)}}else he([])}),[ie]);s.exports.useEffect((()=>{Fe()}),[Fe]),s.exports.useEffect((()=>{he([]),We(!1),Re.current=!1}),[null==ie?void 0:ie.serialNumber]),s.exports.useEffect((()=>{if(pe||!ie||ze||Re.current)return;(async()=>{if(Re.current=!0,xe.length>0)return console.log("ðŸ”„ Database has data, skipping auto-refresh"),void We(!0);console.log("ðŸ”„ Database empty, auto-refreshing holidays from device on page load...");try{const e=ie.serialNumber,s=await u.refreshAllHolidays(e);console.log("âœ… Auto-refresh result:",s),await Fe(),We(!0)}catch(e){console.error("âŒ Auto-refresh failed:",e)}})()}),[pe,ie,ze,Fe,xe.length]);const Be=e=>{Se===e?Ee("ascending"===De?"descending":"ascending"):(we(e),Ee("ascending"))},Ve=s.exports.useCallback((()=>{const e=de();e&&(Ae(!0),ne(e),setTimeout((()=>{Ae(!1)}),500))}),[de,ne]),Pe=s.exports.useCallback((e=>{if(Te||pe)return;const s=e.currentTarget;s.scrollHeight-s.scrollTop-s.clientHeight<=1&&xe.length>0?$e.current=!0:$e.current=!1}),[Te,pe,xe.length]),Ge=s.exports.useCallback((e=>{Te||pe||0===xe.length||e.deltaY>0&&$e.current&&($e.current=!1,Ve())}),[Te,pe,xe.length,Ve]);s.exports.useEffect((()=>{ie&&Me.current&&Me.current.scrollTo({top:0,behavior:Te?"smooth":"auto"})}),[ie,Te]);const Oe=a.useMemo((()=>0===xe.length?Array(10).fill(null).map(((e,s)=>({serialNumber:0,holidayId:"",fullLabel:"",autoManual:"",value:"",label:""}))):xe),[xe]),Ke=e=>!e.holidayId&&0===xe.length,Ue=(e,s,a)=>{ye({serialNumber:e.serialNumber,holidayId:e.holidayId||"",field:s}),ke(a||"")},Ye=async()=>{if(ve&&Ne.trim()){Ie(!0);try{console.log("Saving:",ve,Ne),he((e=>e.map((e=>e.serialNumber===ve.serialNumber&&e.holidayId===ve.holidayId?{...e,[ve.field]:Ne}:e)))),ye(null)}catch(e){console.error("Error saving:",e)}finally{Ie(!1)}}else ye(null)},Qe=e=>{"Enter"===e.key?Ye():"Escape"===e.key&&ye(null)},Xe=[b({columnId:"holidayId",renderHeaderCell:()=>e.exports.jsxs("div",{className:X,onClick:()=>Be("holidayId"),children:[e.exports.jsx("span",{children:"Holiday"}),"holidayId"===Se?"ascending"===De?e.exports.jsx(m,{}):e.exports.jsx(f,{}):e.exports.jsx(j,{className:se})]}),renderCell:s=>{const a=s.holidayId&&Le.has(s.holidayId);return e.exports.jsx(I,{children:!Ke(s)&&e.exports.jsxs("div",{className:q,children:[e.exports.jsx("button",{className:`${Y} ${a?Q:""}`,onClick:e=>{e.stopPropagation(),(async e=>{if(!ie||!e.holidayId)return;const s=e.holidayId;He((e=>new Set(e).add(s)));try{const a=ie.serialNumber,l=parseInt(e.holidayId);console.log(`ðŸ”„ Refreshing single holiday from device: ${l}`);const r=await u.refreshSingleHoliday(a,l);console.log("âœ… Single holiday refresh result:",r),await Fe()}catch(a){console.error("âŒ Single holiday refresh failed:",a)}finally{He((e=>{const a=new Set(e);return a.delete(s),a}))}})(s)},disabled:!!a,title:"Refresh this holiday from device","aria-label":"Refresh holiday",children:e.exports.jsx(i,{fontSize:16})}),e.exports.jsx("span",{children:s.holidayId||"---"})]})})}}),b({columnId:"fullLabel",renderHeaderCell:()=>e.exports.jsxs("div",{className:X,onClick:()=>Be("fullLabel"),children:[e.exports.jsx("span",{children:"Full Label"}),"fullLabel"===Se?"ascending"===De?e.exports.jsx(m,{}):e.exports.jsx(f,{}):e.exports.jsx(j,{className:se})]}),renderCell:s=>{const a=(null==ve?void 0:ve.serialNumber)===s.serialNumber&&(null==ve?void 0:ve.holidayId)===s.holidayId&&"fullLabel"===(null==ve?void 0:ve.field);return e.exports.jsx(I,{children:!Ke(s)&&(a?e.exports.jsx(S,{value:Ne,onChange:(e,s)=>ke(s.value),onBlur:Ye,onKeyDown:Qe,autoFocus:!0,disabled:Ce,size:"small",className:te}):e.exports.jsx("div",{onDoubleClick:()=>Ue(s,"fullLabel",s.fullLabel||""),className:U,children:e.exports.jsx(t,{size:200,children:s.fullLabel||"Unnamed"})}))})}}),b({columnId:"autoManual",renderHeaderCell:()=>e.exports.jsx("div",{className:ee,children:e.exports.jsx("span",{children:"Auto/Man"})}),renderCell:s=>{var a;const l="1"===s.autoManual||"auto"===(null==(a=s.autoManual)?void 0:a.toLowerCase());return e.exports.jsx(I,{children:!Ke(s)&&e.exports.jsxs("div",{className:Z,children:[e.exports.jsx(_,{checked:l,onChange:()=>(async e=>{const s="1"===e.autoManual?"0":"1";he((a=>a.map((a=>a.serialNumber===e.serialNumber&&a.holidayId===e.holidayId?{...a,autoManual:s}:a)))),console.log("Toggle Auto/Manual:",e.holidayId,s)})(s)}),e.exports.jsx(t,{size:200,children:l?"Auto":"Manual"})]})})}}),b({columnId:"value",renderHeaderCell:()=>e.exports.jsxs("div",{className:X,onClick:()=>Be("value"),children:[e.exports.jsx("span",{children:"Value"}),"value"===Se?"ascending"===De?e.exports.jsx(m,{}):e.exports.jsx(f,{}):e.exports.jsx(j,{className:se})]}),renderCell:s=>e.exports.jsx(I,{children:!Ke(s)&&(s.value||"---")})}),b({columnId:"label",renderHeaderCell:()=>e.exports.jsxs("div",{className:X,onClick:()=>Be("label"),children:[e.exports.jsx("span",{children:"Label"}),"label"===Se?"ascending"===De?e.exports.jsx(m,{}):e.exports.jsx(f,{}):e.exports.jsx(j,{className:se})]}),renderCell:s=>{const a=(null==ve?void 0:ve.serialNumber)===s.serialNumber&&(null==ve?void 0:ve.holidayId)===s.holidayId&&"label"===(null==ve?void 0:ve.field);return e.exports.jsx(I,{children:!Ke(s)&&(a?e.exports.jsx(S,{value:Ne,onChange:(e,s)=>ke(s.value),onBlur:Ye,onKeyDown:Qe,autoFocus:!0,disabled:Ce,size:"small",className:te}):e.exports.jsx("div",{onDoubleClick:()=>Ue(s,"label",s.label||""),className:U,children:e.exports.jsx(t,{size:200,children:s.label||"---"})}))})}})];return e.exports.jsx("div",{className:w,children:e.exports.jsx("div",{className:D,children:e.exports.jsx("div",{className:E,children:e.exports.jsx("div",{className:L,children:e.exports.jsxs("div",{className:H,children:[me&&e.exports.jsxs("div",{className:M,children:[e.exports.jsx(o,{className:ae}),e.exports.jsx(t,{className:le,children:me})]}),ie&&e.exports.jsxs(e.exports.Fragment,{children:[e.exports.jsx("div",{className:z,children:e.exports.jsxs("div",{className:W,children:[e.exports.jsxs("button",{className:R,onClick:async()=>{if(ie){_e(!0),fe(null);try{const e=ie.serialNumber;console.log("ðŸ”„ Refreshing all holidays from device...");const s=await u.refreshAllHolidays(e);console.log("âœ… Device refresh result:",s),await Fe()}catch(e){console.error("âŒ Refresh from device failed:",e),fe(e instanceof Error?e.message:"Failed to refresh from device")}finally{_e(!1)}}},disabled:je,title:"Refresh from Device","aria-label":"Refresh from Device",children:[e.exports.jsx(i,{className:je?Q:""}),e.exports.jsx("span",{children:je?"Refreshing...":"Refresh from Device"})]}),e.exports.jsxs("button",{className:R,onClick:()=>{console.log("Export holidays to CSV")},title:"Export to CSV","aria-label":"Export to CSV",children:[e.exports.jsx(n,{}),e.exports.jsx("span",{children:"Export to CSV"})]}),e.exports.jsx("div",{className:T,role:"separator"}),e.exports.jsxs("button",{className:R,onClick:()=>{console.log("Settings clicked")},title:"Settings","aria-label":"Settings",children:[e.exports.jsx(d,{}),e.exports.jsx("span",{children:"Settings"})]}),e.exports.jsxs("div",{className:A,children:[e.exports.jsx(c,{className:$}),e.exports.jsx("input",{className:F,type:"text",placeholder:"Search holidays...",value:be,onChange:e=>{ge(e.target.value)},spellCheck:"false",role:"searchbox","aria-label":"Search holidays"})]}),e.exports.jsx(x,{content:`Showing holidays for ${ie.nameShowOnTree} (SN: ${ie.serialNumber}). This table displays all configured annual routine/holiday schedules including labels, auto/manual modes, and values.`,relationship:"description",children:e.exports.jsx("button",{className:`${R} ${J}`,title:"Information","aria-label":"Information about this page",children:e.exports.jsx(h,{})})})]})}),e.exports.jsx("div",{className:re,children:e.exports.jsx("hr",{className:B})})]}),e.exports.jsxs("div",{className:V,children:[pe&&0===xe.length&&e.exports.jsxs("div",{className:K,children:[e.exports.jsx(p,{size:"tiny"}),e.exports.jsx(t,{size:200,weight:"regular",children:"Loading holidays..."})]}),!ie&&!pe&&e.exports.jsx("div",{className:O,children:e.exports.jsxs("div",{className:oe,children:[e.exports.jsx(t,{size:400,weight:"semibold",children:"No device selected"}),e.exports.jsx("br",{}),e.exports.jsx(t,{size:200,children:"Please select a device from the tree to view holidays"})]})}),ie&&!pe&&e.exports.jsxs("div",{ref:Me,className:P,onScroll:Pe,onWheel:Ge,children:[e.exports.jsxs(g,{items:Oe,columns:Xe,sortable:!0,resizableColumns:!0,columnSizingOptions:{holidayId:{minWidth:60,idealWidth:100},fullLabel:{minWidth:150,idealWidth:200},autoManual:{minWidth:100,idealWidth:130},value:{minWidth:80,idealWidth:100},label:{minWidth:90,idealWidth:130}},children:[e.exports.jsx(v,{children:e.exports.jsx(y,{children:({renderHeaderCell:s})=>e.exports.jsx(N,{children:s()})})}),e.exports.jsx(k,{children:({item:s,rowId:a})=>e.exports.jsx(y,{children:({renderCell:a})=>e.exports.jsx(C,{children:a(s)})},a)})]}),Te&&e.exports.jsxs("div",{className:G,children:[e.exports.jsx(p,{size:"tiny"}),e.exports.jsx(t,{children:"Loading next device..."})]})]})]})]})})})})})};export{ie as HolidaysPage};

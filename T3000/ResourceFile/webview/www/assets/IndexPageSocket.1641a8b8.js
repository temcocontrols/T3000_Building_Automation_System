import{d as e,a7 as a,h as t,a as l,w as n,o as i,a1 as r,a2 as s,a3 as o,a4 as d,c as u,u as c,X as p}from"./index.1af70167.js";import{u as v}from"./use-quasar.76055695.js";import{u as g,T as m,t as _}from"./TrendLogChart.07f3ebd0.js";import{s as y}from"./RefConstant.1fa2cf9e.js";import{h as f}from"./T3Data.a3c00959.js";import{f3 as b}from"./Hvac.003d6c4c.js";import{_ as h}from"./plugin-vue_export-helper.21dcd24c.js";import"./QChip.ec34d7aa.js";import"./dayjs.min.a4094c4f.js";import"./_commonjsHelpers.a5007c1f.js";import"./auto.4ae97206.js";import"./chartjs-adapter-date-fns.esm.6cd07d05.js";import"./index.9b5882c1.js";import"./AntdIcon.ab7b234d.js";import"./index.93e747d4.js";import"./ReloadOutlined.bd3c0da2.js";import"./CheckOutlined.7c52724b.js";import"./common.c9804b89.js";import"./api.5a19c015.js";import"./index.d11c4764.js";import"./QTooltip.571d9411.js";const j={class:"trend-log-page"},D={key:0,class:"loading-wrapper"},$={key:1,class:"error-wrapper"},T={class:"error-content"},S={key:2,class:"chart-wrapper"},L={class:"data-source-indicator"},N={key:0,class:"source-badge realtime"},P={key:1,class:"source-badge historical"},C={key:2,class:"source-badge fallback"},O={key:3,class:"no-data-wrapper"};var w=h(e({name:"TrendLogIndexPage",__name:"IndexPageSocket",setup(e){const h=a(),w=v(),k=g(),A=t("T3000 Trend Log Analysis"),R=t(!1),x=t(null),q=t(null),E=t(null),M=t("json"),I=l((()=>({sn:h.query.sn?Number(h.query.sn):null,panel_id:h.query.panel_id?Number(h.query.panel_id):null,trendlog_id:h.query.trendlog_id?Number(h.query.trendlog_id):null,all_data:h.query.all_data||null})));l((()=>{const e=I.value;return null!==e.sn&&null!==e.panel_id&&null!==e.trendlog_id}));const W=l((()=>y.value&&"object"==typeof y.value&&Object.keys(y.value).length>0));l((()=>{const{all_data:e}=I.value;return!!e&&(e.startsWith("{")||e.includes("%7B"))}));const F=e=>{try{E.value="pending";const a=decodeURIComponent(e);if(a.includes('"error":"JSON conversion failed"')||'{"error":"JSON conversion failed"}'===a)return E.value="error",null;const t=JSON.parse(a);if(t.error&&t.error.includes("JSON conversion failed"))return E.value="error",null;const l=H(t);return E.value=l?"valid":"invalid",t}catch(a){return E.value="invalid",null}},H=e=>!(!e||"object"!=typeof e)&&(!!(e.command&&e.id&&Array.isArray(e.input)&&Array.isArray(e.range))||!!(e.t3Entry&&"object"==typeof e.t3Entry&&Array.isArray(e.t3Entry.input)&&Array.isArray(e.t3Entry.range))),Q=async()=>{var e,a,t;try{R.value=!0,x.value=null;const l=(()=>{const e=I.value,a=null!==e.sn&&null!==e.panel_id&&null!==e.trendlog_id;return{sn:e.sn,panel_id:e.panel_id,trendlog_id:e.trendlog_id,all_data:e.all_data,isValid:a}})();if(l.all_data){M.value="json";const e=(()=>{const{sn:e,panel_id:a,trendlog_id:t,all_data:l}=I.value;p.Debug("üìä IndexPageSocket - Original Query Parameters:",h.query);const n={sn:h.query.sn,panel_id:h.query.panel_id,trendlog_id:h.query.trendlog_id,all_data_decoded:l?(()=>{try{return F(l)}catch(e){return{error:"Failed to decode",raw_preview:l.substring(0,200)+"..."}}})():null,...Object.fromEntries(Object.entries(h.query).filter((([e])=>!["sn","panel_id","trendlog_id","all_data"].includes(e))))};if(p.Debug("üìä IndexPageSocket - Readable Query Object:",n),null===e||null===a||null===t)return p.Debug("‚ùå IndexPageSocket: Missing required parameters for trend log data"),null;let i=null;if(l){const e=F(l);e&&"valid"===E.value&&(i=e.t3Entry||e)}i||(i={an_inputs:12,command:`${a}MON${t}`,hour_interval_time:0,id:`MON${t}`,index:0,input:[],label:`TRL${e}_${a}_${t}`,minute_interval_time:0,num_inputs:14,pid:a,range:[],second_interval_time:15,status:1,type:"MON"}),i.pid=a,i.label=i.label||`TRL${e}_${a}_${t}`,i.command=i.command||`${a}MON${t}`,i.id=i.id||`MON${t}`;const r={title:i.label||"T3000 Trend Log Analysis",t3Entry:i};return{chartData:r,scheduleData:{active:!1,cat:"TrendLog",height:60,id:t,rotate:0,scaleX:1,scaleY:1,settings:{active:!1,bgColor:"inherit",fillColor:"#659dc5",fontSize:16,inAlarm:!1,t3EntryDisplayField:"label",textColor:"inherit",titleColor:"inherit"},showDimensions:!0,t3Entry:i,title:r.title,translate:[583,68],type:"Monitor",width:60,zindex:1}}})();if(e)return q.value=e.chartData,y.value=e.scheduleData,void(A.value=e.chartData.title)}if(l.isValid&&l.sn&&null!==l.panel_id&&null!==l.trendlog_id){M.value="api";const n=new Date,i=new Date(n.getTime()-36e5),r=e=>`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}:${e.getSeconds().toString().padStart(2,"0")}`,s={serial_number:l.sn,panel_id:l.panel_id,trendlog_id:l.trendlog_id.toString(),start_time:r(i),end_time:r(n),limit:1e3,point_types:["INPUT","OUTPUT","VARIABLE"]},o=await k.getTrendlogHistory(s);if((null==(e=null==o?void 0:o.data)?void 0:e.length)>0){const e={id:o.trendlog_id,label:`TRL${l.sn}_${l.panel_id}_${l.trendlog_id}`,description:`Historical Trend Log ${l.trendlog_id} from Panel ${l.panel_id}`,pid:l.panel_id,type:"MON",value:(null==(a=o.data[0])?void 0:a.value)||0,unit:(null==(t=o.data[0])?void 0:t.units)||"",status:1,input:[],range:[],num_inputs:o.count,an_inputs:o.data.filter((e=>e.is_analog)).length,scheduleData:o.data.map(((e,a)=>({time:e.time,value:e.value,index:a,units:e.units,point_type:e.point_type})))};return q.value=e,y.value=e,void(A.value=`Historical Trend Log ${l.trendlog_id} - Device ${l.sn}`)}}M.value="fallback",q.value=null,y.value=null,A.value="T3000 Trend Log Analysis",k.error.value?x.value=`Failed to load historical data: ${k.error.value}`:l.isValid?x.value="No trend log data available":x.value="Missing required parameters: sn, panel_id, and trendlog_id"}catch(l){x.value=l instanceof Error?l.message:"Failed to load trend log data",q.value=null,y.value=null,M.value="fallback"}finally{R.value=!1}};n((()=>h.query),(()=>{Q()}),{immediate:!1}),n((()=>y.value),((e,a)=>{}),{immediate:!0,deep:!0});const J=(e,a)=>{n((()=>f.value.panelsData),(async(t,l)=>{if(t&&0!==t.length)try{const n=t.find((e=>e.pid===a));if(!n)return;const i=null==l?void 0:l.find((e=>e.pid===a));if(i&&JSON.stringify(n)===JSON.stringify(i))return;const r=[];if(n.input&&Array.isArray(n.input)&&n.input.forEach(((t,l)=>{var n,i;t&&"object"==typeof t&&void 0!==t.value&&r.push({serial_number:e,panel_id:a,point_id:t.id||`IN${l+1}`,point_index:l+1,point_type:"INPUT",value:t.value.toString(),range_field:null==(n=t.range)?void 0:n.toString(),digital_analog:null==(i=t.digital_analog)?void 0:i.toString(),units:t.units})})),r.length>0){await k.saveRealtimeBatch(r)}}catch(n){}}),{deep:!0})};return i((()=>{try{b.IdxPage.initQuasar(w)}catch(e){}(async()=>{var a;const{sn:t,panel_id:l,trendlog_id:n}=I.value;if(t&&null!==l&&null!==n)try{f.value.panelsData||(f.value.panelsData=[]),f.value.panelsList||(f.value.panelsList=[]),f.value.panelsRanges||(f.value.panelsRanges=[]),f.value.panelsList.find((e=>e.panel_number===l))||f.value.panelsList.push({panel_number:l,serial_number:t,panel_name:`Panel ${l}`,online:!0});let i=!1;if(b.WebClient&&(null==(a=window.chrome)?void 0:a.webview))try{b.WebClient.initMessageHandler(),b.WebClient.initQuasar(w),f.value.loadingPanel=l,b.WebClient.GetPanelsList(),setTimeout((()=>b.WebClient.GetPanelData(l)),500),await _.waitForDataReady({timeout:15e3,specificEntries:[`MON${n}`,`TRL${n}`]}),i=!0}catch(e){f.value.loadingPanel=null}if(!i&&b.WsClient)try{b.WsClient.initQuasar(w),f.value.loadingPanel=l,b.WsClient.connect(),setTimeout((()=>{b.WsClient.GetPanelsList(),setTimeout((()=>b.WsClient.GetPanelData(l)),1e3)}),1e3),await _.waitForDataReady({timeout:2e4,specificEntries:[`MON${n}`,`TRL${n}`]}),i=!0}catch(e){f.value.loadingPanel=null}i||(f.value.loadingPanel=null),J(t,l)}catch(e){f.value.loadingPanel=null}})(),Q()})),(e,a)=>(r(),s("div",j,[R.value?(r(),s("div",D,[...a[0]||(a[0]=[o("div",{class:"loading-content"},[o("div",{class:"loading-spinner"}),o("p",null,"Loading trend log data...")],-1)])])):x.value?(r(),s("div",$,[o("div",T,[a[1]||(a[1]=o("h3",null,"Error Loading Data",-1)),o("p",null,d(x.value),1),o("button",{onClick:Q,class:"retry-button"},"Retry")])])):W.value?(r(),s("div",S,[o("div",L,["json"===M.value?(r(),s("span",N," üì° Real-time Data (From C++ Backend) ")):"api"===M.value?(r(),s("span",P," üìö Historical Data (From Database) ")):(r(),s("span",C," ‚ö†Ô∏è No Data Available "))]),u(m,{itemData:c(y),title:A.value},null,8,["itemData","title"])])):(r(),s("div",O,[o("div",{class:"no-data-content"},[a[2]||(a[2]=o("h3",null,"No Data Available",-1)),a[3]||(a[3]=o("p",null,"Please provide valid URL parameters to display trend log data.",-1)),o("button",{onClick:Q,class:"retry-button"},"Load Data")])]))]))}}),[["__scopeId","data-v-0bfaf5e6"]]);export{w as default};

import{d as e,a,a3 as l,h as n,w as t,o as r,Y as i,Z as s,a4 as o,u as d,$ as u,c,aF as p}from"./index.5672de35.js";import{u as v}from"./use-quasar.d6dfc755.js";import{u as m,T as g,t as y}from"./TrendLogChart.ce44c106.js";import{s as _}from"./RefConstant.8c31ae22.js";import{h as f}from"./T3Data.a6d12426.js";import{H as b}from"./Hvac.5d37c425.js";import{_ as h}from"./plugin-vue_export-helper.21dcd24c.js";import{A as j}from"./index.ae482d3e.js";import"./QChip.1450761f.js";import"./dayjs.min.a4094c4f.js";import"./_commonjsHelpers.a5007c1f.js";import"./index.b16c0530.js";import"./AntdIcon.d0fe262c.js";import"./index.5d3901dc.js";import"./Serializer.f6a5f515.js";import"./ReloadOutlined.ad13f081.js";import"./CheckOutlined.51ed897b.js";import"./common.64a83c64.js";import"./api.feb37077.js";import"./index.d11c4764.js";import"./QTooltip.3ba65709.js";import"./position-engine.14c13ebf.js";import"./install.c537bbc3.js";const D={class:"trend-log-page"},P={key:2,class:"loading-wrapper"},C={key:3,class:"chart-wrapper"},L={key:4,class:"no-data-wrapper"},T="Error: Panel ID is 0. Please launch this page from T3000 with a valid panel.";var w=h(e({name:"TrendLogIndexPage",__name:"IndexPageSocket",setup(e,{expose:h}){const w=a((()=>{const e=x.query.panel_id;return void 0!==e&&0===Number(e)}));h({panelIdError:w,panelIdErrorMsg:T});const x=l(),E=v();m();const q=n("T3000 Trend Log Analysis"),A=n(!1),O=n(null),k=n(null),I=n(null),N=a((()=>({sn:x.query.sn?Number(x.query.sn):null,panel_id:x.query.panel_id?Number(x.query.panel_id):null,trendlog_id:x.query.trendlog_id?Number(x.query.trendlog_id):null,all_data:x.query.all_data||null}))),R=a((()=>{const e=N.value;return null!==e.sn&&null!==e.panel_id&&null!==e.trendlog_id})),$=a((()=>_.value&&"object"==typeof _.value&&Object.keys(_.value).length>0));a((()=>{const{all_data:e}=N.value;return!!e&&(e.startsWith("{")||e.includes("%7B"))}));const W=e=>{try{I.value="pending";const a=decodeURIComponent(e);if(a.includes('"error":"JSON conversion failed"')||'{"error":"JSON conversion failed"}'===a)return I.value="error",null;const l=JSON.parse(a);if(l.error&&l.error.includes("JSON conversion failed"))return I.value="error",null;const n=S(l);return I.value=n?"valid":"invalid",l}catch(a){return I.value="invalid",null}},S=e=>!(!e||"object"!=typeof e)&&(!!(e.command&&e.id&&Array.isArray(e.input)&&Array.isArray(e.range))||!!(e.t3Entry&&"object"==typeof e.t3Entry&&Array.isArray(e.t3Entry.input)&&Array.isArray(e.t3Entry.range))),M=async()=>{try{A.value=!0,O.value=null;if((()=>{const e=N.value,a=null!==e.sn&&null!==e.panel_id&&null!==e.trendlog_id;return{sn:e.sn,panel_id:e.panel_id,trendlog_id:e.trendlog_id,all_data:e.all_data,isValid:a}})().all_data){const e=(()=>{const{sn:e,panel_id:a,trendlog_id:l,all_data:n}=N.value;p.Debug("ðŸ“Š IndexPageSocket - Original Query Parameters:",x.query);const t={sn:x.query.sn,panel_id:x.query.panel_id,trendlog_id:x.query.trendlog_id,all_data_decoded:n?(()=>{try{return W(n)}catch(e){return{error:"Failed to decode",raw_preview:n.substring(0,200)+"..."}}})():null,...Object.fromEntries(Object.entries(x.query).filter((([e])=>!["sn","panel_id","trendlog_id","all_data"].includes(e))))};if(p.Debug("ðŸ“Š IndexPageSocket - Readable Query Object:",t),null===e||null===a||null===l)return p.Debug("ï¿½?IndexPageSocket: Missing required parameters for trend log data"),null;let r=null;if(n){const e=W(n);e&&"valid"===I.value&&(r=e.t3Entry||e)}if(!r)return null;r.pid=a,r.label=r.label||`TRL${e}_${a}_${l}`,r.command=r.command||`${a}MON${l}`,r.id=r.id||`MON${l}`;const i={title:r.label||"T3000 Trend Log Analysis",t3Entry:r};return{chartData:i,scheduleData:{active:!1,cat:"TrendLog",height:60,id:l,rotate:0,scaleX:1,scaleY:1,settings:{active:!1,bgColor:"inherit",fillColor:"#659dc5",fontSize:16,inAlarm:!1,t3EntryDisplayField:"label",textColor:"inherit",titleColor:"inherit"},showDimensions:!0,t3Entry:r,title:i.title,translate:[583,68],type:"Monitor",width:60,zindex:1}}})();return e?(k.value=e.chartData,_.value=e.scheduleData,void(q.value=e.chartData.title)):(O.value="Error: The trend log data in the URL parameter (all_data) is missing or invalid. Please check the data source or try again.",k.value=null,void(_.value=null))}return k.value=null,_.value=null,q.value="T3000 Trend Log Analysis",void(O.value="Missing required parameters: sn, panel_id, trendlog_id, or all_data.")}catch(e){O.value=e instanceof Error?e.message:"Failed to load trend log data",k.value=null,_.value=null}finally{A.value=!1}};t((()=>x.query),(()=>{M()}),{immediate:!1}),t((()=>_.value),((e,a)=>{}),{immediate:!0,deep:!0});return r((()=>{try{b.IdxPage.initQuasar(E)}catch(e){}(async()=>{var a;const{sn:l,panel_id:n,trendlog_id:t}=N.value;if(l&&null!==n&&null!==t)try{f.value.panelsData||(f.value.panelsData=[]),f.value.panelsList||(f.value.panelsList=[]),f.value.panelsRanges||(f.value.panelsRanges=[]),f.value.panelsList.find((e=>e.panel_number===n))||f.value.panelsList.push({panel_number:n,serial_number:l,panel_name:`Panel ${n}`,online:!0});let r=!1;if(b.WebClient&&(null==(a=window.chrome)?void 0:a.webview))try{b.WebClient.initMessageHandler(),b.WebClient.initQuasar(E),f.value.loadingPanel=n,b.WebClient.GetPanelsList(),setTimeout((()=>b.WebClient.GetPanelData(n)),500),await y.waitForDataReady({timeout:15e3,specificEntries:[`MON${t}`,`TRL${t}`]}),r=!0}catch(e){f.value.loadingPanel=null}if(!r&&b.WsClient)try{b.WsClient.initQuasar(E),f.value.loadingPanel=n,b.WsClient.connect(),setTimeout((()=>{b.WsClient.GetPanelsList(),setTimeout((()=>b.WsClient.GetPanelData(n)),1e3)}),1e3),await y.waitForDataReady({timeout:2e4,specificEntries:[`MON${t}`,`TRL${t}`]}),r=!0}catch(e){f.value.loadingPanel=null}r||(f.value.loadingPanel=null)}catch(e){f.value.loadingPanel=null}})(),M()})),(e,a)=>(i(),s("div",D,[w.value?(i(),o(d(j),{key:0,type:"info","show-icon":"",message:"Panel ID Error",description:T,style:{margin:"32px 0"}})):O.value?(i(),o(d(j),{key:1,type:"info","show-icon":"",message:"Error Loading Data",description:O.value,style:{margin:"32px 0"}},null,8,["description"])):A.value&&R.value?(i(),s("div",P,[...a[0]||(a[0]=[u("div",{class:"loading-content"},[u("div",{class:"loading-spinner"}),u("p",null,"Loading trend log data...")],-1)])])):$.value?(i(),s("div",C,[c(g,{itemData:d(_),title:q.value},null,8,["itemData","title"])])):(i(),s("div",L,[u("div",{class:"no-data-content"},[a[1]||(a[1]=u("h3",null,"No Data Available",-1)),a[2]||(a[2]=u("p",null,"Please provide valid URL parameters to display trend log data.",-1)),u("button",{onClick:M,class:"retry-button"},"Load Data")])]))]))}}),[["__scopeId","data-v-b279c99a"]]);export{w as default};

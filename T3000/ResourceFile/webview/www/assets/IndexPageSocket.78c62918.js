import{d as e,a,a3 as l,h as t,w as n,o as r,Y as i,Z as s,a4 as o,u as d,$ as u,c,aF as p}from"./index.f111124c.js";import{u as m}from"./use-quasar.b1db0508.js";import{u as v,T as g,t as y}from"./TrendLogChart.9a15b416.js";import{s as f}from"./RefConstant.15b74e0c.js";import{h as _}from"./T3Data.f6c34e59.js";import{H as b}from"./Hvac.4f1a0343.js";import{_ as h}from"./plugin-vue_export-helper.21dcd24c.js";import{A as j}from"./index.04755238.js";import"./QChip.ac375dfb.js";import"./dayjs.min.a4094c4f.js";import"./_commonjsHelpers.a5007c1f.js";import"./axios.65f6a2c9.js";import"./MessageType.d5dca80f.js";import"./RightOutlined.6457b50d.js";import"./AntdIcon.c1a79940.js";import"./ReloadOutlined.c2ace596.js";import"./CheckOutlined.f8385047.js";import"./index.0c5411a6.js";import"./Serializer.f6a5f515.js";import"./common.f9b47c12.js";import"./index.cec6b9d9.js";import"./IdxUtils.5af93195.js";import"./api.eb2d8efb.js";import"./index.d11c4764.js";import"./index.977d0f15.js";import"./_getTag.58539d11.js";import"./QTooltip.e3d05d48.js";import"./position-engine.bc5dfdf8.js";import"./install.00f124f0.js";const D={class:"trend-log-page"},P={key:2,class:"loading-wrapper"},T={key:3,class:"chart-wrapper"},x={key:4,class:"no-data-wrapper"},C="Error: Panel ID is 0. Please launch this page from T3000 with a valid panel.";var L=h(e({name:"TrendLogIndexPage",__name:"IndexPageSocket",setup(e,{expose:h}){const L=a((()=>{const e=w.query.panel_id;return void 0!==e&&0===Number(e)}));h({panelIdError:L,panelIdErrorMsg:C});const w=l(),E=m();v();const q=t("T3000 Trend Log Analysis"),O=t(!1),A=t(null),I=t(null),R=t(null),k=a((()=>({sn:w.query.sn?Number(w.query.sn):null,panel_id:w.query.panel_id?Number(w.query.panel_id):null,trendlog_id:w.query.trendlog_id?Number(w.query.trendlog_id):null,all_data:w.query.all_data||null}))),N=a((()=>{const e=k.value;return null!==e.sn&&null!==e.panel_id&&null!==e.trendlog_id})),$=a((()=>f.value&&"object"==typeof f.value&&Object.keys(f.value).length>0));a((()=>{const{all_data:e}=k.value;return!!e&&(e.startsWith("{")||e.includes("%7B"))}));const W=e=>{try{R.value="pending";const a=decodeURIComponent(e);if(a.includes('"error":"JSON conversion failed"')||'{"error":"JSON conversion failed"}'===a)return R.value="error",null;const l=JSON.parse(a);if(l.error&&l.error.includes("JSON conversion failed"))return R.value="error",null;const t=M(l);return R.value=t?"valid":"invalid",l}catch(a){return R.value="invalid",null}},M=e=>!(!e||"object"!=typeof e)&&(!!(e.command&&e.id&&Array.isArray(e.input)&&Array.isArray(e.range))||!!(e.t3Entry&&"object"==typeof e.t3Entry&&Array.isArray(e.t3Entry.input)&&Array.isArray(e.t3Entry.range))),S=async()=>{try{O.value=!0,A.value=null;if((()=>{const e=k.value,a=null!==e.sn&&null!==e.panel_id&&null!==e.trendlog_id;return{sn:e.sn,panel_id:e.panel_id,trendlog_id:e.trendlog_id,all_data:e.all_data,isValid:a}})().all_data){const e=(()=>{const{sn:e,panel_id:a,trendlog_id:l,all_data:t}=k.value;p.Debug("ðŸ“Š IndexPageSocket - Original Query Parameters:",w.query);const n={sn:w.query.sn,panel_id:w.query.panel_id,trendlog_id:w.query.trendlog_id,all_data_decoded:t?(()=>{try{return W(t)}catch(e){return{error:"Failed to decode",raw_preview:t.substring(0,200)+"..."}}})():null,...Object.fromEntries(Object.entries(w.query).filter((([e])=>!["sn","panel_id","trendlog_id","all_data"].includes(e))))};if(p.Debug("ðŸ“Š IndexPageSocket - Readable Query Object:",n),null===e||null===a||null===l)return p.Debug("ï¿½?IndexPageSocket: Missing required parameters for trend log data"),null;let r=null;if(t){const e=W(t);e&&"valid"===R.value&&(r=e.t3Entry||e)}if(!r)return null;r.pid=a,r.label=r.label||`TRL${e}_${a}_${l}`,r.command=r.command||`${a}MON${l}`,r.id=r.id||`MON${l}`;const i={title:r.label||"T3000 Trend Log Analysis",t3Entry:r};return{chartData:i,scheduleData:{active:!1,cat:"TrendLog",height:60,id:l,rotate:0,scaleX:1,scaleY:1,settings:{active:!1,bgColor:"inherit",fillColor:"#659dc5",fontSize:16,inAlarm:!1,t3EntryDisplayField:"label",textColor:"inherit",titleColor:"inherit"},showDimensions:!0,t3Entry:r,title:i.title,translate:[583,68],type:"Monitor",width:60,zindex:1}}})();return e?(I.value=e.chartData,f.value=e.scheduleData,void(q.value=e.chartData.title)):(A.value="Error: The trend log data in the URL parameter (all_data) is missing or invalid. Please check the data source or try again.",I.value=null,void(f.value=null))}return I.value=null,f.value=null,q.value="T3000 Trend Log Analysis",void(A.value="Missing required parameters: sn, panel_id, trendlog_id, or all_data.")}catch(e){A.value=e instanceof Error?e.message:"Failed to load trend log data",I.value=null,f.value=null}finally{O.value=!1}};n((()=>w.query),(()=>{S()}),{immediate:!1}),n((()=>f.value),((e,a)=>{}),{immediate:!0,deep:!0});return r((()=>{try{b.IdxPage.initQuasar(E)}catch(e){}(async()=>{var a;const{sn:l,panel_id:t,trendlog_id:n}=k.value;if(l&&null!==t&&null!==n)try{_.value.panelsData||(_.value.panelsData=[]),_.value.panelsList||(_.value.panelsList=[]),_.value.panelsRanges||(_.value.panelsRanges=[]),_.value.panelsList.find((e=>e.panel_number===t))||_.value.panelsList.push({panel_number:t,serial_number:l,panel_name:`Panel ${t}`,online:!0});let r=!1;if(b.WebClient&&(null==(a=window.chrome)?void 0:a.webview))try{b.WebClient.initMessageHandler(),b.WebClient.initQuasar(E),_.value.loadingPanel=t,b.WebClient.GetPanelsList(),setTimeout((()=>b.WebClient.GetPanelData(t)),500),await y.waitForDataReady({timeout:15e3,specificEntries:[`MON${n}`,`TRL${n}`]}),r=!0}catch(e){_.value.loadingPanel=null}if(!r&&b.WsClient)try{b.WsClient.initQuasar(E),_.value.loadingPanel=t,b.WsClient.connect(),setTimeout((()=>{b.WsClient.GetPanelsList(),setTimeout((()=>b.WsClient.GetPanelData(t)),1e3)}),1e3),await y.waitForDataReady({timeout:2e4,specificEntries:[`MON${n}`,`TRL${n}`]}),r=!0}catch(e){_.value.loadingPanel=null}r||(_.value.loadingPanel=null)}catch(e){_.value.loadingPanel=null}})(),S()})),(e,a)=>(i(),s("div",D,[L.value?(i(),o(d(j),{key:0,type:"info","show-icon":"",message:"Panel ID Error",description:C,style:{margin:"32px 0"}})):A.value?(i(),o(d(j),{key:1,type:"info","show-icon":"",message:"Error Loading Data",description:A.value,style:{margin:"32px 0"}},null,8,["description"])):O.value&&N.value?(i(),s("div",P,[...a[0]||(a[0]=[u("div",{class:"loading-content"},[u("div",{class:"loading-spinner"}),u("p",null,"Loading trend log data...")],-1)])])):$.value?(i(),s("div",T,[c(g,{itemData:d(f),title:q.value},null,8,["itemData","title"])])):(i(),s("div",x,[u("div",{class:"no-data-content"},[a[1]||(a[1]=u("h3",null,"No Data Available",-1)),a[2]||(a[2]=u("p",null,"Please provide valid URL parameters to display trend log data.",-1)),u("button",{onClick:S,class:"retry-button"},"Load Data")])]))]))}}),[["__scopeId","data-v-b279c99a"]]);export{L as default};

import{d as e,a7 as a,h as t,a as l,w as n,o as i,a1 as r,a2 as s,a3 as d,a4 as o,c as u,u as c,X as p}from"./index.8dd48b07.js";import{u as v}from"./use-quasar.a5ac4cdc.js";import{u as g,T as m,t as _}from"./TrendLogChart.5ecda34c.js";import{s as y}from"./RefConstant.bfc4e7f0.js";import{h as b}from"./T3Data.301774c4.js";import{f3 as f}from"./Hvac.a7a3a515.js";import{_ as h}from"./plugin-vue_export-helper.21dcd24c.js";import"./QChip.246fee19.js";import"./dayjs.min.a4094c4f.js";import"./_commonjsHelpers.a5007c1f.js";import"./auto.4ae97206.js";import"./chartjs-adapter-date-fns.esm.6cd07d05.js";import"./index.9ba5e6aa.js";import"./AntdIcon.ddaa8d78.js";import"./index.fb568b06.js";import"./ReloadOutlined.13be878a.js";import"./CheckOutlined.82384d3a.js";import"./common.3f036025.js";import"./api.6cc26dac.js";import"./index.d11c4764.js";import"./QTooltip.f8b82346.js";const j={class:"trend-log-page"},D={key:0,class:"loading-wrapper"},$={key:1,class:"error-wrapper"},T={class:"error-content"},L={key:2,class:"chart-wrapper"},C={class:"data-source-indicator"},P={key:0,class:"source-badge realtime"},S={key:1,class:"source-badge historical"},w={key:2,class:"source-badge fallback"},O={key:3,class:"no-data-wrapper"};var k=h(e({name:"TrendLogIndexPage",__name:"IndexPageSocket",setup(e){const h=a(),k=v(),N=g(),A=t("T3000 Trend Log Analysis"),R=t(!1),q=t(null),x=t(null),E=t(null),M=t("json"),I=l((()=>({sn:h.query.sn?Number(h.query.sn):null,panel_id:h.query.panel_id?Number(h.query.panel_id):null,trendlog_id:h.query.trendlog_id?Number(h.query.trendlog_id):null,all_data:h.query.all_data||null})));l((()=>{const e=I.value;return null!==e.sn&&null!==e.panel_id&&null!==e.trendlog_id}));const W=l((()=>y.value&&"object"==typeof y.value&&Object.keys(y.value).length>0));l((()=>{const{all_data:e}=I.value;return!!e&&(e.startsWith("{")||e.includes("%7B"))}));const F=e=>{try{E.value="pending";const a=decodeURIComponent(e);if(a.includes('"error":"JSON conversion failed"')||'{"error":"JSON conversion failed"}'===a)return E.value="error",null;const t=JSON.parse(a);if(t.error&&t.error.includes("JSON conversion failed"))return E.value="error",null;const l=H(t);return E.value=l?"valid":"invalid",t}catch(a){return E.value="invalid",null}},H=e=>!(!e||"object"!=typeof e)&&(!!(e.command&&e.id&&Array.isArray(e.input)&&Array.isArray(e.range))||!!(e.t3Entry&&"object"==typeof e.t3Entry&&Array.isArray(e.t3Entry.input)&&Array.isArray(e.t3Entry.range))),Q=async()=>{var e,a,t;try{R.value=!0,q.value=null;const l=(()=>{const e=I.value,a=null!==e.sn&&null!==e.panel_id&&null!==e.trendlog_id;return{sn:e.sn,panel_id:e.panel_id,trendlog_id:e.trendlog_id,all_data:e.all_data,isValid:a}})();if(l.all_data){M.value="json";const e=(()=>{const{sn:e,panel_id:a,trendlog_id:t,all_data:l}=I.value;p.Debug("üìä IndexPageSocket - Original Query Parameters:",h.query);const n={sn:h.query.sn,panel_id:h.query.panel_id,trendlog_id:h.query.trendlog_id,all_data_decoded:l?(()=>{try{return F(l)}catch(e){return{error:"Failed to decode",raw_preview:l.substring(0,200)+"..."}}})():null,...Object.fromEntries(Object.entries(h.query).filter((([e])=>!["sn","panel_id","trendlog_id","all_data"].includes(e))))};if(p.Debug("üìä IndexPageSocket - Readable Query Object:",n),null===e||null===a||null===t)return p.Debug("‚ùå IndexPageSocket: Missing required parameters for trend log data"),null;let i=null;if(l){const e=F(l);e&&"valid"===E.value&&(i=e.t3Entry||e)}i||(i={an_inputs:12,command:`${a}MON${t}`,hour_interval_time:0,id:`MON${t}`,index:0,input:[],label:`TRL${e}_${a}_${t}`,minute_interval_time:0,num_inputs:14,pid:a,range:[],second_interval_time:15,status:1,type:"MON"}),i.pid=a,i.label=i.label||`TRL${e}_${a}_${t}`,i.command=i.command||`${a}MON${t}`,i.id=i.id||`MON${t}`;const r={title:i.label||"T3000 Trend Log Analysis",t3Entry:i};return{chartData:r,scheduleData:{active:!1,cat:"TrendLog",height:60,id:t,rotate:0,scaleX:1,scaleY:1,settings:{active:!1,bgColor:"inherit",fillColor:"#659dc5",fontSize:16,inAlarm:!1,t3EntryDisplayField:"label",textColor:"inherit",titleColor:"inherit"},showDimensions:!0,t3Entry:i,title:r.title,translate:[583,68],type:"Monitor",width:60,zindex:1}}})();if(e)return x.value=e.chartData,y.value=e.scheduleData,void(A.value=e.chartData.title)}if(l.isValid&&l.sn&&null!==l.panel_id&&null!==l.trendlog_id){M.value="api";const n=new Date,i=new Date(n.getTime()-36e5),r=e=>`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}:${e.getSeconds().toString().padStart(2,"0")}`,s={serial_number:l.sn,panel_id:l.panel_id,trendlog_id:l.trendlog_id.toString(),start_time:r(i),end_time:r(n),limit:1e3,point_types:["INPUT","OUTPUT","VARIABLE"]},d=await N.getTrendlogHistory(s);if((null==(e=null==d?void 0:d.data)?void 0:e.length)>0){const e={id:d.trendlog_id,label:`TRL${l.sn}_${l.panel_id}_${l.trendlog_id}`,description:`Historical Trend Log ${l.trendlog_id} from Panel ${l.panel_id}`,pid:l.panel_id,type:"MON",value:(null==(a=d.data[0])?void 0:a.value)||0,unit:(null==(t=d.data[0])?void 0:t.units)||"",status:1,input:[],range:[],num_inputs:d.count,an_inputs:d.data.filter((e=>e.is_analog)).length,scheduleData:d.data.map(((e,a)=>({time:e.time,value:e.value,index:a,units:e.units,point_type:e.point_type})))};return x.value=e,y.value=e,void(A.value=`Historical Trend Log ${l.trendlog_id} - Device ${l.sn}`)}}M.value="fallback",x.value=null,y.value=null,A.value="T3000 Trend Log Analysis",N.error.value?q.value=`Failed to load historical data: ${N.error.value}`:l.isValid?q.value="No trend log data available":q.value="Missing required parameters: sn, panel_id, and trendlog_id"}catch(l){q.value=l instanceof Error?l.message:"Failed to load trend log data",x.value=null,y.value=null,M.value="fallback"}finally{R.value=!1}};n((()=>h.query),(()=>{Q()}),{immediate:!1}),n((()=>y.value),((e,a)=>{}),{immediate:!0,deep:!0});return i((()=>{try{f.IdxPage.initQuasar(k)}catch(e){}(async()=>{var a;const{sn:t,panel_id:l,trendlog_id:n}=I.value;if(t&&null!==l&&null!==n)try{b.value.panelsData||(b.value.panelsData=[]),b.value.panelsList||(b.value.panelsList=[]),b.value.panelsRanges||(b.value.panelsRanges=[]),b.value.panelsList.find((e=>e.panel_number===l))||b.value.panelsList.push({panel_number:l,serial_number:t,panel_name:`Panel ${l}`,online:!0});let i=!1;if(f.WebClient&&(null==(a=window.chrome)?void 0:a.webview))try{f.WebClient.initMessageHandler(),f.WebClient.initQuasar(k),b.value.loadingPanel=l,f.WebClient.GetPanelsList(),setTimeout((()=>f.WebClient.GetPanelData(l)),500),await _.waitForDataReady({timeout:15e3,specificEntries:[`MON${n}`,`TRL${n}`]}),i=!0}catch(e){b.value.loadingPanel=null}if(!i&&f.WsClient)try{f.WsClient.initQuasar(k),b.value.loadingPanel=l,f.WsClient.connect(),setTimeout((()=>{f.WsClient.GetPanelsList(),setTimeout((()=>f.WsClient.GetPanelData(l)),1e3)}),1e3),await _.waitForDataReady({timeout:2e4,specificEntries:[`MON${n}`,`TRL${n}`]}),i=!0}catch(e){b.value.loadingPanel=null}i||(b.value.loadingPanel=null)}catch(e){b.value.loadingPanel=null}})(),Q()})),(e,a)=>(r(),s("div",j,[R.value?(r(),s("div",D,[...a[0]||(a[0]=[d("div",{class:"loading-content"},[d("div",{class:"loading-spinner"}),d("p",null,"Loading trend log data...")],-1)])])):q.value?(r(),s("div",$,[d("div",T,[a[1]||(a[1]=d("h3",null,"Error Loading Data",-1)),d("p",null,o(q.value),1),d("button",{onClick:Q,class:"retry-button"},"Retry")])])):W.value?(r(),s("div",L,[d("div",C,["json"===M.value?(r(),s("span",P," üì° Real-time Data (From C++ Backend) ")):"api"===M.value?(r(),s("span",S," üìö Historical Data (From Database) ")):(r(),s("span",w," ‚ö†Ô∏è No Data Available "))]),u(m,{itemData:c(y),title:A.value},null,8,["itemData","title"])])):(r(),s("div",O,[d("div",{class:"no-data-content"},[a[2]||(a[2]=d("h3",null,"No Data Available",-1)),a[3]||(a[3]=d("p",null,"Please provide valid URL parameters to display trend log data.",-1)),d("button",{onClick:Q,class:"retry-button"},"Load Data")])]))]))}}),[["__scopeId","data-v-9d55013e"]]);export{k as default};

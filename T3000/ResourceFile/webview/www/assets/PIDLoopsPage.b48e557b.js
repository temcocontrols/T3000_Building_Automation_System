var e,t,s=Object.defineProperty;import{j as r}from"./react.2da10d74.js";import{r as a}from"./client.b9d1bbf8.js";import{A as l,w as o,x as n,T as i,aC as d,z as p,S as c,C as x,D as u,I as h,M as m,F as f,B as _,H as j,J as b,K as g,y as v}from"./App.2c62e2d1.js";import{c as C,D as y,a as N,b as I,d as w,e as S,f as W,T}from"./DataGridHeaderCell.34491fc4.js";import{S as P}from"./chunk-14.975a9417.js";import{I as D}from"./Input.16f797a0.js";import{S as B}from"./Switch.411cd684.js";import"./index.5672de35.js";import"./Serializer.f6a5f515.js";import"./useFocusableGroup.6d334b5b.js";class H{static async refreshPidLoop(e,t){try{const s=await fetch(`${this.baseUrl}/pid-loops/${e}/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({index:t})});if(!s.ok){const e=await s.text();throw new Error(`HTTP ${s.status}: ${e||s.statusText}`)}return await s.json()}catch(s){throw s}}static async refreshAllPidLoops(e){try{const t=await fetch(`${this.baseUrl}/pid-loops/${e}/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});if(!t.ok){const e=await t.text();throw new Error(`HTTP ${t.status}: ${e||t.statusText}`)}return await t.json()}catch(t){throw t}}static async saveRefreshedPidLoops(e,t){try{const s=await fetch(`${this.baseUrl}/pid-loops/${e}/save-refreshed`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:t})});if(!s.ok){const e=await s.text();throw new Error(`HTTP ${s.status}: ${e||s.statusText}`)}return await s.json()}catch(s){throw s}}}t=`${l}/api/t3_device`,((e,t,r)=>{t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r})(H,"symbol"!=typeof(e="baseUrl")?e+"":e,t);var k={container:"_container_1l411_35",bladeContentContainer:"_bladeContentContainer_1l411_59",bladeContentWrapper:"_bladeContentWrapper_1l411_75",bladeContent:"_bladeContent_1l411_59",partContent:"_partContent_1l411_107",toolbar:"_toolbar_1l411_125",toolbarContainer:"_toolbarContainer_1l411_143",toolbarButton:"_toolbarButton_1l411_159",toolbarSeparator:"_toolbarSeparator_1l411_237",searchInputWrapper:"_searchInputWrapper_1l411_253",searchIcon:"_searchIcon_1l411_267",searchInput:"_searchInput_1l411_253",bladeDescription:"_bladeDescription_1l411_347",overviewHr:"_overviewHr_1l411_387",dockingBody:"_dockingBody_1l411_403",scrollContainer:"_scrollContainer_1l411_419",autoLoadIndicator:"_autoLoadIndicator_1l411_435",loading:"_loading_1l411_457",noData:"_noData_1l411_459",loadingBar:"_loadingBar_1l411_477",editableCell:"_editableCell_1l411_759",editInput:"_editInput_1l411_787",saveButton:"_saveButton_1l411_859",refreshIconButton:"_refreshIconButton_1l411_921",isRefreshing:"_isRefreshing_1l411_991",rotating:"_rotating_1l411_1031",rotate:"_rotate_1l411_1"};var A=()=>{const{selectedDevice:e,treeData:t,selectDevice:s,getNextDevice:A,getFilteredDevices:$}=o(),[L,O]=a.exports.useState([]),[R,z]=a.exports.useState(!1),[E,M]=a.exports.useState(null),[U,F]=a.exports.useState(!1),[V,J]=a.exports.useState({}),[Z,G]=a.exports.useState(!1),[K,Y]=a.exports.useState(null),[q,Q]=a.exports.useState("ascending"),[X,ee]=a.exports.useState(""),[te,se]=a.exports.useState(!1),[re,ae]=a.exports.useState(new Set),[le,oe]=a.exports.useState(!1),ne=a.exports.useRef(null),[ie,de]=a.exports.useState(!1),pe=a.exports.useRef(!1);a.exports.useEffect((()=>{if(!e){const e=$();e.length>0&&s(e[0])}}),[e,$,s]);const ce=a.exports.useCallback((async()=>{if(e){z(!0),M(null);try{const t=`${l}/api/t3_device/devices/${e.serialNumber}/table/PID_TABLE`,s=await fetch(t);if(!s.ok)throw new Error("Failed to fetch PID loops");const r=await s.json();O(r.data||[])}catch(t){M(t instanceof Error?t.message:"Failed to load PID loops")}finally{z(!1)}}}),[e]);a.exports.useEffect((()=>{ce()}),[ce]),a.exports.useEffect((()=>{if(R||!e||le)return;const t=setTimeout((async()=>{try{const t=await H.refreshAllPidLoops(e.serialNumber);t.items&&t.items.length>0&&(await H.saveRefreshedPidLoops(e.serialNumber,t.items),await ce()),oe(!0)}catch(t){oe(!0)}}),500);return()=>clearTimeout(t)}),[R,e,le,ce]);const xe=(e,t,s)=>{J((r=>({...r,[e]:{...r[e]||{},[t]:s}}))),G(!0)},ue=(e,t)=>{var s,r,a;const l=e.loop_field;return null!=(a=null!=(r=null==(s=V[l])?void 0:s[t])?r:e[t])?a:""},he=e=>{const t="AUTO"===ue(e,"auto_manual")?"MANUAL":"AUTO";xe(e.loop_field,"auto_manual",t)},me=e=>{K===e?Q("ascending"===q?"descending":"ascending"):(Y(e),Q("ascending"))},fe=a.exports.useCallback((()=>{const e=A();e&&(de(!0),s(e),setTimeout((()=>{de(!1)}),500))}),[A,s]),_e=a.exports.useCallback((e=>{if(ie||R)return;const t=e.currentTarget;t.scrollHeight-t.scrollTop-t.clientHeight<=1&&L.length>0?pe.current=!0:pe.current=!1}),[ie,R,L.length]),je=a.exports.useCallback((e=>{ie||R||0===L.length||e.deltaY>0&&pe.current&&(pe.current=!1,fe())}),[ie,R,L.length,fe]);a.exports.useEffect((()=>{e&&ne.current&&ne.current.scrollTo({top:0,behavior:ie?"smooth":"auto"})}),[e,ie]);const be=a.exports.useMemo((()=>[C({columnId:"loop_field",compare:(e,t)=>Number(e.loop_field)-Number(t.loop_field),renderHeaderCell:()=>r.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>me("loop_field"),children:[r.exports.jsx("span",{children:"NUM"}),"loop_field"===K?"ascending"===q?r.exports.jsx(j,{}):r.exports.jsx(b,{}):r.exports.jsx(g,{style:{opacity:.5}})]}),renderCell:t=>{const s=t.loop_field||"",a=re.has(s);return r.exports.jsx(T,{children:r.exports.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[r.exports.jsx("button",{onClick:t=>{t.stopPropagation(),(async t=>{if(!e)return;const s=parseInt(t,10);if(!isNaN(s)){ae((e=>new Set(e).add(t)));try{const r=await H.refreshPidLoop(e.serialNumber,s);r.items&&r.items.length>0&&await H.saveRefreshedPidLoops(e.serialNumber,r.items),await ce()}catch(r){}finally{ae((e=>{const s=new Set(e);return s.delete(t),s}))}}})(s)},className:`${k.refreshIconButton} ${a?k.isRefreshing:""}`,title:"Refresh this PID loop from device",disabled:a,children:r.exports.jsx(v,{style:{fontSize:"14px"},className:a?k.rotating:""})}),r.exports.jsx(i,{size:200,weight:"regular",children:t.loop_field})]})})}}),C({columnId:"input_field",compare:(e,t)=>(e.input_field||"").localeCompare(t.input_field||""),renderHeaderCell:()=>r.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:r.exports.jsx("span",{children:"Input"})}),renderCell:e=>r.exports.jsx(T,{children:r.exports.jsx(D,{className:k.editableInput,value:ue(e,"input_field"),onChange:(t,s)=>xe(e.loop_field,"input_field",s.value)})})}),C({columnId:"input_value",compare:(e,t)=>Number(e.input_value||0)-Number(t.input_value||0),renderHeaderCell:()=>r.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:r.exports.jsx("span",{children:"Value"})}),renderCell:e=>r.exports.jsx(T,{children:r.exports.jsx(D,{className:k.editableInput,type:"number",value:ue(e,"input_value"),onChange:(t,s)=>xe(e.loop_field,"input_value",s.value)})})}),C({columnId:"units",compare:(e,t)=>(e.units||"").localeCompare(t.units||""),renderHeaderCell:()=>r.exports.jsx("div",{className:k.headerText,children:"Units"}),renderCell:e=>r.exports.jsx(T,{className:k.readOnlyCell,children:ue(e,"units")})}),C({columnId:"auto_manual",compare:(e,t)=>(e.auto_manual||"").localeCompare(t.auto_manual||""),renderHeaderCell:()=>r.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:r.exports.jsx("span",{children:"A/M"})}),renderCell:e=>{const t="AUTO"===ue(e,"auto_manual");return r.exports.jsx(T,{children:r.exports.jsxs("div",{className:k.autoManualContainer,children:[r.exports.jsx(B,{checked:t,onChange:()=>he(e),className:k.autoManualSwitch}),r.exports.jsx("span",{className:k.autoManualLabel,children:t?"AUTO":"MAN"})]})})}}),C({columnId:"output_field",compare:(e,t)=>(e.output_field||"").localeCompare(t.output_field||""),renderHeaderCell:()=>r.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:r.exports.jsx("span",{children:"Output"})}),renderCell:e=>r.exports.jsx(T,{children:r.exports.jsx(D,{className:k.editableInput,value:ue(e,"output_field"),onChange:(t,s)=>xe(e.loop_field,"output_field",s.value)})})}),C({columnId:"set_value",compare:(e,t)=>Number(e.set_value||0)-Number(t.set_value||0),renderHeaderCell:()=>r.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:r.exports.jsx("span",{children:"Setpoint"})}),renderCell:e=>r.exports.jsx(T,{children:r.exports.jsx(D,{className:k.editableInput,type:"number",value:ue(e,"set_value"),onChange:(t,s)=>xe(e.loop_field,"set_value",s.value)})})}),C({columnId:"units_state",compare:(e,t)=>(e.units_state||"").localeCompare(t.units_state||""),renderHeaderCell:()=>r.exports.jsx("div",{className:k.headerText,children:"Units"}),renderCell:e=>r.exports.jsx(T,{className:k.readOnlyCell,children:ue(e,"units_state")})}),C({columnId:"action_field",compare:(e,t)=>(e.action_field||"").localeCompare(t.action_field||""),renderHeaderCell:()=>r.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:r.exports.jsx("span",{children:"Action"})}),renderCell:e=>r.exports.jsx(T,{className:k.readOnlyCell,children:ue(e,"action_field")})}),C({columnId:"proportional",compare:(e,t)=>Number(e.proportional||0)-Number(t.proportional||0),renderHeaderCell:()=>r.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:r.exports.jsx("span",{children:"Prop"})}),renderCell:e=>r.exports.jsx(T,{children:r.exports.jsx(D,{className:k.editableInput,type:"number",value:ue(e,"proportional"),onChange:(t,s)=>xe(e.loop_field,"proportional",s.value)})})}),C({columnId:"reset_field",compare:(e,t)=>Number(e.reset_field||0)-Number(t.reset_field||0),renderHeaderCell:()=>r.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:r.exports.jsx("span",{children:"Int"})}),renderCell:e=>r.exports.jsx(T,{children:r.exports.jsx(D,{className:k.editableInput,type:"number",value:ue(e,"reset_field"),onChange:(t,s)=>xe(e.loop_field,"reset_field",s.value)})})}),C({columnId:"rate",compare:(e,t)=>Number(e.rate||0)-Number(t.rate||0),renderHeaderCell:()=>r.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:r.exports.jsx("span",{children:"Der"})}),renderCell:e=>r.exports.jsx(T,{children:r.exports.jsx(D,{className:k.editableInput,type:"number",value:ue(e,"rate"),onChange:(t,s)=>xe(e.loop_field,"rate",s.value)})})}),C({columnId:"bias",compare:(e,t)=>Number(e.bias||0)-Number(t.bias||0),renderHeaderCell:()=>r.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:r.exports.jsx("span",{children:"Bias"})}),renderCell:e=>r.exports.jsx(T,{children:r.exports.jsx(D,{className:k.editableInput,type:"number",value:ue(e,"bias"),onChange:(t,s)=>xe(e.loop_field,"bias",s.value)})})})]),[V,K,q,me,xe,he,ue]);return r.exports.jsx("div",{className:k.container,children:r.exports.jsx("div",{className:k.bladeContentContainer,children:r.exports.jsx("div",{className:k.bladeContentWrapper,children:r.exports.jsx("div",{className:k.bladeContent,children:r.exports.jsxs("div",{className:k.partContent,children:[E&&r.exports.jsxs("div",{style:{marginBottom:"12px",padding:"8px 12px",backgroundColor:"#fef6f6",borderRadius:"4px",display:"flex",alignItems:"center",gap:"8px"},children:[r.exports.jsx(n,{style:{color:"#d13438",fontSize:"16px",flexShrink:0}}),r.exports.jsx(i,{style:{color:"#d13438",fontWeight:500,fontSize:"13px"},children:E})]}),e&&r.exports.jsx("div",{className:k.toolbar,children:r.exports.jsxs("div",{className:k.toolbarContainer,children:[r.exports.jsxs("button",{className:k.toolbarButton,onClick:async()=>{if(e){se(!0);try{const t=await H.refreshAllPidLoops(e.serialNumber);if(t.items&&t.items.length>0){await H.saveRefreshedPidLoops(e.serialNumber,t.items);await ce()}}catch(t){M(t instanceof Error?t.message:"Failed to refresh from device")}finally{se(!1)}}},disabled:te,title:"Refresh all PID loops from device","aria-label":"Refresh from Device",children:[r.exports.jsx(d,{}),r.exports.jsx("span",{children:te?"Refreshing...":"Refresh from Device"})]}),r.exports.jsxs("button",{className:k.toolbarButton,onClick:()=>{},title:"Export to CSV","aria-label":"Export to CSV",children:[r.exports.jsx(p,{}),r.exports.jsx("span",{children:"Export to CSV"})]}),r.exports.jsx("div",{className:k.toolbarSeparator,role:"separator"}),r.exports.jsxs("button",{className:k.toolbarButton,onClick:()=>{},title:"Settings","aria-label":"Settings",children:[r.exports.jsx(c,{}),r.exports.jsx("span",{children:"Settings"})]}),r.exports.jsxs("div",{className:k.searchInputWrapper,children:[r.exports.jsx(x,{className:k.searchIcon}),r.exports.jsx("input",{className:k.searchInput,type:"text",placeholder:"Search PID loops...",value:X,onChange:e=>{ee(e.target.value)},spellCheck:"false",role:"searchbox","aria-label":"Search PID loops"})]}),e&&r.exports.jsx(u,{content:`Showing PID loops for ${e.nameShowOnTree} (SN: ${e.serialNumber}). This table displays all PID controller configurations including inputs, outputs, setpoints, and tuning parameters.`,relationship:"description",children:r.exports.jsx("button",{className:k.toolbarButton,style:{marginLeft:"8px"},title:"Information","aria-label":"Information about this page",children:r.exports.jsx(h,{})})}),Z&&r.exports.jsxs(r.exports.Fragment,{children:[r.exports.jsx("div",{className:k.toolbarSeparator,role:"separator"}),r.exports.jsxs("button",{className:k.toolbarButton,onClick:()=>{J({}),G(!1)},title:"Discard Changes","aria-label":"Discard Changes",children:[r.exports.jsx(m,{}),r.exports.jsx("span",{children:"Discard"})]}),r.exports.jsxs("button",{className:`${k.toolbarButton} ${k.toolbarButtonPrimary}`,onClick:async()=>{F(!0);try{J({}),G(!1)}catch(e){}finally{F(!1)}},disabled:U,title:"Save All","aria-label":"Save All",children:[r.exports.jsx(P,{}),r.exports.jsx("span",{children:U?"Saving...":"Save All"})]})]})]})}),r.exports.jsx("div",{style:{padding:"0"},children:r.exports.jsx("hr",{className:k.overviewHr})}),r.exports.jsxs("div",{className:k.dockingBody,children:[R&&0===L.length&&r.exports.jsxs("div",{className:k.loadingBar,children:[r.exports.jsx(f,{size:"tiny"}),r.exports.jsx(i,{size:200,weight:"regular",children:"Loading PID loops..."})]}),!e&&!R&&r.exports.jsx("div",{className:k.noData,children:r.exports.jsxs("div",{style:{textAlign:"center"},children:[r.exports.jsx(i,{size:500,weight:"semibold",children:"No device selected"}),r.exports.jsx("br",{}),r.exports.jsx(i,{size:300,children:"Please select a device from the tree to view PID loops"})]})}),e&&!R&&!E&&r.exports.jsxs("div",{ref:ne,className:k.scrollContainer,onScroll:_e,onWheel:je,children:[r.exports.jsxs(y,{items:L,columns:be,sortable:!0,resizableColumns:!0,columnSizingOptions:{loop_field:{minWidth:60,defaultWidth:80},input_field:{minWidth:100,defaultWidth:150},input_value:{minWidth:80,defaultWidth:100},units:{minWidth:80,defaultWidth:100},auto_manual:{minWidth:100,defaultWidth:120},output_field:{minWidth:100,defaultWidth:150},output_value:{minWidth:80,defaultWidth:100},setpoint_field:{minWidth:100,defaultWidth:150},setpoint_value:{minWidth:80,defaultWidth:100},prop_band:{minWidth:80,defaultWidth:100},integral:{minWidth:80,defaultWidth:100},derivative:{minWidth:80,defaultWidth:100},sample_time:{minWidth:90,defaultWidth:110}},children:[r.exports.jsx(N,{children:r.exports.jsx(I,{children:({renderHeaderCell:e})=>r.exports.jsx(w,{children:e()})})}),r.exports.jsx(S,{children:({item:e,rowId:t})=>r.exports.jsx(I,{children:({renderCell:t})=>r.exports.jsx(W,{children:t(e)})},t)})]}),0===L.length&&r.exports.jsxs("div",{style:{marginTop:"24px",textAlign:"center",padding:"0 20px"},children:[r.exports.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",marginBottom:"8px"},children:[r.exports.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",style:{opacity:.5},children:r.exports.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4ZM10 8V16H14V8H10Z",fill:"currentColor"})}),r.exports.jsx(i,{size:400,weight:"semibold",children:"No PID loops found"})]}),r.exports.jsx(i,{size:300,style:{display:"block",marginBottom:"16px",color:"#605e5c",textAlign:"center"},children:"This device has no PID loops configured"}),r.exports.jsx(_,{appearance:"subtle",icon:r.exports.jsx(d,{}),onClick:async()=>{se(!0),await ce(),se(!1)},style:{minWidth:"120px",fontWeight:"normal"},children:"Refresh"})]}),ie&&r.exports.jsxs("div",{className:k.autoLoadIndicator,children:[r.exports.jsx(f,{size:"tiny"}),r.exports.jsx(i,{children:"Loading next device..."})]})]})]})]})})})})})};export{A as default};

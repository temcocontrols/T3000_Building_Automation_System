import{j as e}from"./react.1acd1a13.js";import{r as t}from"./client.58f92968.js";import{l as s,M as r,n as a,T as l,aL as o,N as n,z as i,P as p,Q as d,I as c,a3 as x,aM as u,S as h,R as m,U as _,V as f,X as j,y as b,Z as g}from"./App.3fe38e41.js";import{c as v,D as C,a as N,b as I,d as y,e as S,f as z}from"./DataGridHeaderCell.f7016832.js";import{T as W}from"./TableCellLayout.9e29eb07.js";import{I as D}from"./Input.037b8c53.js";import"./index.2479820c.js";import"./Serializer.f6a5f515.js";import"./T3Data.5fdf3c76.js";import"./_commonjsHelpers.a5007c1f.js";var q={container:"_container_zp0hq_18",bladeContentContainer:"_bladeContentContainer_zp0hq_30",bladeContentWrapper:"_bladeContentWrapper_zp0hq_38",bladeContent:"_bladeContent_zp0hq_30",partContent:"_partContent_zp0hq_54",toolbar:"_toolbar_zp0hq_63",toolbarContainer:"_toolbarContainer_zp0hq_72",toolbarButton:"_toolbarButton_zp0hq_80",toolbarSeparator:"_toolbarSeparator_zp0hq_119",searchInputWrapper:"_searchInputWrapper_zp0hq_127",searchIcon:"_searchIcon_zp0hq_134",searchInput:"_searchInput_zp0hq_127",bladeDescription:"_bladeDescription_zp0hq_174",overviewHr:"_overviewHr_zp0hq_194",dockingBody:"_dockingBody_zp0hq_202",scrollContainer:"_scrollContainer_zp0hq_210",autoLoadIndicator:"_autoLoadIndicator_zp0hq_238",loading:"_loading_zp0hq_249",noData:"_noData_zp0hq_250",loadingBar:"_loadingBar_zp0hq_259",editableCell:"_editableCell_zp0hq_400",editInput:"_editInput_zp0hq_414",saveButton:"_saveButton_zp0hq_450",refreshIconButton:"_refreshIconButton_zp0hq_481",isRefreshing:"_isRefreshing_zp0hq_516",rotating:"_rotating_zp0hq_536",rotate:"_rotate_zp0hq_1"};var w=()=>{const{selectedDevice:w,treeData:B,selectDevice:H,getNextDevice:k,getFilteredDevices:A}=s(),[P,T]=t.exports.useState([]),[L,R]=t.exports.useState(!1),[E,M]=t.exports.useState(null),[O,U]=t.exports.useState(!1),[$,F]=t.exports.useState({}),[V,G]=t.exports.useState(!1),[Q,X]=t.exports.useState(null),[Y,Z]=t.exports.useState("ascending"),[J,K]=t.exports.useState(""),[ee,te]=t.exports.useState(!1),[se,re]=t.exports.useState(new Set),[ae,le]=t.exports.useState(!1),oe=t.exports.useRef(!1),ne=t.exports.useRef(null),[ie,pe]=t.exports.useState(!1),de=t.exports.useRef(!1),ce=t.exports.useMemo((()=>0===P.length?Array(10).fill(null).map(((e,t)=>({loop_field:"",input_field:"",input_value:"",units:"",auto_manual:"",output_field:"",output_value:"",set_value:"",units_state:"",action_field:"",proportional:"",reset_field:"",rate:"",bias:"",switch_node:"",status:"",type_field:"",setpoint_high:"",setpoint_low:"",variable_state:""}))):P),[P]),xe=e=>!e.loop_field&&0===P.length;t.exports.useEffect((()=>{if(!w){const e=A();e.length>0&&H(e[0])}}),[w,A,H]);const ue=t.exports.useCallback((async()=>{if(w){R(!0),M(null);try{const e=`${r}/api/t3_device/devices/${w.serialNumber}/table/PID_TABLE`,t=await fetch(e);if(!t.ok)throw new Error("Failed to fetch PID loops");const s=await t.json();T(s.data||[])}catch(e){M(e instanceof Error?e.message:"Failed to load PID loops")}finally{R(!1)}}}),[w]);t.exports.useEffect((()=>{ue()}),[ue]),t.exports.useEffect((()=>{T([]),le(!1),oe.current=!1}),[null==w?void 0:w.serialNumber]),t.exports.useEffect((()=>{if(L||!w||ae||oe.current)return;(async()=>{oe.current=!0;try{if(P.length>0)return void le(!0);await m.refreshAllPidLoops(w.serialNumber);await ue(),le(!0)}catch(e){le(!0)}})()}),[L,w,ae,ue,P.length]);const he=(e,t,s)=>{F((r=>({...r,[e]:{...r[e]||{},[t]:s}}))),G(!0)},me=(e,t)=>{var s,r,a;const l=e.loop_field;return null!=(a=null!=(r=null==(s=$[l])?void 0:s[t])?r:e[t])?a:""},_e=e=>{const t="AUTO"===me(e,"auto_manual")?"MANUAL":"AUTO";he(e.loop_field,"auto_manual",t)},fe=e=>{Q===e?Z("ascending"===Y?"descending":"ascending"):(X(e),Z("ascending"))},je=t.exports.useCallback((()=>{const e=k();e&&(pe(!0),H(e),setTimeout((()=>{pe(!1)}),500))}),[k,H]),be=t.exports.useCallback((e=>{if(ie||L)return;const t=e.currentTarget;t.scrollHeight-t.scrollTop-t.clientHeight<=1&&P.length>0?de.current=!0:de.current=!1}),[ie,L,P.length]),ge=t.exports.useCallback((e=>{ie||L||0===P.length||e.deltaY>0&&de.current&&(de.current=!1,je())}),[ie,L,P.length,je]);t.exports.useEffect((()=>{w&&ne.current&&ne.current.scrollTo({top:0,behavior:ie?"smooth":"auto"})}),[w,ie]);const ve=t.exports.useMemo((()=>[v({columnId:"loop_field",compare:(e,t)=>Number(e.loop_field)-Number(t.loop_field),renderHeaderCell:()=>e.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>fe("loop_field"),children:[e.exports.jsx("span",{children:"NUM"}),"loop_field"===Q?"ascending"===Y?e.exports.jsx(_,{}):e.exports.jsx(f,{}):e.exports.jsx(j,{style:{opacity:.5}})]}),renderCell:t=>{if(xe(t))return e.exports.jsx(W,{});const s=t.loop_field||"",r=se.has(s);return e.exports.jsx(W,{children:e.exports.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[e.exports.jsx("button",{onClick:e=>{e.stopPropagation(),(async e=>{if(!w)return;const t=parseInt(e,10);if(!isNaN(t)){re((t=>new Set(t).add(e)));try{await m.refreshSinglePidLoop(w.serialNumber,t),await ue()}catch(s){}finally{re((t=>{const s=new Set(t);return s.delete(e),s}))}}})(s)},className:`${q.refreshIconButton} ${r?q.isRefreshing:""}`,title:"Refresh this PID loop from device",disabled:r,children:e.exports.jsx(b,{style:{fontSize:"14px"},className:r?q.rotating:""})}),e.exports.jsx(l,{size:200,weight:"regular",children:t.loop_field})]})})}}),v({columnId:"input_field",compare:(e,t)=>(e.input_field||"").localeCompare(t.input_field||""),renderHeaderCell:()=>e.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:e.exports.jsx("span",{children:"Input"})}),renderCell:t=>e.exports.jsx(W,{children:!xe(t)&&e.exports.jsx(D,{className:q.editableInput,value:me(t,"input_field"),onChange:(e,s)=>he(t.loop_field,"input_field",s.value)})})}),v({columnId:"input_value",compare:(e,t)=>Number(e.input_value||0)-Number(t.input_value||0),renderHeaderCell:()=>e.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:e.exports.jsx("span",{children:"Value"})}),renderCell:t=>e.exports.jsx(W,{children:!xe(t)&&e.exports.jsx(D,{className:q.editableInput,type:"number",value:me(t,"input_value"),onChange:(e,s)=>he(t.loop_field,"input_value",s.value)})})}),v({columnId:"units",compare:(e,t)=>(e.units||"").localeCompare(t.units||""),renderHeaderCell:()=>e.exports.jsx("div",{className:q.headerText,children:"Units"}),renderCell:t=>e.exports.jsx(W,{className:q.readOnlyCell,children:!xe(t)&&me(t,"units")})}),v({columnId:"auto_manual",compare:(e,t)=>(e.auto_manual||"").localeCompare(t.auto_manual||""),renderHeaderCell:()=>e.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:e.exports.jsx("span",{children:"A/M"})}),renderCell:t=>{if(xe(t))return e.exports.jsx(W,{});const s="AUTO"===me(t,"auto_manual");return e.exports.jsx(W,{children:e.exports.jsxs("div",{className:q.autoManualContainer,children:[e.exports.jsx(g,{checked:s,onChange:()=>_e(t),className:q.autoManualSwitch}),e.exports.jsx("span",{className:q.autoManualLabel,children:s?"AUTO":"MAN"})]})})}}),v({columnId:"output_field",compare:(e,t)=>(e.output_field||"").localeCompare(t.output_field||""),renderHeaderCell:()=>e.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:e.exports.jsx("span",{children:"Output"})}),renderCell:t=>e.exports.jsx(W,{children:!xe(t)&&e.exports.jsx(D,{className:q.editableInput,value:me(t,"output_field"),onChange:(e,s)=>he(t.loop_field,"output_field",s.value)})})}),v({columnId:"set_value",compare:(e,t)=>Number(e.set_value||0)-Number(t.set_value||0),renderHeaderCell:()=>e.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:e.exports.jsx("span",{children:"Setpoint"})}),renderCell:t=>e.exports.jsx(W,{children:!xe(t)&&e.exports.jsx(D,{className:q.editableInput,type:"number",value:me(t,"set_value"),onChange:(e,s)=>he(t.loop_field,"set_value",s.value)})})}),v({columnId:"units_state",compare:(e,t)=>(e.units_state||"").localeCompare(t.units_state||""),renderHeaderCell:()=>e.exports.jsx("div",{className:q.headerText,children:"Units"}),renderCell:t=>e.exports.jsx(W,{className:q.readOnlyCell,children:!xe(t)&&me(t,"units_state")})}),v({columnId:"action_field",compare:(e,t)=>(e.action_field||"").localeCompare(t.action_field||""),renderHeaderCell:()=>e.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:e.exports.jsx("span",{children:"Action"})}),renderCell:t=>e.exports.jsx(W,{className:q.readOnlyCell,children:!xe(t)&&me(t,"action_field")})}),v({columnId:"proportional",compare:(e,t)=>Number(e.proportional||0)-Number(t.proportional||0),renderHeaderCell:()=>e.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:e.exports.jsx("span",{children:"Prop"})}),renderCell:t=>e.exports.jsx(W,{children:!xe(t)&&e.exports.jsx(D,{className:q.editableInput,type:"number",value:me(t,"proportional"),onChange:(e,s)=>he(t.loop_field,"proportional",s.value)})})}),v({columnId:"reset_field",compare:(e,t)=>Number(e.reset_field||0)-Number(t.reset_field||0),renderHeaderCell:()=>e.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:e.exports.jsx("span",{children:"Int"})}),renderCell:t=>e.exports.jsx(W,{children:!xe(t)&&e.exports.jsx(D,{className:q.editableInput,type:"number",value:me(t,"reset_field"),onChange:(e,s)=>he(t.loop_field,"reset_field",s.value)})})}),v({columnId:"rate",compare:(e,t)=>Number(e.rate||0)-Number(t.rate||0),renderHeaderCell:()=>e.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:e.exports.jsx("span",{children:"Der"})}),renderCell:t=>e.exports.jsx(W,{children:!xe(t)&&e.exports.jsx(D,{className:q.editableInput,type:"number",value:me(t,"rate"),onChange:(e,s)=>he(t.loop_field,"rate",s.value)})})}),v({columnId:"bias",compare:(e,t)=>Number(e.bias||0)-Number(t.bias||0),renderHeaderCell:()=>e.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:e.exports.jsx("span",{children:"Bias"})}),renderCell:t=>e.exports.jsx(W,{children:!xe(t)&&e.exports.jsx(D,{className:q.editableInput,type:"number",value:me(t,"bias"),onChange:(e,s)=>he(t.loop_field,"bias",s.value)})})})]),[$,Q,Y,fe,he,_e,me,xe]);return e.exports.jsx("div",{className:q.container,children:e.exports.jsx("div",{className:q.bladeContentContainer,children:e.exports.jsx("div",{className:q.bladeContentWrapper,children:e.exports.jsx("div",{className:q.bladeContent,children:e.exports.jsxs("div",{className:q.partContent,children:[E&&e.exports.jsxs("div",{style:{marginBottom:"12px",padding:"8px 12px",backgroundColor:"#fef6f6",borderRadius:"4px",display:"flex",alignItems:"center",gap:"8px"},children:[e.exports.jsx(a,{style:{color:"#d13438",fontSize:"16px",flexShrink:0}}),e.exports.jsx(l,{style:{color:"#d13438",fontWeight:500,fontSize:"13px"},children:E})]}),w&&e.exports.jsxs(e.exports.Fragment,{children:[e.exports.jsx("div",{className:q.toolbar,children:e.exports.jsxs("div",{className:q.toolbarContainer,children:[e.exports.jsxs("button",{className:q.toolbarButton,onClick:async()=>{if(w){te(!0);try{await m.refreshAllPidLoops(w.serialNumber);await ue()}catch(e){M(e instanceof Error?e.message:"Failed to refresh from device")}finally{te(!1)}}},disabled:ee,title:"Refresh all PID loops from device","aria-label":"Refresh from Device",children:[e.exports.jsx(o,{}),e.exports.jsx("span",{children:ee?"Refreshing...":"Refresh from Device"})]}),e.exports.jsxs("button",{className:q.toolbarButton,onClick:()=>{},title:"Export to CSV","aria-label":"Export to CSV",children:[e.exports.jsx(n,{}),e.exports.jsx("span",{children:"Export to CSV"})]}),e.exports.jsx("div",{className:q.toolbarSeparator,role:"separator"}),e.exports.jsxs("button",{className:q.toolbarButton,onClick:()=>{},title:"Settings","aria-label":"Settings",children:[e.exports.jsx(i,{}),e.exports.jsx("span",{children:"Settings"})]}),e.exports.jsxs("div",{className:q.searchInputWrapper,children:[e.exports.jsx(p,{className:q.searchIcon}),e.exports.jsx("input",{className:q.searchInput,type:"text",placeholder:"Search PID loops...",value:J,onChange:e=>{K(e.target.value)},spellCheck:"false",role:"searchbox","aria-label":"Search PID loops"})]}),w&&e.exports.jsx(d,{content:`Showing PID loops for ${w.nameShowOnTree} (SN: ${w.serialNumber}). This table displays all PID controller configurations including inputs, outputs, setpoints, and tuning parameters.`,relationship:"description",children:e.exports.jsx("button",{className:q.toolbarButton,style:{marginLeft:"8px"},title:"Information","aria-label":"Information about this page",children:e.exports.jsx(c,{})})}),V&&e.exports.jsxs(e.exports.Fragment,{children:[e.exports.jsx("div",{className:q.toolbarSeparator,role:"separator"}),e.exports.jsxs("button",{className:q.toolbarButton,onClick:()=>{F({}),G(!1)},title:"Discard Changes","aria-label":"Discard Changes",children:[e.exports.jsx(x,{}),e.exports.jsx("span",{children:"Discard"})]}),e.exports.jsxs("button",{className:`${q.toolbarButton} ${q.toolbarButtonPrimary}`,onClick:async()=>{U(!0);try{F({}),G(!1)}catch(e){}finally{U(!1)}},disabled:O,title:"Save All","aria-label":"Save All",children:[e.exports.jsx(u,{}),e.exports.jsx("span",{children:O?"Saving...":"Save All"})]})]})]})}),e.exports.jsx("div",{style:{padding:"0"},children:e.exports.jsx("hr",{className:q.overviewHr})})]}),e.exports.jsxs("div",{className:q.dockingBody,children:[L&&0===P.length&&e.exports.jsxs("div",{className:q.loadingBar,children:[e.exports.jsx(h,{size:"tiny"}),e.exports.jsx(l,{size:200,weight:"regular",children:"Loading PID loops..."})]}),!w&&!L&&e.exports.jsx("div",{className:q.noData,children:e.exports.jsxs("div",{style:{textAlign:"center"},children:[e.exports.jsx(l,{size:400,weight:"semibold",children:"No device selected"}),e.exports.jsx("br",{}),e.exports.jsx(l,{size:200,children:"Please select a device from the tree to view pid loops"})]})}),w&&!L&&!E&&e.exports.jsxs("div",{ref:ne,className:q.scrollContainer,onScroll:be,onWheel:ge,children:[e.exports.jsxs(C,{items:ce,columns:ve,sortable:!0,resizableColumns:!0,columnSizingOptions:{loop_field:{minWidth:60,defaultWidth:80},input_field:{minWidth:100,defaultWidth:150},input_value:{minWidth:80,defaultWidth:100},units:{minWidth:80,defaultWidth:100},auto_manual:{minWidth:100,defaultWidth:120},output_field:{minWidth:100,defaultWidth:150},output_value:{minWidth:80,defaultWidth:100},setpoint_field:{minWidth:100,defaultWidth:150},setpoint_value:{minWidth:80,defaultWidth:100},prop_band:{minWidth:80,defaultWidth:100},integral:{minWidth:80,defaultWidth:100},derivative:{minWidth:80,defaultWidth:100},sample_time:{minWidth:90,defaultWidth:110}},children:[e.exports.jsx(N,{children:e.exports.jsx(I,{children:({renderHeaderCell:t})=>e.exports.jsx(y,{children:t()})})}),e.exports.jsx(S,{children:({item:t,rowId:s})=>e.exports.jsx(I,{children:({renderCell:s})=>e.exports.jsx(z,{children:s(t)})},s)})]}),ie&&e.exports.jsxs("div",{className:q.autoLoadIndicator,children:[e.exports.jsx(h,{size:"tiny"}),e.exports.jsx(l,{children:"Loading next device..."})]})]})]})]})})})})})};export{w as default};

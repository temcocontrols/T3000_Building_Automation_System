var e,s,r=Object.defineProperty;import{j as t}from"./react.2da10d74.js";import{r as a}from"./client.b9d1bbf8.js";import{A as l,w as o,x as i,T as n,y as c,z as p,S as d,C as x,D as m,I as u,F as h,B as g,H as f,J as j,K as b}from"./App.2c62e2d1.js";import{c as y,D as v,a as C,b as _,d as w,e as N,f as S,T as I}from"./DataGridHeaderCell.34491fc4.js";import{B as k}from"./Badge.bfe12ada.js";import{S as T}from"./Switch.411cd684.js";import"./index.5672de35.js";import"./Serializer.f6a5f515.js";import"./useFocusableGroup.6d334b5b.js";class z{static async refreshProgram(e,s){try{const r=await fetch(`${this.baseUrl}/programs/${e}/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({index:s})});if(!r.ok){const e=await r.text();throw new Error(`HTTP ${r.status}: ${e||r.statusText}`)}return await r.json()}catch(r){throw r}}static async refreshAllPrograms(e){try{const s=await fetch(`${this.baseUrl}/programs/${e}/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});if(!s.ok){const e=await s.text();throw new Error(`HTTP ${s.status}: ${e||s.statusText}`)}return await s.json()}catch(s){throw s}}static async saveRefreshedPrograms(e,s){try{const r=await fetch(`${this.baseUrl}/programs/${e}/save-refreshed`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:s})});if(!r.ok){const e=await r.text();throw new Error(`HTTP ${r.status}: ${e||r.statusText}`)}return await r.json()}catch(r){throw r}}}s=`${l}/api/t3_device`,((e,s,t)=>{s in e?r(e,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[s]=t})(z,"symbol"!=typeof(e="baseUrl")?e+"":e,s);var E="_container_7f643_35",P="_bladeContentContainer_7f643_59",W="_bladeContentWrapper_7f643_75",$="_bladeContent_7f643_59",D="_partContent_7f643_107",H="_toolbar_7f643_125",L="_toolbarContainer_7f643_143",R="_toolbarButton_7f643_159",B="_toolbarSeparator_7f643_237",F="_searchInputWrapper_7f643_253",O="_searchIcon_7f643_267",A="_searchInput_7f643_253",M="_overviewHr_7f643_387",U="_dockingBody_7f643_403",V="_scrollContainer_7f643_421",J="_noData_7f643_443",K="_loadingBar_7f643_461",Z="_editableCell_7f643_769",G="_editInput_7f643_797",Y="_refreshIconButton_7f643_931",q="_isRefreshing_7f643_1001",Q="_rotating_7f643_1041";const X=()=>{const{selectedDevice:e,treeData:s,selectDevice:r,getNextDevice:X,getFilteredDevices:ee}=o(),[se,re]=a.exports.useState([]),[te,ae]=a.exports.useState(!1),[le,oe]=a.exports.useState(null),[ie,ne]=a.exports.useState(!1),[ce,pe]=a.exports.useState(new Set),[de,xe]=a.exports.useState(!1),me=a.exports.useRef(null),[ue,he]=a.exports.useState(!1),ge=a.exports.useRef(!1);a.exports.useEffect((()=>{if(!e&&s.length>0){const e=ee();e.length>0&&r(e[0])}}),[e,s,r,ee]);const fe=a.exports.useCallback((async()=>{if(e){ae(!0),oe(null);try{const s=`${l}/api/t3_device/devices/${e.serialNumber}/programs`,r=await fetch(s);if(!r.ok)throw new Error(`Failed to fetch programs: ${r.statusText}`);const t=await r.json();re(t.programs||[])}catch(s){const e=s instanceof Error?s.message:"Failed to load programs";oe(e)}finally{ae(!1)}}else re([])}),[e]);a.exports.useEffect((()=>{fe()}),[fe]),a.exports.useEffect((()=>{if(te||!e||de)return;const s=setTimeout((async()=>{try{const s=await z.refreshAllPrograms(e.serialNumber);s.items&&s.items.length>0&&(await z.saveRefreshedPrograms(e.serialNumber,s.items),await fe()),xe(!0)}catch(s){xe(!0)}}),500);return()=>clearTimeout(s)}),[te,e,de,fe]);const je=a.exports.useCallback((async()=>{const e=X();e&&(he(!0),r(e),setTimeout((()=>he(!1)),500))}),[X,r]),be=a.exports.useCallback((e=>{if(ue||te)return;const s=e.currentTarget;s.scrollHeight-s.scrollTop-s.clientHeight<=1&&se.length>0?ge.current=!0:ge.current=!1}),[ue,te,se.length]),ye=a.exports.useCallback((e=>{ue||te||0===se.length||e.deltaY>0&&ge.current&&(ge.current=!1,je())}),[ue,te,se.length,je]);a.exports.useEffect((()=>{e&&me.current&&me.current.scrollTo({top:0,behavior:ue?"smooth":"auto"})}),[e,ue]);const ve=(e,s,r)=>{Ie({serialNumber:e.serialNumber,programId:e.programId||"",field:s}),Te(r||"")},Ce=async()=>{if(Se&&ke.trim()){Ee(!0);try{re((e=>e.map((e=>e.serialNumber===Se.serialNumber&&e.programId===Se.programId?{...e,[Se.field]:ke}:e)))),Ie(null)}catch(e){}finally{Ee(!1)}}else Ie(null)},_e=e=>{"Enter"===e.key?(e.preventDefault(),Ce()):"Escape"===e.key&&(e.preventDefault(),Ie(null),Te(""))},[we,Ne]=a.exports.useState(""),[Se,Ie]=a.exports.useState(null),[ke,Te]=a.exports.useState(""),[ze,Ee]=a.exports.useState(!1),[Pe,We]=a.exports.useState(null),[$e,De]=a.exports.useState("ascending"),He=e=>{Pe===e?De("ascending"===$e?"descending":"ascending"):(We(e),De("ascending"))},Le=[y({columnId:"program",renderHeaderCell:()=>t.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>He("program"),children:[t.exports.jsx("span",{children:"Program"}),"program"===Pe?"ascending"===$e?t.exports.jsx(f,{}):t.exports.jsx(j,{}):t.exports.jsx(b,{style:{opacity:.5}})]}),renderCell:s=>{const r=s.programId||"",a=ce.has(r);return t.exports.jsx(I,{children:t.exports.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[t.exports.jsx("button",{onClick:s=>{s.stopPropagation(),(async s=>{if(!e)return;const r=parseInt(s,10);if(!isNaN(r)){pe((e=>new Set(e).add(s)));try{const t=await z.refreshProgram(e.serialNumber,r);t.items&&t.items.length>0&&await z.saveRefreshedPrograms(e.serialNumber,t.items),await fe()}catch(t){}finally{pe((e=>{const r=new Set(e);return r.delete(s),r}))}}})(r)},className:`${Y} ${a?q:""}`,title:"Refresh this program from device",disabled:a,children:t.exports.jsx(c,{style:{fontSize:"14px"},className:a?Q:""})}),t.exports.jsx(n,{size:200,weight:"regular",children:s.programId||"---"})]})})}}),y({columnId:"fullLabel",renderHeaderCell:()=>t.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>He("fullLabel"),children:[t.exports.jsx("span",{children:"Full Label"}),"fullLabel"===Pe?"ascending"===$e?t.exports.jsx(f,{}):t.exports.jsx(j,{}):t.exports.jsx(b,{style:{opacity:.5}})]}),renderCell:e=>{const s=(null==Se?void 0:Se.serialNumber)===e.serialNumber&&(null==Se?void 0:Se.programId)===e.programId&&"programLabel"===(null==Se?void 0:Se.field);return t.exports.jsx(I,{children:s?t.exports.jsx("input",{type:"text",className:G,value:ke,onChange:e=>Te(e.target.value),onBlur:Ce,onKeyDown:_e,autoFocus:!0,disabled:ze,placeholder:"Enter full label","aria-label":"Edit full label"}):t.exports.jsx("div",{className:Z,onDoubleClick:()=>ve(e,"programLabel",e.programLabel||""),title:"Double-click to edit",children:t.exports.jsx(n,{size:200,weight:"regular",children:e.programLabel||"Unnamed"})})})}}),y({columnId:"status",renderHeaderCell:()=>t.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>He("status"),children:[t.exports.jsx("span",{children:"Status"}),"status"===Pe?"ascending"===$e?t.exports.jsx(f,{}):t.exports.jsx(j,{}):t.exports.jsx(b,{style:{opacity:.5}})]}),renderCell:e=>{var s;const r="on"===(null==(s=e.programStatus)?void 0:s.toLowerCase())||"1"===e.programStatus;return t.exports.jsx(I,{children:t.exports.jsx(k,{appearance:"filled",color:r?"success":"warning",style:{cursor:"pointer"},onClick:()=>{const s=r?"OFF":"ON";re((r=>r.map((r=>r.serialNumber===e.serialNumber&&r.programId===e.programId?{...r,programStatus:s}:r))))},children:r?"ON":"OFF"})})}}),y({columnId:"autoManual",renderHeaderCell:()=>t.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:t.exports.jsx("span",{children:"Auto/Manual"})}),renderCell:e=>{var s;const r=null==(s=e.autoManual)?void 0:s.toString().toLowerCase(),a="auto"===r||"1"===r;return t.exports.jsx(I,{children:t.exports.jsx("div",{onClick:()=>{const s=a?"Manual":"Auto";re((r=>r.map((r=>r.serialNumber===e.serialNumber&&r.programId===e.programId?{...r,autoManual:s}:r))))},style:{cursor:"pointer",display:"flex",alignItems:"center"},children:t.exports.jsx(T,{checked:a,style:{transform:"scale(0.8)"}})})})}}),y({columnId:"size",renderHeaderCell:()=>t.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>He("size"),children:[t.exports.jsx("span",{children:"Size"}),"size"===Pe?"ascending"===$e?t.exports.jsx(f,{}):t.exports.jsx(j,{}):t.exports.jsx(b,{style:{opacity:.5}})]}),renderCell:e=>t.exports.jsx(I,{children:e.programSize||"0"})}),y({columnId:"executionTime",renderHeaderCell:()=>t.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:t.exports.jsx("span",{children:"Execution Time"})}),renderCell:e=>t.exports.jsx(I,{children:e.programPointer||"---"})}),y({columnId:"label",renderHeaderCell:()=>t.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>He("label"),children:[t.exports.jsx("span",{children:"Label"}),"label"===Pe?"ascending"===$e?t.exports.jsx(f,{}):t.exports.jsx(j,{}):t.exports.jsx(b,{style:{opacity:.5}})]}),renderCell:e=>{const s=(null==Se?void 0:Se.serialNumber)===e.serialNumber&&(null==Se?void 0:Se.programId)===e.programId&&"programList"===(null==Se?void 0:Se.field);return t.exports.jsx(I,{children:s?t.exports.jsx("input",{type:"text",className:G,value:ke,onChange:e=>Te(e.target.value),onBlur:Ce,onKeyDown:_e,autoFocus:!0,disabled:ze,placeholder:"Enter label","aria-label":"Edit label"}):t.exports.jsx("div",{className:Z,onDoubleClick:()=>ve(e,"programList",e.programList||""),title:"Double-click to edit",children:t.exports.jsx(n,{size:200,weight:"regular",children:e.programList||"---"})})})}})];return t.exports.jsx("div",{className:E,children:t.exports.jsx("div",{className:P,children:t.exports.jsx("div",{className:W,children:t.exports.jsx("div",{className:$,children:t.exports.jsxs("div",{className:D,children:[le&&t.exports.jsxs("div",{style:{marginBottom:"12px",padding:"8px 12px",backgroundColor:"#fef6f6",borderRadius:"4px",display:"flex",alignItems:"center",gap:"8px"},children:[t.exports.jsx(i,{style:{color:"#d13438",fontSize:"16px",flexShrink:0}}),t.exports.jsx(n,{style:{color:"#d13438",fontWeight:500,fontSize:"13px"},children:le})]}),e&&t.exports.jsx("div",{className:H,children:t.exports.jsxs("div",{className:L,children:[t.exports.jsxs("button",{className:R,onClick:async()=>{if(e){ne(!0);try{const s=await z.refreshAllPrograms(e.serialNumber);if(s.items&&s.items.length>0){await z.saveRefreshedPrograms(e.serialNumber,s.items);await fe()}}catch(s){oe(s instanceof Error?s.message:"Failed to refresh from device")}finally{ne(!1)}}},disabled:ie,title:"Refresh all programs from device","aria-label":"Refresh from Device",children:[t.exports.jsx(c,{}),t.exports.jsx("span",{children:ie?"Refreshing...":"Refresh from Device"})]}),t.exports.jsxs("button",{className:R,onClick:()=>{},title:"Export to CSV","aria-label":"Export to CSV",children:[t.exports.jsx(p,{}),t.exports.jsx("span",{children:"Export to CSV"})]}),t.exports.jsx("div",{className:B,role:"separator"}),t.exports.jsxs("button",{className:R,onClick:()=>{},title:"Settings","aria-label":"Settings",children:[t.exports.jsx(d,{}),t.exports.jsx("span",{children:"Settings"})]}),t.exports.jsxs("div",{className:F,children:[t.exports.jsx(x,{className:O}),t.exports.jsx("input",{className:A,type:"text",placeholder:"Search programs...",value:we,onChange:e=>{Ne(e.target.value)},spellCheck:"false",role:"searchbox","aria-label":"Search programs"})]}),t.exports.jsx(m,{content:`Showing program points for ${e.nameShowOnTree} (SN: ${e.serialNumber}). This table displays all configured program logic including execution status, size, and control settings.`,relationship:"description",children:t.exports.jsx("button",{className:R,style:{marginLeft:"8px"},title:"Information","aria-label":"Information about this page",children:t.exports.jsx(u,{})})})]})}),t.exports.jsx("div",{style:{padding:"0"},children:t.exports.jsx("hr",{className:M})}),t.exports.jsxs("div",{className:U,children:[te&&0===se.length&&t.exports.jsxs("div",{className:K,children:[t.exports.jsx(h,{size:"tiny"}),t.exports.jsx(n,{size:200,weight:"regular",children:"Loading programs..."})]}),!e&&!te&&t.exports.jsx("div",{className:J,children:t.exports.jsxs("div",{style:{textAlign:"center"},children:[t.exports.jsx(n,{size:500,weight:"semibold",children:"No device selected"}),t.exports.jsx("br",{}),t.exports.jsx(n,{size:300,children:"Please select a device from the tree to view programs"})]})}),e&&!te&&t.exports.jsxs("div",{ref:me,className:V,onScroll:be,onWheel:ye,children:[t.exports.jsxs(v,{items:se,columns:Le,sortable:!0,resizableColumns:!0,columnSizingOptions:{program:{minWidth:80,defaultWidth:100},fullLabel:{minWidth:150,defaultWidth:200},status:{minWidth:80,defaultWidth:100},autoManual:{minWidth:100,defaultWidth:120},size:{minWidth:60,defaultWidth:80},executionTime:{minWidth:100,defaultWidth:130},label:{minWidth:100,defaultWidth:150}},children:[t.exports.jsx(C,{children:t.exports.jsx(_,{children:({renderHeaderCell:e})=>t.exports.jsx(w,{children:e()})})}),t.exports.jsx(N,{children:({item:e,rowId:s})=>t.exports.jsx(_,{children:({renderCell:s})=>t.exports.jsx(S,{children:s(e)})},s)})]}),0===se.length&&t.exports.jsxs("div",{style:{marginTop:"24px",textAlign:"center",padding:"0 20px"},children:[t.exports.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",marginBottom:"8px"},children:[t.exports.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",style:{opacity:.5},children:t.exports.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4ZM10 8V16H14V8H10Z",fill:"currentColor"})}),t.exports.jsx(n,{size:400,weight:"semibold",children:"No programs found"})]}),t.exports.jsx(n,{size:300,style:{display:"block",marginBottom:"16px",color:"#605e5c",textAlign:"center"},children:"This device has no programs configured"}),t.exports.jsx(g,{appearance:"subtle",icon:t.exports.jsx(c,{}),onClick:async()=>{ne(!0),await fe(),ne(!1)},style:{minWidth:"120px",fontWeight:"normal"},children:"Refresh"})]})]}),"              "]})]})})})})})};export{X as ProgramsPage,X as default};

import{j as e}from"./react.8639cc86.js";import{r,R as s}from"./client.58f92968.js";import{a0 as t,a1 as o,a2 as l,B as a,a3 as i,T as n,a4 as p,aF as d,aG as x,aH as c,Y as m,aI as g,aJ as u,l as h,M as f,n as j,y,N as b,z as v,P as C,Q as S,I as _,R as N,U as k,V as I,X as z,$ as w,Z as P,aK as F}from"./App.7c34790a.js";import{F as L}from"./index.2cf43efd.js";import{c as D,D as E,a as H,b as R,d as T,e as W,f as M}from"./DataGridHeaderCell.ec45a911.js";import{T as B}from"./TableCellLayout.d4b0b796.js";import"./index.3bd6c859.js";import"./Serializer.f6a5f515.js";import"./axios.65f6a2c9.js";import"./T3Data.63f93fe7.js";import"./_commonjsHelpers.a5007c1f.js";const O=({open:s,onOpenChange:h,selectedProgram:f})=>{const[j,y]=r.exports.useState("10 SET = TEMP\n20 REM IF CNT < 10 THEN CNT = CNT + 1 ELSE CNT = 0\n30 V3 = FFFFF\n"),[b,v]=r.exports.useState("Ready. Use buttons above to compile, save, or load program code."),C=(null==f?void 0:f.programSize)?parseInt(f.programSize):0,S=2e3-C;return e.exports.jsxs(t,{type:"overlay",separator:!0,open:s,onOpenChange:(e,{open:r})=>h(r),position:"end",style:{width:"700px"},children:[e.exports.jsx(o,{style:{minHeight:"40px",padding:"8px 16px"},children:e.exports.jsx(l,{action:e.exports.jsx(a,{appearance:"subtle","aria-label":"Close",icon:e.exports.jsx(i,{}),onClick:()=>h(!1)}),children:e.exports.jsxs(n,{size:300,weight:"semibold",children:["Bacnet Program IDE - Program ",(null==f?void 0:f.programId)||""]})})}),e.exports.jsx(p,{style:{padding:0,display:"flex",flexDirection:"column",height:"100%"},children:f&&e.exports.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",gap:"8px",padding:"8px"},children:[e.exports.jsxs("div",{style:{display:"flex",gap:"8px",padding:"8px",borderBottom:"1px solid #e1dfdd"},children:[e.exports.jsx(a,{appearance:"primary",icon:e.exports.jsx(d,{style:{fontSize:"16px"}}),size:"small",title:"Send (F2) - Compile and send to device",onClick:()=>{v("Compiling program...\nSending to device...")},children:"Send (F2)"}),e.exports.jsx(a,{appearance:"secondary",icon:e.exports.jsx(x,{style:{fontSize:"16px"}}),size:"small",title:"Clear (F3) - Clear the editor",onClick:()=>{y(""),v("Editor cleared.")},children:"Clear (F3)"}),e.exports.jsx(a,{appearance:"secondary",icon:e.exports.jsx(c,{style:{fontSize:"16px"}}),size:"small",title:"Load File (F7) - Load from file",onClick:()=>{v("Load file functionality will be implemented.")},children:"Load (F7)"}),e.exports.jsx(a,{appearance:"secondary",icon:e.exports.jsx(m,{style:{fontSize:"16px"}}),size:"small",title:"Save File (F6) - Save to file",onClick:()=>{v("Save file functionality will be implemented.")},children:"Save (F6)"}),e.exports.jsx(a,{appearance:"secondary",icon:e.exports.jsx(g,{style:{fontSize:"16px"}}),size:"small",title:"Refresh (F8) - Refresh from device",onClick:()=>{v("Refreshing program from device...")},children:"Refresh (F8)"}),e.exports.jsx("div",{style:{flex:1}}),e.exports.jsx(a,{appearance:"secondary",icon:e.exports.jsx(u,{style:{fontSize:"16px"}}),size:"small",title:"Help - Programming help",onClick:()=>{v("Programming Help:\n- Use F2 to send\n- Use F3 to clear\n- Use F6 to save\n- Use F7 to load\n- Use F8 to refresh")},children:"Help"})]}),e.exports.jsx("div",{style:{flex:"1 1 60%",minHeight:"300px",display:"flex",flexDirection:"column",border:"1px solid #d1d1d1",borderRadius:"4px",overflow:"hidden",backgroundColor:"#f8f8f8"},children:e.exports.jsx(L,{height:"100%",defaultLanguage:"vb",value:j,onChange:e=>y(e||""),theme:"vs",options:{minimap:{enabled:!1},fontSize:11,lineHeight:18,fontFamily:'Consolas, "Courier New", monospace',scrollBeyondLastLine:!1,automaticLayout:!0,wordWrap:"on",wrappingIndent:"same",lineNumbers:"on",glyphMargin:!1,folding:!1,lineDecorationsWidth:10,lineNumbersMinChars:3,renderLineHighlight:"all",scrollbar:{vertical:"visible",horizontal:"hidden",verticalScrollbarSize:6,horizontalScrollbarSize:6}}})}),e.exports.jsxs("div",{style:{flex:"0 0 auto",display:"flex",gap:"8px",minHeight:"150px"},children:[e.exports.jsxs("div",{style:{flex:"1 1 60%",display:"flex",flexDirection:"column"},children:[e.exports.jsx(n,{size:200,weight:"semibold",style:{marginBottom:"4px"},children:"Information Window"}),e.exports.jsx("div",{style:{flex:1,border:"1px solid #d1d1d1",borderRadius:"4px",padding:"8px",backgroundColor:"#fafafa",fontFamily:'Consolas, "Courier New", monospace',fontSize:"12px",overflowY:"auto",minHeight:"120px",whiteSpace:"pre-wrap"},children:e.exports.jsx(n,{size:100,style:{color:"#605e5c"},children:b})})]}),e.exports.jsxs("div",{style:{flex:"0 0 200px",display:"flex",flexDirection:"column"},children:[e.exports.jsx(n,{size:200,weight:"semibold",style:{marginBottom:"4px"},children:"Memory Statistics"}),e.exports.jsxs("div",{style:{flex:1,border:"1px solid #d1d1d1",borderRadius:"4px",padding:"12px",backgroundColor:"#f5f5f5",display:"flex",flexDirection:"column",gap:"12px"},children:[e.exports.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.exports.jsx(n,{size:200,children:"Programs pool size:"}),e.exports.jsx(n,{size:200,weight:"semibold",style:{color:"#d13438"},children:2e3})]}),e.exports.jsx("div",{style:{height:"1px",backgroundColor:"#e1dfdd"}}),e.exports.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.exports.jsx(n,{size:200,children:"Programs size:"}),e.exports.jsx(n,{size:200,weight:"semibold",style:{color:"#d13438"},children:C})]}),e.exports.jsx("div",{style:{height:"1px",backgroundColor:"#e1dfdd"}}),e.exports.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.exports.jsx(n,{size:200,children:"Free memory:"}),e.exports.jsx(n,{size:200,weight:"semibold",style:{color:"#d13438"},children:S})]}),e.exports.jsx("div",{style:{marginTop:"auto",paddingTop:"8px"},children:e.exports.jsx(n,{size:100,style:{color:"#605e5c"},children:"Bytes"})})]})]})]})]})})]})};var A="_container_1ks78_18",$="_bladeContentContainer_1ks78_30",U="_bladeContentWrapper_1ks78_38",V="_bladeContent_1ks78_30",K="_partContent_1ks78_54",Y="_toolbar_1ks78_63",G="_toolbarContainer_1ks78_72",q="_toolbarButton_1ks78_80",J="_toolbarSeparator_1ks78_119",Q="_searchInputWrapper_1ks78_127",X="_searchIcon_1ks78_134",Z="_searchInput_1ks78_127",ee="_overviewHr_1ks78_194",re="_dockingBody_1ks78_202",se="_scrollContainer_1ks78_211",te="_noData_1ks78_235",oe="_loadingBar_1ks78_244",le="_editableCell_1ks78_421",ae="_editInput_1ks78_435",ie="_refreshIconButton_1ks78_502",ne="_isRefreshing_1ks78_537",pe="_rotating_1ks78_557";const de=()=>{const{selectedDevice:t,treeData:o,selectDevice:l,getNextDevice:i,getFilteredDevices:p}=h(),[d,x]=r.exports.useState([]),[c,m]=r.exports.useState(!1),[g,u]=r.exports.useState(null),[L,de]=r.exports.useState(!1),[xe,ce]=r.exports.useState(new Set),[me,ge]=r.exports.useState(!1),ue=r.exports.useRef(!1),[he,fe]=r.exports.useState(!1),[je,ye]=r.exports.useState(null),be=r.exports.useRef(null),[ve,Ce]=r.exports.useState(!1),Se=r.exports.useRef(!1);r.exports.useEffect((()=>{if(!t&&o.length>0){const e=p();e.length>0&&l(e[0])}}),[t,o,l,p]);const _e=r.exports.useCallback((async()=>{if(t){m(!0),u(null);try{const e=`${f}/api/t3_device/devices/${t.serialNumber}/programs`,r=await fetch(e);if(!r.ok)throw new Error(`Failed to fetch programs: ${r.statusText}`);const s=await r.json();x(s.programs||[])}catch(e){const r=e instanceof Error?e.message:"Failed to load programs";u(r),console.error("Error fetching programs:",e)}finally{m(!1)}}else x([])}),[t]);r.exports.useEffect((()=>{_e()}),[_e]),r.exports.useEffect((()=>{x([]),ge(!1),ue.current=!1}),[null==t?void 0:t.serialNumber]),r.exports.useEffect((()=>{if(c||!t||me||ue.current)return;(async()=>{ue.current=!0;try{if(d.length>0)return console.log("[ProgramsPage] Database has data, skipping auto-refresh"),void ge(!0);console.log("[ProgramsPage] Database empty, auto-refreshing from device...");const e=await N.refreshAllPrograms(t.serialNumber);console.log("[ProgramsPage] Auto-refresh result:",e),await _e(),ge(!0)}catch(e){console.error("[ProgramsPage] Auto-refresh failed:",e),ge(!0)}})()}),[c,t,me,_e,d.length]);const Ne=r.exports.useCallback((async()=>{const e=i();e&&(Ce(!0),l(e),setTimeout((()=>Ce(!1)),500))}),[i,l]),ke=r.exports.useCallback((e=>{if(ve||c)return;const r=e.currentTarget;r.scrollHeight-r.scrollTop-r.clientHeight<=1&&d.length>0?Se.current=!0:Se.current=!1}),[ve,c,d.length]),Ie=r.exports.useCallback((e=>{ve||c||0===d.length||e.deltaY>0&&Se.current&&(Se.current=!1,Ne())}),[ve,c,d.length,Ne]);r.exports.useEffect((()=>{t&&be.current&&be.current.scrollTo({top:0,behavior:ve?"smooth":"auto"})}),[t,ve]);const ze=(e,r,s)=>{Ee({serialNumber:e.serialNumber,programId:e.programId||"",field:r}),Re(s||"")},we=async()=>{if(De&&He.trim()){We(!0);try{x((e=>e.map((e=>e.serialNumber===De.serialNumber&&e.programId===De.programId?{...e,[De.field]:He}:e)))),console.log("Updated",De.field,":",He,"for",De),Ee(null)}catch(e){console.error("Failed to update:",e)}finally{We(!1)}}else Ee(null)},Pe=e=>{"Enter"===e.key?(e.preventDefault(),we()):"Escape"===e.key&&(e.preventDefault(),Ee(null),Re(""))},[Fe,Le]=r.exports.useState(""),[De,Ee]=r.exports.useState(null),[He,Re]=r.exports.useState(""),[Te,We]=r.exports.useState(!1),[Me,Be]=r.exports.useState(null),[Oe,Ae]=r.exports.useState("ascending"),$e=e=>{Me===e?Ae("ascending"===Oe?"descending":"ascending"):(Be(e),Ae("ascending"))},Ue=r.exports.useCallback((e=>{e.programId&&(ye(e),fe(!0),console.log("ðŸ“ [ProgramsPage] Opening programming for program:",e.programId))}),[]),Ve=s.useMemo((()=>0===d.length?Array(10).fill(null).map(((e,r)=>({serialNumber:(null==t?void 0:t.serialNumber)||0,programId:"",switchNode:"",programLabel:"",programList:"",programSize:"",programPointer:"",programStatus:"",autoManual:""}))):d),[d,t]),Ke=e=>!e.programId&&0===d.length,Ye=[D({columnId:"program",renderHeaderCell:()=>e.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>$e("program"),children:[e.exports.jsx("span",{children:"Program"}),"program"===Me?"ascending"===Oe?e.exports.jsx(k,{}):e.exports.jsx(I,{}):e.exports.jsx(z,{style:{opacity:.5}})]}),renderCell:r=>{if(Ke(r))return e.exports.jsx(B,{});const s=r.programId||"",o=xe.has(s);return e.exports.jsx(B,{children:e.exports.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[e.exports.jsx("button",{onClick:e=>{e.stopPropagation(),(async e=>{if(!t)return;const r=parseInt(e,10);if(isNaN(r))console.error("[ProgramsPage] Invalid program index:",e);else{ce((r=>new Set(r).add(e)));try{console.log(`[ProgramsPage] Refreshing program ${r} from device...`);const s=await N.refreshSingleProgram(t.serialNumber,r);console.log("[ProgramsPage] Refresh result:",s),await _e()}catch(s){console.error(`[ProgramsPage] Failed to refresh program ${r}:`,s)}finally{ce((r=>{const s=new Set(r);return s.delete(e),s}))}}})(s)},className:`${ie} ${o?ne:""}`,title:"Refresh this program from device",disabled:o,children:e.exports.jsx(y,{style:{fontSize:"14px"},className:o?pe:""})}),e.exports.jsx(n,{size:200,weight:"regular",children:r.programId||"---"})]})})}}),D({columnId:"fullLabel",renderHeaderCell:()=>e.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>$e("fullLabel"),children:[e.exports.jsx("span",{children:"Full Label"}),"fullLabel"===Me?"ascending"===Oe?e.exports.jsx(k,{}):e.exports.jsx(I,{}):e.exports.jsx(z,{style:{opacity:.5}})]}),renderCell:r=>{var s;if(Ke(r))return e.exports.jsx(B,{});const t=(null==De?void 0:De.serialNumber)===r.serialNumber&&(null==De?void 0:De.programId)===r.programId&&"programLabel"===(null==De?void 0:De.field);return e.exports.jsx(B,{children:t?e.exports.jsx("input",{type:"text",className:ae,value:He,onChange:e=>Re(e.target.value),onBlur:we,onKeyDown:Pe,autoFocus:!0,disabled:Te,placeholder:"Enter full label","aria-label":"Edit full label"}):e.exports.jsx("div",{className:le,onDoubleClick:()=>{var e;return ze(r,"programLabel",null!=(e=r.programLabel)?e:"")},title:"Double-click to edit",children:e.exports.jsx(n,{size:200,weight:"regular",children:null!=(s=r.programLabel)?s:""})})})}}),D({columnId:"status",renderHeaderCell:()=>e.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>$e("status"),children:[e.exports.jsx("span",{children:"Status"}),"status"===Me?"ascending"===Oe?e.exports.jsx(k,{}):e.exports.jsx(I,{}):e.exports.jsx(z,{style:{opacity:.5}})]}),renderCell:r=>{var s;if(Ke(r))return e.exports.jsx(B,{});const t="on"===(null==(s=r.programStatus)?void 0:s.toLowerCase())||"1"===r.programStatus;return e.exports.jsx(B,{children:e.exports.jsx(w,{appearance:"filled",color:t?"success":"warning",style:{cursor:"pointer"},onClick:()=>{const e=t?"OFF":"ON";console.log("Status toggled:",r.serialNumber,r.programId,e),x((s=>s.map((s=>s.serialNumber===r.serialNumber&&s.programId===r.programId?{...s,programStatus:e}:s))))},children:t?"ON":"OFF"})})}}),D({columnId:"autoManual",renderHeaderCell:()=>e.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:e.exports.jsx("span",{children:"Auto/Manual"})}),renderCell:r=>{var s;if(Ke(r))return e.exports.jsx(B,{});const t=null==(s=r.autoManual)?void 0:s.toString().toLowerCase(),o="auto"===t||"1"===t;return e.exports.jsx(B,{children:e.exports.jsx("div",{onClick:()=>{const e=o?"Manual":"Auto";console.log("Auto/Man toggled:",r.serialNumber,r.programId,e),x((s=>s.map((s=>s.serialNumber===r.serialNumber&&s.programId===r.programId?{...s,autoManual:e}:s))))},style:{cursor:"pointer",display:"flex",alignItems:"center"},children:e.exports.jsx(P,{checked:o,style:{transform:"scale(0.8)"}})})})}}),D({columnId:"size",renderHeaderCell:()=>e.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>$e("size"),children:[e.exports.jsx("span",{children:"Size"}),"size"===Me?"ascending"===Oe?e.exports.jsx(k,{}):e.exports.jsx(I,{}):e.exports.jsx(z,{style:{opacity:.5}})]}),renderCell:r=>e.exports.jsx(B,{children:!Ke(r)&&(r.programSize||"0")})}),D({columnId:"executionTime",renderHeaderCell:()=>e.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:e.exports.jsx("span",{children:"Execution Time"})}),renderCell:r=>e.exports.jsx(B,{children:!Ke(r)&&(r.programPointer||"---")})}),D({columnId:"label",renderHeaderCell:()=>e.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>$e("label"),children:[e.exports.jsx("span",{children:"Label"}),"label"===Me?"ascending"===Oe?e.exports.jsx(k,{}):e.exports.jsx(I,{}):e.exports.jsx(z,{style:{opacity:.5}})]}),renderCell:r=>{if(Ke(r))return e.exports.jsx(B,{});const s=(null==De?void 0:De.serialNumber)===r.serialNumber&&(null==De?void 0:De.programId)===r.programId&&"programList"===(null==De?void 0:De.field);return e.exports.jsx(B,{children:s?e.exports.jsx("input",{type:"text",className:ae,value:He,onChange:e=>Re(e.target.value),onBlur:we,onKeyDown:Pe,autoFocus:!0,disabled:Te,placeholder:"Enter label","aria-label":"Edit label"}):e.exports.jsx("div",{className:le,onDoubleClick:()=>ze(r,"programList",r.programList||""),title:"Double-click to edit",children:e.exports.jsx(n,{size:200,weight:"regular",children:r.programList||"---"})})})}}),D({columnId:"programming",renderHeaderCell:()=>e.exports.jsx("span",{children:"Programming"}),renderCell:r=>Ke(r)?e.exports.jsx(B,{}):e.exports.jsx(B,{children:e.exports.jsx(a,{size:"small",appearance:"subtle",icon:e.exports.jsx(F,{}),onClick:e=>{e.stopPropagation(),Ue(r)},title:"Open programming editor",children:"Edit"})})})];return e.exports.jsxs("div",{className:A,children:[e.exports.jsx("div",{className:$,children:e.exports.jsx("div",{className:U,children:e.exports.jsx("div",{className:V,children:e.exports.jsxs("div",{className:K,children:[g&&e.exports.jsxs("div",{style:{marginBottom:"12px",padding:"8px 12px",backgroundColor:"#fef6f6",borderRadius:"4px",display:"flex",alignItems:"center",gap:"8px"},children:[e.exports.jsx(j,{style:{color:"#d13438",fontSize:"16px",flexShrink:0}}),e.exports.jsx(n,{style:{color:"#d13438",fontWeight:500,fontSize:"13px"},children:g})]}),t&&e.exports.jsxs(e.exports.Fragment,{children:[e.exports.jsx("div",{className:Y,children:e.exports.jsxs("div",{className:G,children:[e.exports.jsxs("button",{className:q,onClick:async()=>{if(t){de(!0);try{console.log("[ProgramsPage] Refreshing all programs from device...");const e=await N.refreshAllPrograms(t.serialNumber);console.log("[ProgramsPage] Refresh result:",e),await _e()}catch(e){console.error("[ProgramsPage] Failed to refresh from device:",e),u(e instanceof Error?e.message:"Failed to refresh from device")}finally{de(!1)}}},disabled:L,title:"Refresh all programs from device","aria-label":"Refresh from Device",children:[e.exports.jsx(y,{}),e.exports.jsx("span",{children:L?"Refreshing...":"Refresh from Device"})]}),e.exports.jsxs("button",{className:q,onClick:()=>{console.log("Export programs to CSV")},title:"Export to CSV","aria-label":"Export to CSV",children:[e.exports.jsx(b,{}),e.exports.jsx("span",{children:"Export to CSV"})]}),e.exports.jsx("div",{className:J,role:"separator"}),e.exports.jsxs("button",{className:q,onClick:()=>{console.log("Settings clicked")},title:"Settings","aria-label":"Settings",children:[e.exports.jsx(v,{}),e.exports.jsx("span",{children:"Settings"})]}),e.exports.jsxs("div",{className:Q,children:[e.exports.jsx(C,{className:X}),e.exports.jsx("input",{className:Z,type:"text",placeholder:"Search programs...",value:Fe,onChange:e=>{Le(e.target.value),console.log("Search query:",e.target.value)},spellCheck:"false",role:"searchbox","aria-label":"Search programs"})]}),e.exports.jsx(S,{content:`Showing program points for ${t.nameShowOnTree} (SN: ${t.serialNumber}). This table displays all configured program logic including execution status, size, and control settings.`,relationship:"description",children:e.exports.jsx("button",{className:q,style:{marginLeft:"8px"},title:"Information","aria-label":"Information about this page",children:e.exports.jsx(_,{})})})]})}),e.exports.jsx("div",{style:{padding:"0"},children:e.exports.jsx("hr",{className:ee})})]}),e.exports.jsxs("div",{className:re,children:[c&&0===d.length&&e.exports.jsxs("div",{className:oe,children:[e.exports.jsx(y,{}),e.exports.jsx(n,{size:200,weight:"regular",children:"Loading programs..."})]}),!t&&!c&&e.exports.jsx("div",{className:te,children:e.exports.jsxs("div",{style:{textAlign:"center"},children:[e.exports.jsx(n,{size:400,weight:"semibold",children:"No device selected"}),e.exports.jsx("br",{}),e.exports.jsx(n,{size:200,children:"Please select a device from the tree to view programs"})]})}),t&&!c&&e.exports.jsx("div",{ref:be,className:se,onScroll:ke,onWheel:Ie,children:e.exports.jsxs(E,{items:Ve,columns:Ye,sortable:!0,resizableColumns:!0,columnSizingOptions:{program:{minWidth:80,defaultWidth:100},fullLabel:{minWidth:150,defaultWidth:200},status:{minWidth:80,defaultWidth:100},autoManual:{minWidth:100,defaultWidth:120},size:{minWidth:60,defaultWidth:80},executionTime:{minWidth:120,defaultWidth:180},label:{minWidth:130,defaultWidth:200},programming:{minWidth:80,defaultWidth:100}},children:[e.exports.jsx(H,{children:e.exports.jsx(R,{children:({renderHeaderCell:r})=>e.exports.jsx(T,{children:r()})})}),e.exports.jsx(W,{children:({item:r,rowId:s})=>e.exports.jsx(R,{children:({renderCell:s})=>e.exports.jsx(M,{children:s(r)})},s)})]})}),"              "]})]})})})}),e.exports.jsx(O,{open:he,onOpenChange:fe,selectedProgram:je})]})};export{de as ProgramsPage,de as default};

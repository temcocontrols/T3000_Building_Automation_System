import{j as e}from"./react.8639cc86.js";import{r as s,R as r}from"./client.58f92968.js";import{l as t,M as l,n as a,T as o,y as i,N as n,z as d,P as c,Q as x,I as h,S as p,R as u,U as m,V as j,X as _,Z as f}from"./App.7c34790a.js";import{c as g,D as v,a as b,b as C,d as N,e as S,f as y}from"./DataGridHeaderCell.ec45a911.js";import{T as z}from"./TableCellLayout.d4b0b796.js";import"./index.3bd6c859.js";import"./Serializer.f6a5f515.js";import"./axios.65f6a2c9.js";import"./T3Data.63f93fe7.js";import"./_commonjsHelpers.a5007c1f.js";var I="_container_16tmz_11",w="_bladeContentContainer_16tmz_26",k="_bladeContentWrapper_16tmz_34",F="_bladeContent_16tmz_26",T="_partContent_16tmz_50",W="_toolbar_16tmz_64",H="_toolbarContainer_16tmz_73",E="_toolbarButton_16tmz_81",D="_toolbarSeparator_16tmz_120",R="_searchInputWrapper_16tmz_127",A="_searchIcon_16tmz_134",L="_searchInput_16tmz_127",M="_overviewHr_16tmz_193",$="_dockingBody_16tmz_201",P="_scrollContainer_16tmz_209",B="_autoLoadIndicator_16tmz_237",V="_noData_16tmz_249",O="_loadingBar_16tmz_258",U="_refreshIconButton_16tmz_483",G="_rotating_16tmz_529",Q="_headerCellSort_16tmz_534",X="_headerCellWith8Gap_16tmz_541",Y="_headerCell_16tmz_534",Z="_sortIconFaded_16tmz_553",q="_errorNotice_16tmz_557",J="_clearFiltersButton_16tmz_567",K="_noPadding_16tmz_571",ee="_centerText_16tmz_575",se="_iconError_16tmz_597",re="_textError_16tmz_603";const te=()=>{const{selectedDevice:te,treeData:le,selectDevice:ae,getNextDevice:oe,getFilteredDevices:ie}=t(),[ne,de]=s.exports.useState([]),[ce,xe]=s.exports.useState(!1),[he,pe]=s.exports.useState(null),[ue,me]=s.exports.useState(!1),[je,_e]=s.exports.useState(""),[fe,ge]=s.exports.useState("scheduleId"),[ve,be]=s.exports.useState("ascending"),[Ce,Ne]=s.exports.useState(new Set),[Se,ye]=s.exports.useState(!1),ze=s.exports.useRef(!1),Ie=s.exports.useRef(null),[we,ke]=s.exports.useState(!1),Fe=s.exports.useRef(!1);s.exports.useEffect((()=>{if(!te){const e=ie();e.length>0&&ae(e[0])}}),[te,ie,ae]);const Te=s.exports.useCallback((async()=>{if(te){xe(!0),pe(null);try{const e=await fetch(`${l}/api/t3_device/devices/${te.serialNumber}/table/SCHEDULES`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const s=await e.json();console.log("Schedules API response:",s),s.data&&Array.isArray(s.data)?de(s.data):(console.warn("Unexpected response format:",s),de([]))}catch(e){console.error("Error fetching schedules:",e),pe(e instanceof Error?e.message:"Failed to fetch schedules")}finally{xe(!1),me(!1)}}else de([])}),[te]);s.exports.useEffect((()=>{Te()}),[Te]),s.exports.useEffect((()=>{de([]),ye(!1),ze.current=!1}),[null==te?void 0:te.serialNumber]),s.exports.useEffect((()=>{if(ce||!te||Se||ze.current)return;(async()=>{if(ze.current=!0,ne.length>0)return console.log("ðŸ”„ Database has data, skipping auto-refresh"),void ye(!0);console.log("ðŸ”„ Database empty, auto-refreshing schedules from device on page load...");try{const e=te.serialNumber,s=await u.refreshAllSchedules(e);console.log("âœ… Auto-refresh result:",s),await Te(),ye(!0)}catch(e){console.error("âŒ Auto-refresh failed:",e)}})()}),[ce,te,Se,Te,ne.length]);const We=e=>{fe===e?be("ascending"===ve?"descending":"ascending"):(ge(e),be("ascending"))},He=s.exports.useCallback((()=>{const e=oe();e&&(ke(!0),ae(e),setTimeout((()=>{ke(!1)}),500))}),[oe,ae]),Ee=s.exports.useCallback((e=>{if(we||ce)return;const s=e.currentTarget;s.scrollHeight-s.scrollTop-s.clientHeight<=1&&ne.length>0?Fe.current=!0:Fe.current=!1}),[we,ce,ne.length]),De=s.exports.useCallback((e=>{we||ce||0===ne.length||e.deltaY>0&&Fe.current&&(Fe.current=!1,He())}),[we,ce,ne.length,He]);s.exports.useEffect((()=>{te&&Ie.current&&Ie.current.scrollTo({top:0,behavior:we?"smooth":"auto"})}),[te,we]);const Re=r.useMemo((()=>0===ne.length?Array(10).fill(null).map(((e,s)=>({serialNumber:0,scheduleId:"",autoManual:"",outputField:"",variableField:"",holiday1:"",status1:"",holiday2:"",status2:"",intervalField:"",scheduleTime:"",mondayTime:"",tuesdayTime:"",wednesdayTime:"",thursdayTime:"",fridayTime:""}))):ne),[ne]),Ae=e=>!e.scheduleId&&0===ne.length,Le=[g({columnId:"scheduleId",renderHeaderCell:()=>e.exports.jsxs("div",{className:Q,onClick:()=>We("scheduleId"),children:[e.exports.jsx("span",{children:"Schedule"}),"scheduleId"===fe?"ascending"===ve?e.exports.jsx(m,{}):e.exports.jsx(j,{}):e.exports.jsx(_,{className:Z})]}),renderCell:s=>{const r=s.scheduleId&&Ce.has(s.scheduleId);return e.exports.jsx(z,{children:!Ae(s)&&e.exports.jsxs("div",{className:X,children:[e.exports.jsx("button",{className:`${U} ${r?G:""}`,onClick:e=>{e.stopPropagation(),(async e=>{if(!te||!e.scheduleId)return;const s=e.scheduleId;Ne((e=>new Set(e).add(s)));try{const r=te.serialNumber,t=parseInt(e.scheduleId);console.log(`ðŸ”„ Refreshing single schedule from device: ${t}`);const l=await u.refreshSingleSchedule(r,t);console.log("âœ… Single schedule refresh result:",l),await Te()}catch(r){console.error("âŒ Single schedule refresh failed:",r)}finally{Ne((e=>{const r=new Set(e);return r.delete(s),r}))}})(s)},disabled:r,title:"Refresh this schedule from device","aria-label":"Refresh schedule",children:e.exports.jsx(i,{fontSize:16})}),e.exports.jsx("span",{children:s.scheduleId||"---"})]})})}}),g({columnId:"autoManual",renderHeaderCell:()=>e.exports.jsx("div",{className:Y,children:e.exports.jsx("span",{children:"Auto/Man"})}),renderCell:s=>{const r="1"===s.autoManual;return e.exports.jsx(z,{children:!Ae(s)&&e.exports.jsxs("div",{className:X,children:[e.exports.jsx(f,{checked:r,onChange:()=>(async e=>{const s="1"===e.autoManual?"0":"1";de((r=>r.map((r=>r.serialNumber===e.serialNumber&&r.scheduleId===e.scheduleId?{...r,autoManual:s}:r)))),console.log("Toggle Auto/Manual:",e.scheduleId,s)})(s)}),e.exports.jsx(o,{size:200,children:r?"AUTO":"MAN"})]})})}}),g({columnId:"outputField",renderHeaderCell:()=>e.exports.jsxs("div",{className:Q,onClick:()=>We("outputField"),children:[e.exports.jsx("span",{children:"Output"}),"outputField"===fe?"ascending"===ve?e.exports.jsx(m,{}):e.exports.jsx(j,{}):e.exports.jsx(_,{className:Z})]}),renderCell:s=>e.exports.jsx(z,{children:!Ae(s)&&(s.outputField||"---")})}),g({columnId:"variableField",renderHeaderCell:()=>e.exports.jsxs("div",{className:Q,onClick:()=>We("variableField"),children:[e.exports.jsx("span",{children:"Variable"}),"variableField"===fe?"ascending"===ve?e.exports.jsx(m,{}):e.exports.jsx(j,{}):e.exports.jsx(_,{className:Z})]}),renderCell:s=>e.exports.jsx(z,{children:!Ae(s)&&(s.variableField||"---")})}),g({columnId:"holiday1",renderHeaderCell:()=>e.exports.jsxs("div",{className:Q,onClick:()=>We("holiday1"),children:[e.exports.jsx("span",{children:"Holiday1"}),"holiday1"===fe?"ascending"===ve?e.exports.jsx(m,{}):e.exports.jsx(j,{}):e.exports.jsx(_,{className:Z})]}),renderCell:s=>e.exports.jsx(z,{children:!Ae(s)&&(s.holiday1||"---")})}),g({columnId:"status1",renderHeaderCell:()=>e.exports.jsx("div",{className:Y,children:e.exports.jsx("span",{children:"Label"})}),renderCell:s=>e.exports.jsx(z,{children:!Ae(s)&&(s.status1||"---")})}),g({columnId:"holiday2",renderHeaderCell:()=>e.exports.jsxs("div",{className:Q,onClick:()=>We("holiday2"),children:[e.exports.jsx("span",{children:"Holiday2"}),"holiday2"===fe?"ascending"===ve?e.exports.jsx(m,{}):e.exports.jsx(j,{}):e.exports.jsx(_,{className:Z})]}),renderCell:s=>e.exports.jsx(z,{children:!Ae(s)&&(s.holiday2||"---")})}),g({columnId:"status2",renderHeaderCell:()=>e.exports.jsx("div",{className:Y,children:e.exports.jsx("span",{children:"Status"})}),renderCell:s=>e.exports.jsx(z,{children:!Ae(s)&&(s.status2||"---")})})],Me=[...Re.filter((e=>{var s,r,t;return""===je||(null==(s=e.scheduleId)?void 0:s.toLowerCase().includes(je.toLowerCase()))||(null==(r=e.outputField)?void 0:r.toLowerCase().includes(je.toLowerCase()))||(null==(t=e.variableField)?void 0:t.toLowerCase().includes(je.toLowerCase()))}))].sort(((e,s)=>{const r=(e[fe]||"").toString(),t=(s[fe]||"").toString(),l=r.localeCompare(t);return"ascending"===ve?l:-l}));return e.exports.jsx("div",{className:I,children:e.exports.jsx("div",{className:w,children:e.exports.jsx("div",{className:k,children:e.exports.jsx("div",{className:F,children:e.exports.jsxs("div",{className:T,children:[he&&e.exports.jsxs("div",{className:q,children:[e.exports.jsx(a,{className:se}),e.exports.jsx(o,{className:re,children:he})]}),te&&e.exports.jsxs(e.exports.Fragment,{children:[e.exports.jsx("div",{className:W,children:e.exports.jsxs("div",{className:H,children:[e.exports.jsxs("button",{className:E,onClick:async()=>{if(te){me(!0),pe(null);try{const e=te.serialNumber;console.log("ðŸ”„ Refreshing all schedules from device...");const s=await u.refreshAllSchedules(e);console.log("âœ… Device refresh result:",s),await Te()}catch(e){console.error("âŒ Refresh from device failed:",e),pe(e instanceof Error?e.message:"Failed to refresh from device")}finally{me(!1)}}},disabled:ue,title:"Refresh from Device","aria-label":"Refresh from Device",children:[e.exports.jsx(i,{className:ue?G:""}),e.exports.jsx("span",{children:ue?"Refreshing...":"Refresh from Device"})]}),e.exports.jsxs("button",{className:E,onClick:()=>{console.log("Export schedules clicked")},title:"Export to CSV","aria-label":"Export to CSV",children:[e.exports.jsx(n,{}),e.exports.jsx("span",{children:"Export to CSV"})]}),e.exports.jsx("div",{className:D,role:"separator"}),e.exports.jsxs("button",{className:E,onClick:()=>{console.log("Settings clicked")},title:"Settings","aria-label":"Settings",children:[e.exports.jsx(d,{}),e.exports.jsx("span",{children:"Settings"})]}),e.exports.jsxs("div",{className:R,children:[e.exports.jsx(c,{className:A}),e.exports.jsx("input",{className:L,type:"text",placeholder:"Search schedules...",value:je,onChange:e=>{_e(e.target.value)},spellCheck:"false",role:"searchbox","aria-label":"Search schedules"})]}),e.exports.jsx(x,{content:`Showing schedule points for ${te.nameShowOnTree} (SN: ${te.serialNumber}). This table displays all configured weekly routine schedules including holidays, outputs, and status information.`,relationship:"description",children:e.exports.jsx("button",{className:`${E} ${J}`,title:"Information","aria-label":"Information about this page",children:e.exports.jsx(h,{})})})]})}),e.exports.jsx("div",{className:K,children:e.exports.jsx("hr",{className:M})})]}),e.exports.jsxs("div",{className:$,children:[ce&&0===ne.length&&e.exports.jsxs("div",{className:O,children:[e.exports.jsx(p,{size:"tiny"}),e.exports.jsx(o,{size:200,weight:"regular",children:"Loading schedules..."})]}),!te&&!ce&&e.exports.jsx("div",{className:V,children:e.exports.jsxs("div",{className:ee,children:[e.exports.jsx(o,{size:400,weight:"semibold",children:"No device selected"}),e.exports.jsx("br",{}),e.exports.jsx(o,{size:200,children:"Please select a device from the tree to view schedules"})]})}),te&&!ce&&e.exports.jsxs("div",{ref:Ie,className:P,onScroll:Ee,onWheel:De,children:[e.exports.jsxs(v,{items:Me,columns:Le,sortable:!0,resizableColumns:!0,columnSizingOptions:{scheduleId:{minWidth:70,idealWidth:"10%"},autoManual:{minWidth:100,idealWidth:"15%"},outputField:{minWidth:80,idealWidth:"12%"},variableField:{minWidth:80,idealWidth:"12%"},holiday1:{minWidth:80,idealWidth:"15%"},status1:{minWidth:80,idealWidth:"12%"},holiday2:{minWidth:80,idealWidth:"12%"},status2:{minWidth:80,idealWidth:"12%"}},children:[e.exports.jsx(b,{children:e.exports.jsx(C,{children:({renderHeaderCell:s})=>e.exports.jsx(N,{children:s()})})}),e.exports.jsx(S,{children:({item:s,rowId:r})=>e.exports.jsx(C,{children:({renderCell:r})=>e.exports.jsx(y,{children:r(s)})},r)})]}),we&&e.exports.jsxs("div",{className:B,children:[e.exports.jsx(p,{size:"tiny"}),e.exports.jsx(o,{children:"Loading next device..."})]})]})]})]})})})})})};var le=te;export{te as SchedulesPage,le as default};

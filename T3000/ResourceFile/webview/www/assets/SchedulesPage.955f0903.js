var e,s,t=Object.defineProperty;import{j as r}from"./react.2da10d74.js";import{r as l}from"./client.b9d1bbf8.js";import{A as a,w as o,x as i,T as n,y as d,z as c,S as p,C as x,D as h,I as u,F as j,B as m,H as g,J as f,K as y}from"./App.2c62e2d1.js";import{c as v,D as b,a as C,b as _,d as S,e as w,f as I,T as N}from"./DataGridHeaderCell.34491fc4.js";import{S as T}from"./Switch.411cd684.js";import"./index.5672de35.js";import"./Serializer.f6a5f515.js";import"./useFocusableGroup.6d334b5b.js";class k{static async refreshAllSchedules(e){const s=await fetch(`${this.baseUrl}/schedules/${e}/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});if(!s.ok){const e=await s.text();throw new Error(`HTTP ${s.status}: ${e||s.statusText}`)}return await s.json()}static async saveRefreshedSchedules(e,s){const t=await fetch(`${this.baseUrl}/schedules/${e}/save-refreshed`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:s})});if(!t.ok){const e=await t.text();throw new Error(`HTTP ${t.status}: ${e||t.statusText}`)}return await t.json()}}s=`${a}/api/t3_device`,((e,s,r)=>{s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[s]=r})(k,"symbol"!=typeof(e="baseUrl")?e+"":e,s);var H="_container_p2og5_21",W="_bladeContentContainer_p2og5_51",F="_bladeContentWrapper_p2og5_67",$="_bladeContent_p2og5_51",z="_partContent_p2og5_99",E="_toolbar_p2og5_127",R="_toolbarContainer_p2og5_145",A="_toolbarButton_p2og5_161",D="_toolbarSeparator_p2og5_239",L="_searchInputWrapper_p2og5_253",M="_searchIcon_p2og5_267",B="_searchInput_p2og5_253",O="_overviewHr_p2og5_385",P="_dockingBody_p2og5_401",V="_scrollContainer_p2og5_417",U="_autoLoadIndicator_p2og5_433",J="_noData_p2og5_457",Z="_loadingBar_p2og5_475",G="_refreshIconButton_p2og5_925",K="_rotating_p2og5_1017";const Y=()=>{const{selectedDevice:e,treeData:s,selectDevice:t,getNextDevice:Y,getFilteredDevices:q}=o(),[Q,X]=l.exports.useState([]),[ee,se]=l.exports.useState(!1),[te,re]=l.exports.useState(null),[le,ae]=l.exports.useState(!1),[oe,ie]=l.exports.useState(""),[ne,de]=l.exports.useState("scheduleId"),[ce,pe]=l.exports.useState("ascending"),[xe,he]=l.exports.useState(new Set),[ue,je]=l.exports.useState(!1),me=l.exports.useRef(null),[ge,fe]=l.exports.useState(!1),ye=l.exports.useRef(!1);l.exports.useEffect((()=>{if(!e){const e=q();e.length>0&&t(e[0])}}),[e,q,t]);const ve=l.exports.useCallback((async()=>{if(e){se(!0),re(null);try{const s=await fetch(`${a}/api/t3_device/devices/${e.serialNumber}/table/SCHEDULES`);if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const t=await s.json();t.data&&Array.isArray(t.data)?X(t.data):X([])}catch(s){re(s instanceof Error?s.message:"Failed to fetch schedules")}finally{se(!1),ae(!1)}}else X([])}),[e]);l.exports.useEffect((()=>{ve()}),[ve]),l.exports.useEffect((()=>{if(ee||!e||ue)return;const s=setTimeout((async()=>{try{const s=e.serialNumber,t=await k.refreshAllSchedules(s);t&&t.items&&(await k.saveRefreshedSchedules(s,t.items),await ve()),je(!0)}catch(s){}}),500);return()=>clearTimeout(s)}),[ee,e,ue,ve]);const be=e=>{ne===e?pe("ascending"===ce?"descending":"ascending"):(de(e),pe("ascending"))},Ce=l.exports.useCallback((()=>{const e=Y();e&&(fe(!0),t(e),setTimeout((()=>{fe(!1)}),500))}),[Y,t]),_e=l.exports.useCallback((e=>{if(ge||ee)return;const s=e.currentTarget;s.scrollHeight-s.scrollTop-s.clientHeight<=1&&Q.length>0?ye.current=!0:ye.current=!1}),[ge,ee,Q.length]),Se=l.exports.useCallback((e=>{ge||ee||0===Q.length||e.deltaY>0&&ye.current&&(ye.current=!1,Ce())}),[ge,ee,Q.length,Ce]);l.exports.useEffect((()=>{e&&me.current&&me.current.scrollTo({top:0,behavior:ge?"smooth":"auto"})}),[e,ge]);const we=[v({columnId:"scheduleId",renderHeaderCell:()=>r.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>be("scheduleId"),children:[r.exports.jsx("span",{children:"Schedule"}),"scheduleId"===ne?"ascending"===ce?r.exports.jsx(g,{}):r.exports.jsx(f,{}):r.exports.jsx(y,{style:{opacity:.5}})]}),renderCell:s=>{const t=s.scheduleId&&xe.has(s.scheduleId);return r.exports.jsx(N,{children:r.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[r.exports.jsx("button",{className:`${G} ${t?K:""}`,onClick:t=>{t.stopPropagation(),(async s=>{if(!e||!s.scheduleId)return;const t=s.scheduleId;he((e=>new Set(e).add(t)));try{const r=e.serialNumber,l=parseInt(s.scheduleId),a=await k.refreshSchedule(r,l);a&&a.items&&(await k.saveRefreshedSchedules(r,a.items),await ve())}catch(r){}finally{he((e=>{const s=new Set(e);return s.delete(t),s}))}})(s)},disabled:t,title:"Refresh this schedule from device","aria-label":"Refresh schedule",children:r.exports.jsx(d,{fontSize:16})}),r.exports.jsx("span",{children:s.scheduleId||"---"})]})})}}),v({columnId:"autoManual",renderHeaderCell:()=>r.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:r.exports.jsx("span",{children:"Auto/Man"})}),renderCell:e=>{const s="1"===e.autoManual;return r.exports.jsx(N,{children:r.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[r.exports.jsx(T,{checked:s,onChange:()=>(async e=>{const s="1"===e.autoManual?"0":"1";X((t=>t.map((t=>t.serialNumber===e.serialNumber&&t.scheduleId===e.scheduleId?{...t,autoManual:s}:t))))})(e)}),r.exports.jsx(n,{size:200,children:s?"AUTO":"MAN"})]})})}}),v({columnId:"outputField",renderHeaderCell:()=>r.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>be("outputField"),children:[r.exports.jsx("span",{children:"Output"}),"outputField"===ne?"ascending"===ce?r.exports.jsx(g,{}):r.exports.jsx(f,{}):r.exports.jsx(y,{style:{opacity:.5}})]}),renderCell:e=>r.exports.jsx(N,{children:e.outputField||"---"})}),v({columnId:"variableField",renderHeaderCell:()=>r.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>be("variableField"),children:[r.exports.jsx("span",{children:"Variable"}),"variableField"===ne?"ascending"===ce?r.exports.jsx(g,{}):r.exports.jsx(f,{}):r.exports.jsx(y,{style:{opacity:.5}})]}),renderCell:e=>r.exports.jsx(N,{children:e.variableField||"---"})}),v({columnId:"holiday1",renderHeaderCell:()=>r.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>be("holiday1"),children:[r.exports.jsx("span",{children:"Holiday1"}),"holiday1"===ne?"ascending"===ce?r.exports.jsx(g,{}):r.exports.jsx(f,{}):r.exports.jsx(y,{style:{opacity:.5}})]}),renderCell:e=>r.exports.jsx(N,{children:e.holiday1||"---"})}),v({columnId:"status1",renderHeaderCell:()=>r.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:r.exports.jsx("span",{children:"Status1"})}),renderCell:e=>r.exports.jsx(N,{children:e.status1||"---"})}),v({columnId:"holiday2",renderHeaderCell:()=>r.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>be("holiday2"),children:[r.exports.jsx("span",{children:"Holiday2"}),"holiday2"===ne?"ascending"===ce?r.exports.jsx(g,{}):r.exports.jsx(f,{}):r.exports.jsx(y,{style:{opacity:.5}})]}),renderCell:e=>r.exports.jsx(N,{children:e.holiday2||"---"})}),v({columnId:"status2",renderHeaderCell:()=>r.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:r.exports.jsx("span",{children:"Status2"})}),renderCell:e=>r.exports.jsx(N,{children:e.status2||"---"})})],Ie=[...Q.filter((e=>{var s,t,r;return""===oe||(null==(s=e.scheduleId)?void 0:s.toLowerCase().includes(oe.toLowerCase()))||(null==(t=e.outputField)?void 0:t.toLowerCase().includes(oe.toLowerCase()))||(null==(r=e.variableField)?void 0:r.toLowerCase().includes(oe.toLowerCase()))}))].sort(((e,s)=>{const t=(e[ne]||"").toString(),r=(s[ne]||"").toString(),l=t.localeCompare(r);return"ascending"===ce?l:-l}));return r.exports.jsx("div",{className:H,children:r.exports.jsx("div",{className:W,children:r.exports.jsx("div",{className:F,children:r.exports.jsx("div",{className:$,children:r.exports.jsxs("div",{className:z,children:[te&&r.exports.jsxs("div",{style:{marginBottom:"12px",padding:"8px 12px",backgroundColor:"#fef6f6",borderRadius:"4px",display:"flex",alignItems:"center",gap:"8px"},children:[r.exports.jsx(i,{style:{color:"#d13438",fontSize:"16px",flexShrink:0}}),r.exports.jsx(n,{style:{color:"#d13438",fontWeight:500,fontSize:"13px"},children:te})]}),e&&r.exports.jsx("div",{className:E,children:r.exports.jsxs("div",{className:R,children:[r.exports.jsxs("button",{className:A,onClick:async()=>{if(e){ae(!0),re(null);try{const s=e.serialNumber,t=await k.refreshAllSchedules(s);t&&t.items&&(await k.saveRefreshedSchedules(s,t.items),await ve())}catch(s){re(s instanceof Error?s.message:"Failed to refresh from device")}finally{ae(!1)}}},disabled:le,title:"Refresh from Device","aria-label":"Refresh from Device",children:[r.exports.jsx(d,{className:le?K:""}),r.exports.jsx("span",{children:le?"Refreshing...":"Refresh from Device"})]}),r.exports.jsxs("button",{className:A,onClick:()=>{},title:"Export to CSV","aria-label":"Export to CSV",children:[r.exports.jsx(c,{}),r.exports.jsx("span",{children:"Export to CSV"})]}),r.exports.jsx("div",{className:D,role:"separator"}),r.exports.jsxs("button",{className:A,onClick:()=>{},title:"Settings","aria-label":"Settings",children:[r.exports.jsx(p,{}),r.exports.jsx("span",{children:"Settings"})]}),r.exports.jsxs("div",{className:L,children:[r.exports.jsx(x,{className:M}),r.exports.jsx("input",{className:B,type:"text",placeholder:"Search schedules...",value:oe,onChange:e=>{ie(e.target.value)},spellCheck:"false",role:"searchbox","aria-label":"Search schedules"})]}),r.exports.jsx(h,{content:`Showing schedule points for ${e.nameShowOnTree} (SN: ${e.serialNumber}). This table displays all configured weekly routine schedules including holidays, outputs, and status information.`,relationship:"description",children:r.exports.jsx("button",{className:A,style:{marginLeft:"8px"},title:"Information","aria-label":"Information about this page",children:r.exports.jsx(u,{})})})]})}),r.exports.jsx("div",{style:{padding:"0"},children:r.exports.jsx("hr",{className:O})}),r.exports.jsxs("div",{className:P,children:[ee&&0===Q.length&&r.exports.jsxs("div",{className:Z,children:[r.exports.jsx(j,{size:"tiny"}),r.exports.jsx(n,{size:200,weight:"regular",children:"Loading schedules..."})]}),!e&&!ee&&r.exports.jsx("div",{className:J,children:r.exports.jsxs("div",{style:{textAlign:"center"},children:[r.exports.jsx(n,{size:500,weight:"semibold",children:"No device selected"}),r.exports.jsx("br",{}),r.exports.jsx(n,{size:300,children:"Please select a device from the tree to view schedules"})]})}),e&&!ee&&r.exports.jsxs("div",{ref:me,className:V,onScroll:_e,onWheel:Se,children:[r.exports.jsxs(b,{items:Ie,columns:we,sortable:!0,resizableColumns:!0,columnSizingOptions:{scheduleId:{minWidth:70,defaultWidth:90},autoManual:{minWidth:100,defaultWidth:120},outputField:{minWidth:80,defaultWidth:100},variableField:{minWidth:80,defaultWidth:100},holiday1:{minWidth:80,defaultWidth:100},status1:{minWidth:80,defaultWidth:100},holiday2:{minWidth:80,defaultWidth:100},status2:{minWidth:80,defaultWidth:100}},children:[r.exports.jsx(C,{children:r.exports.jsx(_,{children:({renderHeaderCell:e})=>r.exports.jsx(S,{children:e()})})}),r.exports.jsx(w,{children:({item:e,rowId:s})=>r.exports.jsx(_,{children:({renderCell:s})=>r.exports.jsx(I,{children:s(e)})},s)})]}),0===Q.length&&r.exports.jsxs("div",{style:{marginTop:"24px",textAlign:"center",padding:"0 20px"},children:[r.exports.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",marginBottom:"8px"},children:[r.exports.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",style:{opacity:.5},children:r.exports.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4ZM10 8V16H14V8H10Z",fill:"currentColor"})}),r.exports.jsx(n,{size:400,weight:"semibold",children:"No schedules found"})]}),r.exports.jsx(n,{size:300,style:{display:"block",marginBottom:"16px",color:"#605e5c",textAlign:"center"},children:"This device has no configured schedule points"}),r.exports.jsx(m,{appearance:"subtle",icon:r.exports.jsx(d,{}),onClick:()=>{ae(!0),ve()},style:{minWidth:"120px",fontWeight:"normal"},children:"Refresh"})]}),ge&&r.exports.jsxs("div",{className:U,children:[r.exports.jsx(j,{size:"tiny"}),r.exports.jsx(n,{children:"Loading next device..."})]})]})]})]})})})})})};var q=Y;export{Y as SchedulesPage,q as default};

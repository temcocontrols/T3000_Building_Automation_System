var e,t,s=Object.defineProperty;import{j as r}from"./react.2da10d74.js";import{r as a}from"./client.b9d1bbf8.js";import{A as n,B as o,M as l,w as i,T as d,F as c,x as p,y as x,z as h,S as u,C as m,D as g,I as f,H as j,J as _,K as b,aF as v}from"./App.2c62e2d1.js";import{T as y}from"./TrendChartContent.f32f3148.js";import{D as I,a as N}from"./DrawerBody.3013704d.js";import{c as w,D as C,a as S,b as T,d as $,e as k,f as z,T as A}from"./DataGridHeaderCell.34491fc4.js";import{B as O}from"./Badge.bfe12ada.js";import"./index.5672de35.js";import"./Serializer.f6a5f515.js";import"./index.86b0ea20.js";import"./install.c537bbc3.js";import"./Switch.411cd684.js";import"./useDialogSurfaceContextValues.45ba7119.js";import"./useFocusableGroup.6d334b5b.js";class D{static async refreshAllTrendlogs(e){const t=await fetch(`${this.baseUrl}/trendlogs/${e}/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});if(!t.ok){const e=await t.text();throw new Error(`HTTP ${t.status}: ${e||t.statusText}`)}return await t.json()}static async saveRefreshedTrendlogs(e,t){const s=await fetch(`${this.baseUrl}/trendlogs/${e}/save-refreshed`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:t})});if(!s.ok){const e=await s.text();throw new Error(`HTTP ${s.status}: ${e||s.statusText}`)}return await s.json()}static async refreshTrendlog(e,t){const s=await fetch(`${this.baseUrl}/trendlogs/${e}/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({index:t})});if(!s.ok){const e=await s.text();throw new Error(`HTTP ${s.status}: ${e||s.statusText}`)}return await s.json()}}t=`${n}/api/t3_device`,((e,t,r)=>{t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r})(D,"symbol"!=typeof(e="baseUrl")?e+"":e,t);var M="_drawerBody_iy5ki_1",L="_drawer_iy5ki_1",E="_drawerHeader_iy5ki_25",R="_toolbarContainer_iy5ki_39",P="_toolbarContent_iy5ki_63",W="_closeButton_iy5ki_169";const B=({isOpen:e,onClose:t,serialNumber:s,panelId:n,trendlogId:i,monitorId:d,itemData:c})=>{const[p,x]=a.exports.useState(null);return r.exports.jsxs(I,{type:"overlay",separator:!0,open:e,onOpenChange:(e,{open:t})=>{},position:"end",size:"full",className:L,children:[r.exports.jsx("div",{className:E,children:p&&r.exports.jsxs("div",{className:R,children:[r.exports.jsx("div",{className:P,children:p}),r.exports.jsx(o,{appearance:"subtle","aria-label":"Close",icon:r.exports.jsx(l,{}),onClick:t,className:W})]})}),r.exports.jsx(N,{className:M,children:r.exports.jsx(y,{serialNumber:s,panelId:n,trendlogId:i,monitorId:d,itemData:c,isDrawerMode:!0,onToolbarRender:x})})]})};var H="_container_1ed7v_13",U="_bladeContentContainer_1ed7v_37",F="_bladeContentWrapper_1ed7v_53",G="_bladeContent_1ed7v_37",V="_partContent_1ed7v_85",J="_toolbar_1ed7v_103",q="_toolbarContainer_1ed7v_121",K="_toolbarButton_1ed7v_137",Q="_toolbarSeparator_1ed7v_215",X="_searchInputWrapper_1ed7v_231",Y="_searchIcon_1ed7v_245",Z="_searchInput_1ed7v_231",ee="_dockingBody_1ed7v_379",te="_loading_1ed7v_397",se="_noData_1ed7v_399",re="_loadingBar_1ed7v_417",ae="_refreshContainer_1ed7v_463",ne="_refreshIconButton_1ed7v_753",oe="_isRefreshing_1ed7v_823",le="_rotating_1ed7v_855",ie="_gridContainer_1ed7v_865",de="_mainGrid_1ed7v_881",ce="_subGrid_1ed7v_893",pe="_subGridHeader_1ed7v_915",xe="_subGridBody_1ed7v_941",he="_inputRow_1ed7v_951",ue="_inputNum_1ed7v_977",me="_inputValue_1ed7v_991";const ge=()=>{const{selectedDevice:e,treeData:t,selectDevice:s}=i(),[l,y]=a.exports.useState([]),[I,N]=a.exports.useState(!1),[M,L]=a.exports.useState(null),[E,R]=a.exports.useState(!1),[P,W]=a.exports.useState(new Set),[ge,fe]=a.exports.useState(!1),[je,_e]=a.exports.useState(null),[be,ve]=a.exports.useState(Array(14).fill("")),[ye,Ie]=a.exports.useState(""),[Ne,we]=a.exports.useState(null),[Ce,Se]=a.exports.useState("ascending"),[Te,$e]=a.exports.useState(!1),[ke,ze]=a.exports.useState({}),Ae=a.exports.useCallback((async t=>{var s,r;if(!e)return;const a=t.trendlogIndex||"0";try{const o=`${n}/api/t3_device/devices/${e.serialNumber}/trendlogs/${t.trendlogId}`,l=await fetch(o);if(!l.ok)throw new Error(`Failed to fetch trendlog: ${l.statusText}`);const i=await l.json(),d=`${n}/api/t3_device/devices/${e.serialNumber}/table/TRENDLOG_INPUTS`,c=await fetch(d);let p=[],x=[];if(c.ok){const s=await c.json();if(s.data&&Array.isArray(s.data)){const r=s.data.filter((e=>e.trendlogId===t.trendlogId||e.Trendlog_ID===t.trendlogId));r.length>0&&(p=r.map((t=>({panel:t.pointPanel||t.point_panel?parseInt(t.pointPanel||t.point_panel):e.panelId,point_number:parseInt(t.pointIndex||t.point_index||"1")-1,point_type:"INPUT"===(t.pointType||t.point_type)?0:"OUTPUT"===(t.pointType||t.point_type)?1:2,network:0,sub_panel:0}))),x=p.map((()=>({digital_analog:0,units:""}))))}}const h={title:(null==(s=null==i?void 0:i.trendlog)?void 0:s.trendlogLabel)||t.trendlogLabel||`Monitor ${a}`,t3Entry:{id:`MON${a}`,pid:e.panelId||1,label:(null==(r=null==i?void 0:i.trendlog)?void 0:r.trendlogLabel)||t.trendlogLabel||`MON${a}`,command:`${e.panelId||1}MON${a}`,input:p.length>0?p:void 0,range:x.length>0?x:void 0}};ze({serialNumber:e.serialNumber,panelId:e.panelId||1,trendlogId:t.trendlogId||"0",monitorId:a,itemData:h}),$e(!0)}catch(o){const s={title:t.trendlogLabel||`Monitor ${a}`,t3Entry:{id:`MON${a}`,pid:e.panelId||1,label:t.trendlogLabel||`MON${a}`,command:`${e.panelId||1}MON${a}`}};ze({serialNumber:e.serialNumber,panelId:e.panelId||1,trendlogId:t.trendlogId||"0",monitorId:a,itemData:s}),$e(!0)}}),[e]);a.exports.useEffect((()=>{}),[e,l.length]),a.exports.useEffect((()=>{if(!e&&t.length>0){const e=t=>{for(const s of t){if(s.data)return s;if(s.children&&s.children.length>0){const t=e(s.children);if(t)return t}}return null},r=e(t);(null==r?void 0:r.data)&&s(r.data)}}),[e,t,s]);const Oe=a.exports.useCallback((async()=>{if(e){N(!0),L(null);try{const t=`${n}/api/t3_device/devices/${e.serialNumber}/trendlogs`,s=await fetch(t);if(!s.ok)throw new Error(`Failed to fetch trendlogs: ${s.statusText}`);const r=(await s.json()).trendlogs||[],a=r.reduce(((e,t)=>{const s=t.trendlogId||t.trendlogIndex;return e[s]=(e[s]||0)+1,e}),{});Object.entries(a).filter((([e,t])=>t>1)).length;const o=r.map(((e,t)=>({...e,_uniqueIndex:t})));y(o)}catch(t){const e=t instanceof Error?t.message:"Failed to load trendlogs";L(e)}finally{N(!1)}}else y([])}),[e]);a.exports.useEffect((()=>{Oe()}),[Oe]),a.exports.useEffect((()=>{if(I||!e||ge)return;const t=setTimeout((async()=>{try{const t=await D.refreshAllTrendlogs(e.serialNumber);t.items&&t.items.length>0&&(await D.saveRefreshedTrendlogs(e.serialNumber,t.items),await Oe()),fe(!0)}catch(t){fe(!0)}}),500);return()=>clearTimeout(t)}),[I,e,ge,Oe]);const De=a.exports.useCallback((async t=>{if(_e(t),e)try{const s=`${n}/api/t3_device/devices/${e.serialNumber}/table/TRENDLOG_INPUTS`,r=await fetch(s);if(r.ok){const e=await r.json();if(e.data&&Array.isArray(e.data)){const s=e.data.filter((e=>!(e.trendlogId!==t.trendlogId&&e.Trendlog_ID!==t.trendlogId||"MAIN"!==e.viewType&&"MAIN"!==e.view_type&&e.viewType))),r=Array(14).fill("");s.forEach((e=>{const t=parseInt(e.pointIndex||e.point_index||"0"),s=e.pointType||e.point_type||"",a=e.pointLabel||e.point_label||"";if(t>0&&t<=14){const e="INPUT"===s?"IN":"OUTPUT"===s?"OUT":"VARIABLE"===s?"VAR":"";r[t-1]=a||`${e}${t}`}})),ve(r)}else ve(Array(14).fill(""))}else ve(Array(14).fill(""))}catch(s){ve(Array(14).fill(""))}else ve(Array(14).fill(""))}),[e]),Me=e=>{Ne===e?Se("ascending"===Ce?"descending":"ascending"):(we(e),Se("ascending"))},Le=[w({columnId:"trendlogId",compare:(e,t)=>Number(e.trendlogId||e.trendlogIndex||0)-Number(t.trendlogId||t.trendlogIndex||0),renderHeaderCell:()=>r.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>Me("trendlogId"),children:[r.exports.jsx("span",{children:"Trendlog ID"}),"trendlogId"===Ne?"ascending"===Ce?r.exports.jsx(j,{}):r.exports.jsx(_,{}):r.exports.jsx(b,{style:{opacity:.5}})]}),renderCell:t=>{const s=t.trendlogId||t.trendlogIndex||"",a=P.has(s);return r.exports.jsx(A,{children:r.exports.jsxs("div",{className:ae,children:[r.exports.jsx("button",{onClick:t=>{t.stopPropagation(),(async t=>{if(!e)return;const s=parseInt(t,10);if(!isNaN(s)){W((e=>new Set(e).add(t)));try{const r=await D.refreshTrendlog(e.serialNumber,s);r.items&&r.items.length>0&&await D.saveRefreshedTrendlogs(e.serialNumber,r.items),await Oe()}catch(r){}finally{W((e=>{const s=new Set(e);return s.delete(t),s}))}}})(s)},className:`${ne} ${a?oe:""}`,title:"Refresh this trendlog from device",disabled:a,children:r.exports.jsx(x,{style:{fontSize:"14px"},className:a?le:""})}),r.exports.jsx(d,{size:200,weight:"regular",children:s||"---"})]})})}}),w({columnId:"trendlogLabel",compare:(e,t)=>(e.trendlogLabel||"").localeCompare(t.trendlogLabel||""),renderHeaderCell:()=>r.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>Me("trendlogLabel"),children:[r.exports.jsx("span",{children:"Label"}),"trendlogLabel"===Ne?"ascending"===Ce?r.exports.jsx(j,{}):r.exports.jsx(_,{}):r.exports.jsx(b,{style:{opacity:.5}})]}),renderCell:e=>r.exports.jsx(A,{children:r.exports.jsx(d,{size:200,children:e.trendlogLabel||"---"})})}),w({columnId:"intervalSeconds",renderHeaderCell:()=>r.exports.jsx("span",{children:"Interval (sec)"}),renderCell:e=>{var t;return r.exports.jsx(A,{children:r.exports.jsx(d,{size:200,children:null!=(t=e.intervalSeconds)?t:"---"})})}}),w({columnId:"bufferSize",renderHeaderCell:()=>r.exports.jsx("span",{children:"Buffer Size"}),renderCell:e=>{var t;return r.exports.jsx(A,{children:r.exports.jsx(d,{size:200,children:null!=(t=e.bufferSize)?t:"---"})})},compare:(e,t)=>(e.bufferSize||0)-(t.bufferSize||0)}),w({columnId:"autoManual",renderHeaderCell:()=>r.exports.jsx("span",{children:"Auto/Manual"}),renderCell:e=>r.exports.jsx(A,{children:r.exports.jsx(O,{appearance:"1"===e.autoManual?"filled":"outline",color:"informative",children:"1"===e.autoManual?"Auto":"0"===e.autoManual?"Manual":"---"})}),compare:(e,t)=>(e.autoManual||"").localeCompare(t.autoManual||"")}),w({columnId:"status",renderHeaderCell:()=>r.exports.jsx("span",{children:"Status"}),renderCell:e=>r.exports.jsx(A,{children:r.exports.jsx(O,{appearance:"tint",color:"ON"===e.status?"success":"subtle",children:e.status||"OFF"})}),compare:(e,t)=>(e.status||"").localeCompare(t.status||"")}),w({columnId:"actions",renderHeaderCell:()=>r.exports.jsx("span",{children:"Actions"}),renderCell:e=>r.exports.jsx(A,{children:r.exports.jsx(o,{size:"small",icon:r.exports.jsx(v,{style:{fontSize:"14px"}}),onClick:()=>Ae(e),title:"View trend chart for this trendlog",children:"View Graphic"})})})];return e?I?r.exports.jsx("div",{className:H,children:r.exports.jsx("div",{className:te,children:r.exports.jsx(c,{size:"medium",label:"Loading trend logs..."})})}):r.exports.jsxs("div",{className:H,children:[r.exports.jsx("div",{className:U,children:r.exports.jsx("div",{className:F,children:r.exports.jsx("div",{className:G,children:r.exports.jsxs("div",{className:V,children:[M&&r.exports.jsxs("div",{style:{marginBottom:"12px",padding:"8px 12px",backgroundColor:"#fef6f6",borderRadius:"4px",display:"flex",alignItems:"center",gap:"8px"},children:[r.exports.jsx(p,{style:{color:"#d13438",fontSize:"16px",flexShrink:0}}),r.exports.jsx(d,{style:{color:"#d13438",fontWeight:500,fontSize:"13px"},children:M})]}),e&&r.exports.jsx("div",{className:J,children:r.exports.jsxs("div",{className:q,children:[r.exports.jsxs("button",{className:K,onClick:async()=>{if(e){R(!0);try{const t=await D.refreshAllTrendlogs(e.serialNumber);if(t.items&&t.items.length>0){await D.saveRefreshedTrendlogs(e.serialNumber,t.items);await Oe()}}catch(t){L(t instanceof Error?t.message:"Failed to refresh from device")}finally{R(!1)}}},disabled:E,title:"Refresh all trendlogs from device","aria-label":"Refresh from Device",children:[r.exports.jsx(x,{}),r.exports.jsx("span",{children:E?"Refreshing...":"Refresh from Device"})]}),r.exports.jsx("div",{className:Q}),r.exports.jsxs("button",{className:K,onClick:()=>{},disabled:!e,title:"Export trendlogs to CSV","aria-label":"Export to CSV",children:[r.exports.jsx(h,{}),r.exports.jsx("span",{children:"Export"})]}),r.exports.jsxs("button",{className:K,onClick:()=>{},disabled:!e,title:"Configure trendlog settings","aria-label":"Settings",children:[r.exports.jsx(u,{}),r.exports.jsx("span",{children:"Settings"})]}),r.exports.jsxs("div",{className:X,children:[r.exports.jsx(m,{className:Y}),r.exports.jsx("input",{className:Z,type:"text",placeholder:"Search trendlogs...",value:ye,onChange:e=>{Ie(e.target.value)},spellCheck:"false",role:"searchbox","aria-label":"Search trendlogs"})]}),r.exports.jsx(g,{content:`Showing trend log monitors for ${e.nameShowOnTree||e.productName} (SN: ${e.serialNumber}). This table displays all configured trendlog/monitor data collection points. Click the refresh icon next to each trendlog to sync from the device.`,relationship:"description",children:r.exports.jsx("button",{className:K,style:{marginLeft:"8px"},title:"Information","aria-label":"Information about this page",children:r.exports.jsx(f,{})})})]})}),r.exports.jsxs("div",{className:ee,children:[I&&0===l.length&&r.exports.jsxs("div",{className:re,children:[r.exports.jsx(c,{size:"tiny"}),r.exports.jsx(d,{size:200,weight:"regular",children:"Loading trendlogs..."})]}),!e&&!I&&r.exports.jsx("div",{className:se,children:r.exports.jsxs("div",{style:{textAlign:"center"},children:[r.exports.jsx(d,{size:500,weight:"semibold",children:"No device selected"}),r.exports.jsx("br",{}),r.exports.jsx(d,{size:300,children:"Please select a device from the tree to view trendlogs"})]})}),e&&!I&&!M&&l.length>0&&r.exports.jsxs("div",{className:ie,children:[r.exports.jsx("div",{className:de,children:r.exports.jsxs(C,{items:l,columns:Le,sortable:!0,resizableColumns:!0,selectionMode:"single",columnSizingOptions:{trendlogId:{minWidth:120,defaultWidth:150},trendlogLabel:{minWidth:150,defaultWidth:200},intervalSeconds:{minWidth:100,defaultWidth:120},bufferSize:{minWidth:90,defaultWidth:110},autoManual:{minWidth:100,defaultWidth:130},status:{minWidth:70,defaultWidth:80},actions:{minWidth:150,defaultWidth:180}},getRowId:e=>`${e.serialNumber}-${e.trendlogId||e.trendlogIndex}-${e._uniqueIndex}`,children:[r.exports.jsx(S,{children:r.exports.jsx(T,{selectionCell:{renderHeaderCell:()=>r.exports.jsx("span",{children:"#"})},children:({renderHeaderCell:e})=>r.exports.jsx($,{children:e()})})}),r.exports.jsx(k,{children:({item:e,rowId:t})=>r.exports.jsx(T,{onClick:()=>De(e),style:{cursor:"pointer",backgroundColor:(null==je?void 0:je.trendlogId)===e.trendlogId?"#e6f2ff":void 0},children:({renderCell:t})=>r.exports.jsx(z,{children:t(e)})},t)})]})}),r.exports.jsxs("div",{className:ce,children:[r.exports.jsx("div",{className:pe,children:r.exports.jsx(d,{size:300,weight:"semibold",children:"Monitor Inputs"})}),r.exports.jsx("div",{className:xe,children:be.map(((e,t)=>r.exports.jsxs("div",{className:he,children:[r.exports.jsx("div",{className:ue,children:t+1}),r.exports.jsx("div",{className:me,children:e||"-"})]},t)))})]})]}),e&&!I&&!M&&0===l.length&&r.exports.jsxs("div",{style:{marginTop:"24px",textAlign:"center",padding:"0 20px"},children:[r.exports.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",marginBottom:"8px"},children:r.exports.jsx(d,{size:400,weight:"semibold",children:"No trendlogs found"})}),r.exports.jsx(d,{size:300,style:{display:"block",marginBottom:"16px",color:"#605e5c",textAlign:"center"},children:"This device has no configured trendlog monitors"})]})]})]})})})}),r.exports.jsx(B,{isOpen:Te,onClose:()=>$e(!1),serialNumber:ke.serialNumber,panelId:ke.panelId,trendlogId:ke.trendlogId,monitorId:ke.monitorId,itemData:ke.itemData})]}):r.exports.jsx("div",{className:H,children:r.exports.jsx("div",{className:se,children:r.exports.jsx(d,{size:300,weight:"semibold",children:"No Device Selected"})})})};export{ge as TrendLogsPage};

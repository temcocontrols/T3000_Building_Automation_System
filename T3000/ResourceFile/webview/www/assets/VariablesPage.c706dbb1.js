var e,t,a=Object.defineProperty;import{j as s}from"./react.2da10d74.js";import{r}from"./client.b9d1bbf8.js";import{A as l,w as i,x as n,T as o,y as c,z as d,S as x,C as p,D as u,I as h,F as b,B as f,H as g,J as m,K as v,L as j}from"./App.2c62e2d1.js";import{R as y,g as w}from"./RangeSelectionDrawer.34f7cc22.js";import{c as C,D as _,a as N,b as I,d as S,e as k,f as T,T as $}from"./DataGridHeaderCell.34491fc4.js";import{S as L}from"./Switch.411cd684.js";import"./index.5672de35.js";import"./Serializer.f6a5f515.js";import"./DrawerBody.3013704d.js";import"./useDialogSurfaceContextValues.45ba7119.js";import"./DrawerHeaderTitle.9bf254d7.js";import"./useDialogTitleStyles.styles.836f5a4a.js";import"./Input.16f797a0.js";import"./useFocusableGroup.6d334b5b.js";class E{static async refreshVariable(e,t){try{const a=await fetch(`${this.baseUrl}/variables/${e}/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({index:t})});if(!a.ok){const e=await a.text();throw new Error(`HTTP ${a.status}: ${e||a.statusText}`)}return await a.json()}catch(a){throw a}}static async refreshAllVariables(e){try{const t=await fetch(`${this.baseUrl}/variables/${e}/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});if(!t.ok){const e=await t.text();throw new Error(`HTTP ${t.status}: ${e||t.statusText}`)}return await t.json()}catch(t){throw t}}static async saveRefreshedVariables(e,t){try{const a=await fetch(`${this.baseUrl}/variables/${e}/save-refreshed`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:t})});if(!a.ok){const e=await a.text();throw new Error(`HTTP ${a.status}: ${e||a.statusText}`)}return await a.json()}catch(a){throw a}}}t=`${l}/api/t3_device`,((e,t,s)=>{t in e?a(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(E,"symbol"!=typeof(e="baseUrl")?e+"":e,t);var V="_container_7hycr_35",D="_bladeContentContainer_7hycr_59",F="_bladeContentWrapper_7hycr_75",H="_bladeContent_7hycr_59",z="_partContent_7hycr_107",W="_toolbar_7hycr_125",A="_toolbarContainer_7hycr_143",P="_toolbarButton_7hycr_159",R="_toolbarSeparator_7hycr_237",B="_searchInputWrapper_7hycr_253",M="_searchIcon_7hycr_267",O="_searchInput_7hycr_253",U="_overviewHr_7hycr_387",J="_dockingBody_7hycr_403",K="_scrollContainer_7hycr_421",Z="_noData_7hycr_443",G="_loadingBar_7hycr_461",Y="_autoLoadIndicator_7hycr_489",q="_editableCell_7hycr_771",Q="_editInput_7hycr_799",X="_saveButton_7hycr_871",ee="_refreshIconButton_7hycr_933",te="_isRefreshing_7hycr_1003",ae="_rotating_7hycr_1035";const se=()=>{const{selectedDevice:e,treeData:t,selectDevice:a,getNextDevice:se,getFilteredDevices:re}=i(),[le,ie]=r.exports.useState([]),[ne,oe]=r.exports.useState(!1),[ce,de]=r.exports.useState(null),[xe,pe]=r.exports.useState(!1),[ue,he]=r.exports.useState(new Set),[be,fe]=r.exports.useState(!1),ge=r.exports.useRef(null),[me,ve]=r.exports.useState(!1),je=r.exports.useRef(!1);r.exports.useEffect((()=>{if(!e&&t.length>0){const e=re();if(e.length>0){const t=e[0];a(t)}}}),[e,t,a,re]);const ye=r.exports.useCallback((async()=>{if(e){oe(!0),de(null);try{const t=`${l}/api/t3_device/devices/${e.serialNumber}/variable-points`,a=await fetch(t);if(!a.ok)throw new Error(`Failed to fetch variables: ${a.statusText}`);const s=(await a.json()).variable_points||[];ie(s)}catch(t){const e=t instanceof Error?t.message:"Failed to load variables";de(e)}finally{oe(!1)}}else ie([])}),[e]);r.exports.useEffect((()=>{ye()}),[ye]),r.exports.useEffect((()=>{if(ne||!e||be)return;const t=setTimeout((async()=>{try{const t=await E.refreshAllVariables(e.serialNumber);t.items&&t.items.length>0&&(await E.saveRefreshedVariables(e.serialNumber,t.items),await ye()),fe(!0)}catch(t){fe(!0)}}),500);return()=>clearTimeout(t)}),[ne,e,be,ye]);const we=r.exports.useCallback((async()=>{const e=se();e&&(ve(!0),a(e),setTimeout((()=>{ve(!1)}),500))}),[se,a]),Ce=r.exports.useCallback((e=>{if(me||ne)return;const t=e.currentTarget;t.scrollHeight-t.scrollTop-t.clientHeight<=1&&le.length>0?je.current=!0:je.current=!1}),[me,ne,le.length]),_e=r.exports.useCallback((e=>{me||ne||0===le.length||e.deltaY>0&&je.current&&(je.current=!1,we())}),[me,ne,le.length,we]);r.exports.useEffect((()=>{e&&ge.current&&ge.current.scrollTo({top:0,behavior:me?"smooth":"auto"})}),[e,me]);const Ne=(e,t,a)=>{Le({serialNumber:e.serialNumber,variableIndex:e.variableIndex||"",field:t}),Ve(a||"")},Ie=async()=>{if($e)if("fValue"===$e.field||Ee.trim()){Fe(!0);try{if(e&&["fullLabel","fValue"].includes($e.field)){const t=le.find((e=>e.serialNumber===$e.serialNumber&&e.variableIndex===$e.variableIndex));if(!t)throw new Error("Current variable data not found");const a={fullLabel:"fullLabel"===$e.field?Ee:t.fullLabel||"",label:t.label||"",value:"fValue"===$e.field?parseFloat(Ee||"0"):parseFloat(t.fValue||"0"),range:parseInt(t.rangeField||"0"),autoManual:parseInt(t.autoManual||"0"),control:0,filter:parseInt(t.filterField||"0"),digitalAnalog:"1"===t.digitalAnalog?1:0,calibrationSign:parseInt(t.sign||"0"),calibrationH:0,calibrationL:0},s=await fetch(`${l}/api/t3_device/variables/${e.serialNumber}/${$e.variableIndex}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!s.ok){const e=await s.text();throw new Error(`HTTP ${s.status}: ${e}`)}await s.json()}ie((e=>e.map((e=>e.serialNumber===$e.serialNumber&&e.variableIndex===$e.variableIndex?{...e,[$e.field]:Ee}:e)))),Le(null)}catch(t){alert(`Failed to update: ${t instanceof Error?t.message:"Unknown error"}`)}finally{Fe(!1)}}else Le(null);else Le(null)},Se=e=>{"Enter"===e.key?(e.preventDefault(),Ie()):"Escape"===e.key&&(e.preventDefault(),Le(null),Ve(""))},[ke,Te]=r.exports.useState(""),[$e,Le]=r.exports.useState(null),[Ee,Ve]=r.exports.useState(""),[De,Fe]=r.exports.useState(!1),[He,ze]=r.exports.useState(!1),[We,Ae]=r.exports.useState(null),[Pe,Re]=r.exports.useState(null),[Be,Me]=r.exports.useState("ascending"),Oe=e=>{Pe===e?Me("ascending"===Be?"descending":"ascending"):(Re(e),Me("ascending"))},Ue=[C({columnId:"panel",renderHeaderCell:()=>s.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>Oe("panel"),children:[s.exports.jsx("span",{children:"Panel"}),"panel"===Pe?"ascending"===Be?s.exports.jsx(g,{}):s.exports.jsx(m,{}):s.exports.jsx(v,{style:{opacity:.5}})]}),renderCell:e=>s.exports.jsx($,{children:e.panel||"---"})}),C({columnId:"variable",renderHeaderCell:()=>s.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>Oe("variable"),children:[s.exports.jsx("span",{children:"Variable"}),"variable"===Pe?"ascending"===Be?s.exports.jsx(g,{}):s.exports.jsx(m,{}):s.exports.jsx(v,{style:{opacity:.5}})]}),renderCell:t=>{const a=ue.has(t.variableIndex||"");return s.exports.jsx($,{children:s.exports.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[s.exports.jsx("button",{onClick:a=>{a.stopPropagation(),(async t=>{if(!e)return;const a=parseInt(t,10);if(!isNaN(a)){he((e=>new Set(e).add(t)));try{const s=await E.refreshVariable(e.serialNumber,a);s.items&&s.items.length>0&&await E.saveRefreshedVariables(e.serialNumber,s.items),await ye()}catch(s){}finally{he((e=>{const a=new Set(e);return a.delete(t),a}))}}})(t.variableIndex||"")},className:`${ee} ${a?te:""}`,title:"Refresh this variable from device",disabled:a,children:s.exports.jsx(c,{style:{fontSize:"14px"},className:a?ae:""})}),s.exports.jsx(o,{size:200,weight:"regular",children:t.variableId||t.variableIndex||"---"})]})})}}),C({columnId:"fullLabel",renderHeaderCell:()=>s.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>Oe("fullLabel"),children:[s.exports.jsx("span",{children:"Full Label"}),"fullLabel"===Pe?"ascending"===Be?s.exports.jsx(g,{}):s.exports.jsx(m,{}):s.exports.jsx(v,{style:{opacity:.5}})]}),renderCell:e=>{const t=(null==$e?void 0:$e.serialNumber)===e.serialNumber&&(null==$e?void 0:$e.variableIndex)===e.variableIndex&&"fullLabel"===(null==$e?void 0:$e.field);return s.exports.jsx($,{children:t?s.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",width:"100%"},children:[s.exports.jsx("input",{type:"text",className:Q,value:Ee,onChange:e=>Ve(e.target.value),onBlur:Ie,onKeyDown:Se,autoFocus:!0,disabled:De,placeholder:"Enter label","aria-label":"Edit full label",style:{flex:1}}),s.exports.jsx("button",{onClick:e=>{e.stopPropagation(),Ie()},disabled:De,className:X,title:"Save",children:s.exports.jsx(j,{style:{fontSize:"18px"}})})]}):s.exports.jsx("div",{className:q,onDoubleClick:()=>Ne(e,"fullLabel",e.fullLabel||""),title:"Double-click to edit",children:s.exports.jsx(o,{size:200,weight:"regular",children:e.fullLabel||"Unnamed"})})})}}),C({columnId:"label",renderHeaderCell:()=>s.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>Oe("label"),children:[s.exports.jsx("span",{children:"Label"}),"label"===Pe?"ascending"===Be?s.exports.jsx(g,{}):s.exports.jsx(m,{}):s.exports.jsx(v,{style:{opacity:.5}})]}),renderCell:e=>{const t=(null==$e?void 0:$e.serialNumber)===e.serialNumber&&(null==$e?void 0:$e.variableIndex)===e.variableIndex&&"label"===(null==$e?void 0:$e.field);return s.exports.jsx($,{children:t?s.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",width:"100%"},children:[s.exports.jsx("input",{type:"text",className:Q,value:Ee,onChange:e=>Ve(e.target.value),onBlur:Ie,onKeyDown:Se,autoFocus:!0,disabled:De,placeholder:"Enter label","aria-label":"Edit label",style:{flex:1}}),s.exports.jsx("button",{onClick:e=>{e.stopPropagation(),Ie()},disabled:De,className:X,title:"Save",children:s.exports.jsx(j,{style:{fontSize:"18px"}})})]}):s.exports.jsx("div",{className:q,onDoubleClick:()=>Ne(e,"label",e.label||""),title:"Double-click to edit",children:s.exports.jsx(o,{size:200,weight:"regular",children:e.label||"---"})})})}}),C({columnId:"autoManual",renderHeaderCell:()=>s.exports.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:s.exports.jsx("span",{children:"Auto/Manual"})}),renderCell:e=>{var t;const a=null==(t=e.autoManual)?void 0:t.toString().toLowerCase(),r="auto"===a||"1"===a;return s.exports.jsx($,{children:s.exports.jsx("div",{onClick:async()=>{const t=r?"0":"1";try{const a=le.find((t=>t.serialNumber===e.serialNumber&&t.variableIndex===e.variableIndex));if(!a)throw new Error("Current variable data not found");const s={fullLabel:a.fullLabel||"",label:a.label||"",value:parseFloat(a.fValue||"0"),range:parseInt(a.rangeField||"0"),autoManual:parseInt(t),control:0,filter:parseInt(a.filterField||"0"),digitalAnalog:"1"===a.digitalAnalog?1:0,calibrationSign:parseInt(a.sign||"0"),calibrationH:0,calibrationL:0},r=await fetch(`${l}/api/t3_device/variables/${e.serialNumber}/${e.variableIndex}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!r.ok){const e=await r.text();throw new Error(`HTTP ${r.status}: ${e}`)}await r.json();ie((a=>a.map((a=>a.serialNumber===e.serialNumber&&a.variableIndex===e.variableIndex?{...a,autoManual:t}:a))))}catch(a){alert(`Failed to update Auto/Man: ${a instanceof Error?a.message:"Unknown error"}`)}},style:{cursor:"pointer",display:"flex",alignItems:"center"},children:s.exports.jsx(L,{checked:r,style:{transform:"scale(0.8)"}})})})}}),C({columnId:"value",renderHeaderCell:()=>s.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>Oe("value"),children:[s.exports.jsx("span",{children:"Value"}),"value"===Pe?"ascending"===Be?s.exports.jsx(g,{}):s.exports.jsx(m,{}):s.exports.jsx(v,{style:{opacity:.5}})]}),renderCell:e=>{const t=(null==$e?void 0:$e.serialNumber)===e.serialNumber&&(null==$e?void 0:$e.variableIndex)===e.variableIndex&&"fValue"===(null==$e?void 0:$e.field);return s.exports.jsx($,{children:t?s.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",width:"100%"},children:[s.exports.jsx("input",{type:"number",step:"0.01",className:Q,value:Ee,onChange:e=>Ve(e.target.value),onBlur:Ie,onKeyDown:Se,autoFocus:!0,disabled:De,placeholder:"Enter value","aria-label":"Edit value",style:{flex:1}}),s.exports.jsx("button",{onClick:e=>{e.stopPropagation(),Ie()},disabled:De,className:X,title:"Save",children:s.exports.jsx(j,{style:{fontSize:"18px"}})})]}):s.exports.jsx("div",{className:q,onDoubleClick:()=>{var t;return Ne(e,"fValue",(null==(t=e.fValue)?void 0:t.toString())||"0")},title:"Double-click to edit",children:s.exports.jsx(o,{size:200,weight:"regular",children:e.fValue||"---"})})})}}),C({columnId:"units",renderHeaderCell:()=>s.exports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px",cursor:"pointer"},onClick:()=>Oe("units"),children:[s.exports.jsx("span",{children:"Units"}),"units"===Pe?"ascending"===Be?s.exports.jsx(g,{}):s.exports.jsx(m,{}):s.exports.jsx(v,{style:{opacity:.5}})]}),renderCell:e=>{const t=e.rangeField?parseInt(e.rangeField):0,a="1"===e.digitalAnalog?1:0,r=w(t,a);return s.exports.jsx($,{children:s.exports.jsx("div",{onClick:()=>(e=>{Ae(e),ze(!0)})(e),style:{cursor:"pointer",color:"#0078d4"},title:"Click to change range/units",children:s.exports.jsx(o,{size:200,weight:"regular",children:r})})})}})];return s.exports.jsxs("div",{className:V,children:[s.exports.jsx("div",{className:D,children:s.exports.jsx("div",{className:F,children:s.exports.jsx("div",{className:H,children:s.exports.jsxs("div",{className:z,children:[ce&&s.exports.jsxs("div",{style:{marginBottom:"12px",padding:"8px 12px",backgroundColor:"#fef6f6",borderRadius:"4px",display:"flex",alignItems:"center",gap:"8px"},children:[s.exports.jsx(n,{style:{color:"#d13438",fontSize:"16px",flexShrink:0}}),s.exports.jsx(o,{style:{color:"#d13438",fontWeight:500,fontSize:"13px"},children:ce})]}),e&&s.exports.jsx("div",{className:W,children:s.exports.jsxs("div",{className:A,children:[s.exports.jsxs("button",{className:P,onClick:async()=>{if(e){pe(!0);try{const t=await E.refreshAllVariables(e.serialNumber);if(t.items&&t.items.length>0){await E.saveRefreshedVariables(e.serialNumber,t.items);await ye()}}catch(t){de(t instanceof Error?t.message:"Failed to refresh from device")}finally{pe(!1)}}},disabled:xe,title:"Refresh all variables from device","aria-label":"Refresh from Device",children:[s.exports.jsx(c,{}),s.exports.jsx("span",{children:xe?"Refreshing...":"Refresh from Device"})]}),s.exports.jsxs("button",{className:P,onClick:()=>{},title:"Export to CSV","aria-label":"Export to CSV",children:[s.exports.jsx(d,{}),s.exports.jsx("span",{children:"Export to CSV"})]}),s.exports.jsx("div",{className:R,role:"separator"}),s.exports.jsxs("button",{className:P,onClick:()=>{},title:"Settings","aria-label":"Settings",children:[s.exports.jsx(x,{}),s.exports.jsx("span",{children:"Settings"})]}),s.exports.jsxs("div",{className:B,children:[s.exports.jsx(p,{className:M}),s.exports.jsx("input",{className:O,type:"text",placeholder:"Search variables...",value:ke,onChange:e=>{Te(e.target.value)},spellCheck:"false",role:"searchbox","aria-label":"Search variables"})]}),s.exports.jsx(u,{content:`Showing variable points for ${e.nameShowOnTree} (SN: ${e.serialNumber}). This table displays all configured variable points used for internal calculations, logic operations, and data storage within the building automation system.`,relationship:"description",children:s.exports.jsx("button",{className:P,style:{marginLeft:"8px"},title:"Information","aria-label":"Information about this page",children:s.exports.jsx(h,{})})})]})}),s.exports.jsx("div",{style:{padding:"0"},children:s.exports.jsx("hr",{className:U})}),s.exports.jsxs("div",{className:J,children:[ne&&0===le.length&&s.exports.jsxs("div",{className:G,children:[s.exports.jsx(b,{size:"tiny"}),s.exports.jsx(o,{size:200,weight:"regular",children:"Loading variables..."}),s.exports.jsx(o,{children:"Loading variables..."})]}),!e&&!ne&&s.exports.jsx("div",{className:Z,children:s.exports.jsxs("div",{style:{textAlign:"center"},children:[s.exports.jsx(o,{size:500,weight:"semibold",children:"No device selected"}),s.exports.jsx("br",{}),s.exports.jsx(o,{size:300,children:"Please select a device from the tree to view variables"})]})}),e&&!ne&&s.exports.jsxs("div",{ref:ge,className:K,onScroll:Ce,onWheel:_e,children:[s.exports.jsxs(_,{items:le,columns:Ue,sortable:!0,resizableColumns:!0,columnSizingOptions:{variable:{minWidth:60,defaultWidth:80},panel:{minWidth:60,defaultWidth:75},fullLabel:{minWidth:180,defaultWidth:250},label:{minWidth:130,defaultWidth:170},autoManual:{minWidth:90,defaultWidth:120},value:{minWidth:120,defaultWidth:180},units:{minWidth:100,defaultWidth:150}},children:[s.exports.jsx(N,{children:s.exports.jsx(I,{children:({renderHeaderCell:e})=>s.exports.jsx(S,{children:e()})})}),s.exports.jsx(k,{children:({item:e,rowId:t})=>s.exports.jsx(I,{children:({renderCell:t})=>s.exports.jsx(T,{children:t(e)})},t)})]}),me&&s.exports.jsxs("div",{className:Y,children:[s.exports.jsx(b,{size:"tiny"}),s.exports.jsx(o,{size:200,weight:"regular",children:"Loading next device..."})]}),0===le.length&&s.exports.jsxs("div",{style:{marginTop:"24px",textAlign:"center",padding:"0 20px"},children:[s.exports.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",marginBottom:"8px"},children:[s.exports.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",style:{opacity:.5},children:s.exports.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4ZM10 8V16H14V8H10Z",fill:"currentColor"})}),s.exports.jsx(o,{size:400,weight:"semibold",children:"No variables found"})]}),s.exports.jsx(o,{size:300,style:{display:"block",marginBottom:"16px",color:"#605e5c",textAlign:"center"},children:"This device has no configured variable points"}),s.exports.jsx(f,{appearance:"subtle",icon:s.exports.jsx(c,{}),onClick:async()=>{pe(!0),await ye(),pe(!1)},style:{minWidth:"120px",fontWeight:"normal"},children:"Refresh"})]})]}),"              "]})]})})})}),We&&s.exports.jsx(y,{isOpen:He,onClose:()=>{ze(!1),Ae(null)},currentRange:We.rangeField?parseInt(We.rangeField):0,digitalAnalog:"1"===We.digitalAnalog?1:0,onSave:async e=>{if(We)try{const t={fullLabel:We.fullLabel||"",label:We.label||"",value:parseFloat(We.fValue||"0"),range:e,autoManual:parseInt(We.autoManual||"0"),control:0,filter:parseInt(We.filterField||"0"),digitalAnalog:"1"===We.digitalAnalog?1:0,calibrationSign:parseInt(We.sign||"0"),calibrationH:0,calibrationL:0},a=await fetch(`${l}/api/t3_device/variables/${We.serialNumber}/${We.variableIndex}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!a.ok){const e=await a.text();throw new Error(`HTTP ${a.status}: ${e}`)}await a.json();ie((t=>t.map((t=>t.serialNumber===We.serialNumber&&t.variableIndex===We.variableIndex?{...t,rangeField:e.toString()}:t))))}catch(t){alert(`Failed to update Range/Units: ${t instanceof Error?t.message:"Unknown error"}`)}},inputLabel:We.fullLabel||"Variable"})]})};export{se as VariablesPage,se as default};

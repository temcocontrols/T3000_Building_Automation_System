import{j as e}from"./react.3bc90b5d.js";import{r as a,R as s}from"./client.58f92968.js";import{u as r,L as l,M as t,E as i,T as n,h as o,N as d,i as c,P as p,Q as x,I as u,S as b,R as h,U as m,V as f,X as v,Y as j,Z as g}from"./App.4ea21eda.js";import{R as _}from"./RangeSelectionDrawer.ccf9a497.js";import{g as N}from"./rangeData.f0c44010.js";import{c as y,D as k,a as C,b as I,d as w,e as z,f as S}from"./DataGridHeaderCell.c083631d.js";import{T as $}from"./TableCellLayout.777c5080.js";import"./index.f111124c.js";import"./Serializer.f6a5f515.js";import"./axios.65f6a2c9.js";import"./T3Data.f6c34e59.js";import"./_commonjsHelpers.a5007c1f.js";import"./RadioGroup.ff7938d5.js";import"./Input.4fa0d50c.js";var F="_container_kypz1_35",L="_bladeContentContainer_kypz1_59",E="_bladeContentWrapper_kypz1_75",D="_bladeContent_kypz1_59",T="_partContent_kypz1_107",V="_toolbar_kypz1_125",H="_toolbarContainer_kypz1_143",R="_toolbarButton_kypz1_159",A="_toolbarSeparator_kypz1_237",W="_searchInputWrapper_kypz1_253",M="_searchIcon_kypz1_267",P="_searchInput_kypz1_253",U="_overviewHr_kypz1_387",B="_dockingBody_kypz1_403",O="_scrollContainer_kypz1_421",J="_noData_kypz1_483",K="_loadingBar_kypz1_501",G="_autoLoadIndicator_kypz1_529",Y="_editableCell_kypz1_811",Q="_editInput_kypz1_839",X="_saveButton_kypz1_911",Z="_refreshIconButton_kypz1_973",q="_isRefreshing_kypz1_1043",ee="_rotating_kypz1_1075",ae="_headerCellSort_kypz1_1085",se="_headerCell_kypz1_1085",re="_sortIconFaded_kypz1_1111",le="_cellFlexContainer_kypz1_1119",te="_editInputContainer_kypz1_1129",ie="_flex1_kypz1_1143",ne="_iconSmall_kypz1_1151",oe="_iconMedium_kypz1_1159",de="_iconError_kypz1_1167",ce="_textError_kypz1_1179",pe="_switchScale_kypz1_1191",xe="_switchContainer_kypz1_1199",ue="_rangeLink_kypz1_1211",be="_errorNotice_kypz1_1221",he="_noPadding_kypz1_1241",me="_centerText_kypz1_1249",fe="_marginLeft8_kypz1_1317";const ve=()=>{const{selectedDevice:ve,treeData:je,selectDevice:ge,getNextDevice:_e,getFilteredDevices:Ne}=r(),ye=l((e=>e.setMessage)),[ke,Ce]=a.exports.useState([]),[Ie,we]=a.exports.useState(!1),[ze,Se]=a.exports.useState(null),[$e,Fe]=a.exports.useState(!1),[Le,Ee]=a.exports.useState(new Set),[De,Te]=a.exports.useState(!1),Ve=a.exports.useRef(!1),He=a.exports.useRef(null),[Re,Ae]=a.exports.useState(!1),We=a.exports.useRef(!1),Me=a.exports.useCallback((async()=>{if(ve){we(!0),Se(null);try{const e=`${t}/api/t3_device/devices/${ve.serialNumber}/variable-points`,a=await fetch(e);if(!a.ok)throw new Error(`Failed to fetch variables: ${a.statusText}`);const s=(await a.json()).variable_points||[];Ce(s)}catch(e){const a=e instanceof Error?e.message:"Failed to load variables";Se(a)}finally{we(!1)}}else Ce([])}),[ve]);a.exports.useEffect((()=>{Me()}),[Me]),a.exports.useEffect((()=>{Ce([]),Te(!1),Ve.current=!1}),[null==ve?void 0:ve.serialNumber]),a.exports.useEffect((()=>{if(Ie||!ve||De||Ve.current)return;(async()=>{if(Ve.current=!0,ke.length>0)Te(!0);else{we(!0);try{const e=await h.refreshFromDevice({serialNumber:ve.serialNumber,type:"variable",onLoadingChange:e=>{e&&ye(`Loading variables from ${ve.nameShowOnTree} (Action 17)...`,"info")}});ye(`âœ“ Synced ${e.itemCount} variables from ${ve.nameShowOnTree}`,"success")}catch(e){ye(`Failed to sync variables: ${e instanceof Error?e.message:"Unknown error"}`,"error")}finally{await Me(),Te(!0),we(!1)}}})()}),[Ie,ve,De,Me,ke.length,ye]);const Pe=a.exports.useCallback((async()=>{const e=_e();e&&(Ae(!0),ge(e),setTimeout((()=>{Ae(!1)}),500))}),[_e,ge]),Ue=a.exports.useCallback((e=>{if(Re||Ie)return;const a=e.currentTarget;a.scrollHeight-a.scrollTop-a.clientHeight<=1&&ke.length>0?We.current=!0:We.current=!1}),[Re,Ie,ke.length]),Be=a.exports.useCallback((e=>{Re||Ie||0===ke.length||e.deltaY>0&&We.current&&(We.current=!1,Pe())}),[Re,Ie,ke.length,Pe]);a.exports.useEffect((()=>{ve&&He.current&&He.current.scrollTo({top:0,behavior:Re?"smooth":"auto"})}),[ve,Re]);const Oe=(e,a,s)=>{Xe({serialNumber:e.serialNumber,variableIndex:e.variableIndex||"",field:a}),qe(s||"")},Je=async()=>{if(Qe)if("fValue"===Qe.field||Ze.trim()){aa(!0);try{if(ve&&["fullLabel","fValue"].includes(Qe.field)){const e=ke.find((e=>e.serialNumber===Qe.serialNumber&&e.variableIndex===Qe.variableIndex));if(!e)throw new Error("Current variable data not found");const a={fullLabel:"fullLabel"===Qe.field?Ze:e.fullLabel||"",label:e.label||"",value:"fValue"===Qe.field?1e3*parseFloat(Ze||"0"):parseFloat(e.fValue||"0"),range:parseInt(e.rangeField||"0"),autoManual:parseInt(e.autoManual||"0"),control:0,filter:parseInt(e.filterField||"0"),digitalAnalog:"1"===e.digitalAnalog?1:0,decom:0},s=await fetch(`${t}/api/t3_device/variables/${ve.serialNumber}/${Qe.variableIndex}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!s.ok){const e=await s.text();throw new Error(`HTTP ${s.status}: ${e}`)}await s.json()}Ce((e=>e.map((e=>e.serialNumber===Qe.serialNumber&&e.variableIndex===Qe.variableIndex?{...e,[Qe.field]:"fValue"===Qe.field?(1e3*parseFloat(Ze||"0")).toString():Ze}:e)))),Xe(null)}catch(e){alert(`Failed to update: ${e instanceof Error?e.message:"Unknown error"}`)}finally{aa(!1)}}else Xe(null);else Xe(null)},Ke=e=>{"Enter"===e.key?(e.preventDefault(),Je()):"Escape"===e.key&&(e.preventDefault(),Xe(null),qe(""))},[Ge,Ye]=a.exports.useState(""),[Qe,Xe]=a.exports.useState(null),[Ze,qe]=a.exports.useState(""),[ea,aa]=a.exports.useState(!1),[sa,ra]=a.exports.useState(!1),[la,ta]=a.exports.useState(null),[ia,na]=a.exports.useState(null),[oa,da]=a.exports.useState("ascending"),ca=e=>{ia===e?da("ascending"===oa?"descending":"ascending"):(na(e),da("ascending"))},pa=s.useMemo((()=>0===ke.length?Array(10).fill(null).map(((e,a)=>({serialNumber:(null==ve?void 0:ve.serialNumber)||0,variableId:"",variableIndex:"",panel:"",fullLabel:"",autoManual:"",fValue:"",units:"",rangeField:"",calibration:"",sign:"",filterField:"",status:"",digitalAnalog:"",label:"",typeField:""}))):ke),[ke,ve]),xa=e=>!e.variableIndex&&!e.variableId&&0===ke.length,ua=[y({columnId:"panel",renderHeaderCell:()=>e.exports.jsxs("div",{className:ae,onClick:()=>ca("panel"),children:[e.exports.jsx("span",{children:"Panel"}),"panel"===ia?"ascending"===oa?e.exports.jsx(m,{}):e.exports.jsx(f,{}):e.exports.jsx(v,{className:re})]}),renderCell:a=>e.exports.jsx($,{children:!xa(a)&&(a.panel||"---")})}),y({columnId:"variable",renderHeaderCell:()=>e.exports.jsxs("div",{className:ae,onClick:()=>ca("variable"),children:[e.exports.jsx("span",{children:"Variable"}),"variable"===ia?"ascending"===oa?e.exports.jsx(m,{}):e.exports.jsx(f,{}):e.exports.jsx(v,{className:re})]}),renderCell:a=>{if(xa(a))return e.exports.jsx($,{});const s=Le.has(a.variableIndex||"");return e.exports.jsx($,{children:e.exports.jsxs("div",{className:le,children:[e.exports.jsx("button",{onClick:e=>{e.stopPropagation(),(async e=>{if(!ve)return;const a=parseInt(e,10);if(!isNaN(a)){Ee((a=>new Set(a).add(e)));try{await h.refreshSingleVariable(ve.serialNumber,a),await Me()}catch(s){}finally{Ee((a=>{const s=new Set(a);return s.delete(e),s}))}}})(a.variableIndex||"")},className:`${Z} ${s?q:""}`,title:"Refresh this variable from device",disabled:s,children:e.exports.jsx(o,{className:`${ne} ${s?ee:""}`})}),e.exports.jsx(n,{size:200,weight:"regular",children:a.variableId||(a.variableIndex?`VAR${parseInt(a.variableIndex)+1}`:"---")})]})})}}),y({columnId:"fullLabel",renderHeaderCell:()=>e.exports.jsxs("div",{className:ae,onClick:()=>ca("fullLabel"),children:[e.exports.jsx("span",{children:"Full Label"}),"fullLabel"===ia?"ascending"===oa?e.exports.jsx(m,{}):e.exports.jsx(f,{}):e.exports.jsx(v,{className:re})]}),renderCell:a=>{if(xa(a))return e.exports.jsx($,{});const s=(null==Qe?void 0:Qe.serialNumber)===a.serialNumber&&(null==Qe?void 0:Qe.variableIndex)===a.variableIndex&&"fullLabel"===(null==Qe?void 0:Qe.field);return e.exports.jsx($,{children:s?e.exports.jsxs("div",{className:te,children:[e.exports.jsx("input",{type:"text",className:`${Q} ${ie}`,value:Ze,onChange:e=>qe(e.target.value),onBlur:Je,onKeyDown:Ke,autoFocus:!0,disabled:ea,placeholder:"Enter label","aria-label":"Edit full label"}),e.exports.jsx("button",{onClick:e=>{e.stopPropagation(),Je()},disabled:ea,className:X,title:"Save",children:e.exports.jsx(j,{className:oe})})]}):e.exports.jsx("div",{className:Y,onDoubleClick:()=>Oe(a,"fullLabel",a.fullLabel||""),title:"Double-click to edit",children:e.exports.jsx(n,{size:200,weight:"regular",children:a.fullLabel||"Unnamed"})})})}}),y({columnId:"label",renderHeaderCell:()=>e.exports.jsxs("div",{className:ae,onClick:()=>ca("label"),children:[e.exports.jsx("span",{children:"Label"}),"label"===ia?"ascending"===oa?e.exports.jsx(m,{}):e.exports.jsx(f,{}):e.exports.jsx(v,{className:re})]}),renderCell:a=>{if(xa(a))return e.exports.jsx($,{});const s=(null==Qe?void 0:Qe.serialNumber)===a.serialNumber&&(null==Qe?void 0:Qe.variableIndex)===a.variableIndex&&"label"===(null==Qe?void 0:Qe.field);return e.exports.jsx($,{children:s?e.exports.jsxs("div",{className:te,children:[e.exports.jsx("input",{type:"text",className:`${Q} ${ie}`,value:Ze,onChange:e=>qe(e.target.value),onBlur:Je,onKeyDown:Ke,autoFocus:!0,disabled:ea,placeholder:"Enter label","aria-label":"Edit label"}),e.exports.jsx("button",{onClick:e=>{e.stopPropagation(),Je()},disabled:ea,className:X,title:"Save",children:e.exports.jsx(j,{className:oe})})]}):e.exports.jsx("div",{className:Y,onDoubleClick:()=>Oe(a,"label",a.label||""),title:"Double-click to edit",children:e.exports.jsx(n,{size:200,weight:"regular",children:a.label||"---"})})})}}),y({columnId:"autoManual",renderHeaderCell:()=>e.exports.jsx("div",{className:se,children:e.exports.jsx("span",{children:"Auto/Manual"})}),renderCell:a=>{var s;if(xa(a))return e.exports.jsx($,{});const r=null==(s=a.autoManual)?void 0:s.toString().toLowerCase(),l="auto"===r||"1"===r;return e.exports.jsx($,{children:e.exports.jsx("div",{onClick:async()=>{const e=l?"0":"1";try{const s=ke.find((e=>e.serialNumber===a.serialNumber&&e.variableIndex===a.variableIndex));if(!s)throw new Error("Current variable data not found");const r={fullLabel:s.fullLabel||"",label:s.label||"",value:parseFloat(s.fValue||"0"),range:parseInt(s.rangeField||"0"),autoManual:parseInt(e),control:0,filter:parseInt(s.filterField||"0"),digitalAnalog:"1"===s.digitalAnalog?1:0,calibrationSign:parseInt(s.sign||"0"),calibrationH:0,calibrationL:0},l=await fetch(`${t}/api/t3_device/variables/${a.serialNumber}/${a.variableIndex}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!l.ok){const e=await l.text();throw new Error(`HTTP ${l.status}: ${e}`)}await l.json();Ce((s=>s.map((s=>s.serialNumber===a.serialNumber&&s.variableIndex===a.variableIndex?{...s,autoManual:e}:s))))}catch(s){alert(`Failed to update Auto/Man: ${s instanceof Error?s.message:"Unknown error"}`)}},className:xe,children:e.exports.jsx(g,{checked:l,className:pe})})})}}),y({columnId:"value",renderHeaderCell:()=>e.exports.jsxs("div",{className:ae,onClick:()=>ca("value"),children:[e.exports.jsx("span",{children:"Value"}),"value"===ia?"ascending"===oa?e.exports.jsx(m,{}):e.exports.jsx(f,{}):e.exports.jsx(v,{className:re})]}),renderCell:a=>{if(xa(a))return e.exports.jsx($,{});const s=(null==Qe?void 0:Qe.serialNumber)===a.serialNumber&&(null==Qe?void 0:Qe.variableIndex)===a.variableIndex&&"fValue"===(null==Qe?void 0:Qe.field);return e.exports.jsx($,{children:s?e.exports.jsxs("div",{className:te,children:[e.exports.jsx("input",{type:"number",step:"0.01",className:`${Q} ${ie}`,value:Ze,onChange:e=>qe(e.target.value),onBlur:Je,onKeyDown:Ke,autoFocus:!0,disabled:ea,placeholder:"Enter value","aria-label":"Edit value"}),e.exports.jsx("button",{onClick:e=>{e.stopPropagation(),Je()},disabled:ea,className:X,title:"Save",children:e.exports.jsx(j,{className:oe})})]}):e.exports.jsx("div",{className:Y,onDoubleClick:()=>Oe(a,"fValue",a.fValue?(parseFloat(a.fValue)/1e3).toFixed(2):"0"),title:"Double-click to edit",children:e.exports.jsx(n,{size:200,weight:"regular",children:a.fValue?(parseFloat(a.fValue)/1e3).toFixed(2):"---"})})})}}),y({columnId:"units",renderHeaderCell:()=>e.exports.jsxs("div",{className:ae,onClick:()=>ca("units"),children:[e.exports.jsx("span",{children:"Units"}),"units"===ia?"ascending"===oa?e.exports.jsx(m,{}):e.exports.jsx(f,{}):e.exports.jsx(v,{className:re})]}),renderCell:a=>{if(xa(a))return e.exports.jsx($,{});const s=a.rangeField?parseInt(a.rangeField):0,r="1"===a.digitalAnalog?1:0,l=N(s,r);return e.exports.jsx($,{children:e.exports.jsx("div",{onClick:()=>(e=>{ta(e),ra(!0)})(a),className:ue,title:"Click to change range/units",children:e.exports.jsx(n,{size:200,weight:"regular",children:l})})})}})];return e.exports.jsxs("div",{className:F,children:[e.exports.jsx("div",{className:L,children:e.exports.jsx("div",{className:E,children:e.exports.jsx("div",{className:D,children:e.exports.jsxs("div",{className:T,children:[ze&&e.exports.jsxs("div",{className:be,children:[e.exports.jsx(i,{className:de}),e.exports.jsx(n,{className:ce,children:ze})]}),ve&&e.exports.jsxs(e.exports.Fragment,{children:[e.exports.jsx("div",{className:V,children:e.exports.jsxs("div",{className:H,children:[e.exports.jsxs("button",{className:R,onClick:async()=>{if(ve){Fe(!0),ye("Refreshing variables from device...","info");try{const e=await h.refreshFromDevice({serialNumber:ve.serialNumber,type:"variable",onLoadingChange:e=>{e&&ye("Loading data from device (Action 17)...","info")}});ye(e.message,"success")}catch(e){const a=e instanceof Error?e.message:"Failed to refresh from device";Se(a),ye(a,"error")}finally{await Me(),Fe(!1)}}},disabled:$e,title:"Refresh all variables from device","aria-label":"Refresh from Device",children:[e.exports.jsx(o,{}),e.exports.jsx("span",{children:$e?"Refreshing...":"Refresh from Device"})]}),e.exports.jsxs("button",{className:R,onClick:()=>{},title:"Export to CSV","aria-label":"Export to CSV",children:[e.exports.jsx(d,{}),e.exports.jsx("span",{children:"Export to CSV"})]}),e.exports.jsx("div",{className:A,role:"separator"}),e.exports.jsxs("button",{className:R,onClick:()=>{},title:"Settings","aria-label":"Settings",children:[e.exports.jsx(c,{}),e.exports.jsx("span",{children:"Settings"})]}),e.exports.jsxs("div",{className:W,children:[e.exports.jsx(p,{className:M}),e.exports.jsx("input",{className:P,type:"text",placeholder:"Search variables...",value:Ge,onChange:e=>{Ye(e.target.value)},spellCheck:"false",role:"searchbox","aria-label":"Search variables"})]}),e.exports.jsx(x,{content:`Showing variable points for ${ve.nameShowOnTree} (SN: ${ve.serialNumber}). This table displays all configured variable points used for internal calculations, logic operations, and data storage within the building automation system.`,relationship:"description",children:e.exports.jsx("button",{className:`${R} ${fe}`,title:"Information","aria-label":"Information about this page",children:e.exports.jsx(u,{})})})]})}),e.exports.jsx("div",{className:he,children:e.exports.jsx("hr",{className:U})})]}),e.exports.jsxs("div",{className:B,children:[Ie&&0===ke.length&&e.exports.jsxs("div",{className:K,children:[e.exports.jsx(b,{size:"tiny"}),e.exports.jsx(n,{size:200,weight:"regular",children:"Loading variables..."})]}),!ve&&!Ie&&e.exports.jsx("div",{className:J,children:e.exports.jsxs("div",{className:me,children:[e.exports.jsx(n,{size:400,weight:"semibold",children:"No device selected"}),e.exports.jsx("br",{}),e.exports.jsx(n,{size:200,children:"Please select a device from the tree to view variables"})]})}),ve&&!Ie&&e.exports.jsxs("div",{ref:He,className:O,onScroll:Ue,onWheel:Be,children:[e.exports.jsxs(k,{items:pa,columns:ua,sortable:!0,resizableColumns:!0,columnSizingOptions:{variable:{minWidth:60,defaultWidth:80},panel:{minWidth:60,defaultWidth:75},fullLabel:{minWidth:180,defaultWidth:250},label:{minWidth:130,defaultWidth:170},autoManual:{minWidth:90,defaultWidth:120},value:{minWidth:120,defaultWidth:180},units:{minWidth:100,defaultWidth:150}},children:[e.exports.jsx(C,{children:e.exports.jsx(I,{children:({renderHeaderCell:a})=>e.exports.jsx(w,{children:a()})})}),e.exports.jsx(z,{children:({item:a,rowId:s})=>e.exports.jsx(I,{children:({renderCell:s})=>e.exports.jsx(S,{children:s(a)})},s)})]}),Re&&e.exports.jsxs("div",{className:G,children:[e.exports.jsx(b,{size:"tiny"}),e.exports.jsx(n,{size:200,weight:"regular",children:"Loading next device..."})]})]}),"              "]})]})})})}),la&&e.exports.jsx(_,{isOpen:sa,onClose:()=>{ra(!1),ta(null)},currentRange:la.rangeField?parseInt(la.rangeField):0,digitalAnalog:"1"===la.digitalAnalog?1:0,onSave:async e=>{if(la)try{const a={fullLabel:la.fullLabel||"",label:la.label||"",value:parseFloat(la.fValue||"0"),range:e,autoManual:parseInt(la.autoManual||"0"),control:0,filter:parseInt(la.filterField||"0"),digitalAnalog:"1"===la.digitalAnalog?1:0,calibrationSign:parseInt(la.sign||"0"),calibrationH:0,calibrationL:0},s=await fetch(`${t}/api/t3_device/variables/${la.serialNumber}/${la.variableIndex}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!s.ok){const e=await s.text();throw new Error(`HTTP ${s.status}: ${e}`)}await s.json();Ce((a=>a.map((a=>a.serialNumber===la.serialNumber&&a.variableIndex===la.variableIndex?{...a,rangeField:e.toString()}:a))))}catch(a){alert(`Failed to update Range/Units: ${a instanceof Error?a.message:"Unknown error"}`)}},inputLabel:la.fullLabel||"Variable"})]})};export{ve as VariablesPage,ve as default};

import{j as e}from"./react.8639cc86.js";import{r as a,R as l}from"./client.58f92968.js";import{l as s,L as r,M as t,n as o,T as i,y as n,N as c,z as d,P as x,Q as u,I as p,S as h,R as b,U as g,V as f,X as m,Y as v,Z as j}from"./App.7c34790a.js";import{R as _,g as N}from"./RangeSelectionDrawer.b62b2464.js";import{c as C,D as I,a as w,b as S,d as y,e as $,f as F}from"./DataGridHeaderCell.ec45a911.js";import{T as V}from"./TableCellLayout.d4b0b796.js";import"./index.3bd6c859.js";import"./Serializer.f6a5f515.js";import"./axios.65f6a2c9.js";import"./T3Data.63f93fe7.js";import"./_commonjsHelpers.a5007c1f.js";import"./RadioGroup.bf5be0e5.js";import"./Input.7691f421.js";var k="_container_1chco_18",L="_bladeContentContainer_1chco_30",E="_bladeContentWrapper_1chco_38",A="_bladeContent_1chco_30",P="_partContent_1chco_54",D="_toolbar_1chco_63",T="_toolbarContainer_1chco_72",R="_toolbarButton_1chco_80",U="_toolbarSeparator_1chco_119",M="_searchInputWrapper_1chco_127",W="_searchIcon_1chco_134",H="_searchInput_1chco_127",z="_overviewHr_1chco_194",B="_dockingBody_1chco_202",O="_scrollContainer_1chco_211",J="_noData_1chco_242",K="_loadingBar_1chco_251",G="_autoLoadIndicator_1chco_265",Y="_editableCell_1chco_406",q="_editInput_1chco_420",Q="_saveButton_1chco_456",X="_refreshIconButton_1chco_487",Z="_isRefreshing_1chco_522",ee="_rotating_1chco_538",ae="_headerCellSort_1chco_543",le="_headerCell_1chco_543",se="_sortIconFaded_1chco_556",re="_cellFlexContainer_1chco_560",te="_editInputContainer_1chco_565",oe="_flex1_1chco_572",ie="_iconSmall_1chco_576",ne="_iconMedium_1chco_580",ce="_iconError_1chco_584",de="_textError_1chco_590",xe="_switchScale_1chco_596",ue="_switchContainer_1chco_600",pe="_rangeLink_1chco_606",he="_errorNotice_1chco_611",be="_noPadding_1chco_621",ge="_centerText_1chco_625",fe="_marginLeft8_1chco_659";const me=()=>{const{selectedDevice:me,treeData:ve,selectDevice:je,getNextDevice:_e,getFilteredDevices:Ne}=s(),Ce=r((e=>e.setMessage)),[Ie,we]=a.exports.useState([]),[Se,ye]=a.exports.useState(!1),[$e,Fe]=a.exports.useState(null),[Ve,ke]=a.exports.useState(!1),[Le,Ee]=a.exports.useState(new Set),[Ae,Pe]=a.exports.useState(!1),De=a.exports.useRef(!1),Te=a.exports.useRef(null),[Re,Ue]=a.exports.useState(!1),Me=a.exports.useRef(!1),We=a.exports.useCallback((async()=>{if(me){ye(!0),Fe(null);try{const e=`${t}/api/t3_device/devices/${me.serialNumber}/variable-points`,a=await fetch(e);if(!a.ok)throw new Error(`Failed to fetch variables: ${a.statusText}`);const l=(await a.json()).variable_points||[];we(l)}catch(e){const a=e instanceof Error?e.message:"Failed to load variables";Fe(a),console.error("Error fetching variables:",e)}finally{ye(!1)}}else we([])}),[me]);a.exports.useEffect((()=>{We()}),[We]),a.exports.useEffect((()=>{we([]),Pe(!1),De.current=!1}),[null==me?void 0:me.serialNumber]),a.exports.useEffect((()=>{if(Se||!me||Ae||De.current)return;(async()=>{if(De.current=!0,Ie.length>0)return console.log("[VariablesPage] Database has data, skipping auto-refresh"),void Pe(!0);console.log("[VariablesPage] Database empty, auto-refreshing from device..."),ye(!0);try{const e=await b.refreshFromDevice({serialNumber:me.serialNumber,type:"variable",onLoadingChange:e=>{e&&Ce(`Loading variables from ${me.nameShowOnTree} (Action 17)...`,"info")}});console.log("[VariablesPage] Auto-refresh result:",e),Ce(`✓ Synced ${e.itemCount} variables from ${me.nameShowOnTree}`,"success")}catch(e){console.error("[VariablesPage] Auto-refresh failed:",e),Ce(`Failed to sync variables: ${e instanceof Error?e.message:"Unknown error"}`,"error")}finally{await We(),Pe(!0),ye(!1)}})()}),[Se,me,Ae,We,Ie.length,Ce]);const He=a.exports.useCallback((async()=>{const e=_e();e?(console.log(`[VariablesPage] Auto-loading next device: ${e.nameShowOnTree} (SN: ${e.serialNumber})`),Ue(!0),je(e),setTimeout((()=>{Ue(!1)}),500)):console.log("[VariablesPage] No next device available")}),[_e,je]),ze=a.exports.useCallback((e=>{if(Re||Se)return;const a=e.currentTarget;a.scrollHeight-a.scrollTop-a.clientHeight<=1&&Ie.length>0?(Me.current=!0,console.log("[VariablesPage] Reached bottom, scroll again to load next device")):Me.current=!1}),[Re,Se,Ie.length]),Be=a.exports.useCallback((e=>{Re||Se||0===Ie.length||e.deltaY>0&&Me.current&&(console.log("[VariablesPage] User scrolled down while at bottom, loading next device"),Me.current=!1,He())}),[Re,Se,Ie.length,He]);a.exports.useEffect((()=>{me&&Te.current&&Te.current.scrollTo({top:0,behavior:Re?"smooth":"auto"})}),[me,Re]);const Oe=(e,a,l)=>{Qe({serialNumber:e.serialNumber,variableIndex:e.variableIndex||"",field:a}),Ze(l||"")},Je=async()=>{if(qe)if("fValue"===qe.field||Xe.trim()){aa(!0);try{if(me&&["fullLabel","fValue"].includes(qe.field)){console.log(`=== Updating ${qe.field} ===`),console.log(`Device: ${me.serialNumber}, Variable: ${qe.variableIndex}, New Value: "${Xe}"`),console.log("Using Action 16 (UPDATE_WEBVIEW_LIST)");const e=Ie.find((e=>e.serialNumber===qe.serialNumber&&e.variableIndex===qe.variableIndex));if(!e)throw new Error("Current variable data not found");console.log("[Action 16] Using current UI state as baseline:",e);const a={fullLabel:"fullLabel"===qe.field?Xe:e.fullLabel||"",label:e.label||"",value:"fValue"===qe.field?1e3*parseFloat(Xe||"0"):parseFloat(e.fValue||"0"),range:parseInt(e.rangeField||"0"),autoManual:parseInt(e.autoManual||"0"),control:0,filter:parseInt(e.filterField||"0"),digitalAnalog:"1"===e.digitalAnalog?1:0,decom:0};console.log("[Action 16] Full payload:",a);const l=await fetch(`${t}/api/t3_device/variables/${me.serialNumber}/${qe.variableIndex}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!l.ok){const e=await l.text();throw new Error(`HTTP ${l.status}: ${e}`)}const s=await l.json();console.log(`✅ ${qe.field} updated successfully!`,s)}we((e=>e.map((e=>e.serialNumber===qe.serialNumber&&e.variableIndex===qe.variableIndex?{...e,[qe.field]:"fValue"===qe.field?(1e3*parseFloat(Xe||"0")).toString():Xe}:e)))),console.log("Updated",qe.field,":",Xe,"for",qe),Qe(null)}catch(e){console.error("Failed to update:",e),alert(`Failed to update: ${e instanceof Error?e.message:"Unknown error"}`)}finally{aa(!1)}}else Qe(null);else Qe(null)},Ke=e=>{"Enter"===e.key?(e.preventDefault(),Je()):"Escape"===e.key&&(e.preventDefault(),Qe(null),Ze(""))},[Ge,Ye]=a.exports.useState(""),[qe,Qe]=a.exports.useState(null),[Xe,Ze]=a.exports.useState(""),[ea,aa]=a.exports.useState(!1),[la,sa]=a.exports.useState(!1),[ra,ta]=a.exports.useState(null),[oa,ia]=a.exports.useState(null),[na,ca]=a.exports.useState("ascending"),da=e=>{oa===e?ca("ascending"===na?"descending":"ascending"):(ia(e),ca("ascending"))},xa=l.useMemo((()=>0===Ie.length?Array(10).fill(null).map(((e,a)=>({serialNumber:(null==me?void 0:me.serialNumber)||0,variableId:"",variableIndex:"",panel:"",fullLabel:"",autoManual:"",fValue:"",units:"",rangeField:"",calibration:"",sign:"",filterField:"",status:"",digitalAnalog:"",label:"",typeField:""}))):Ie),[Ie,me]),ua=e=>!e.variableIndex&&!e.variableId&&0===Ie.length,pa=[C({columnId:"panel",renderHeaderCell:()=>e.exports.jsxs("div",{className:ae,onClick:()=>da("panel"),children:[e.exports.jsx("span",{children:"Panel"}),"panel"===oa?"ascending"===na?e.exports.jsx(g,{}):e.exports.jsx(f,{}):e.exports.jsx(m,{className:se})]}),renderCell:a=>e.exports.jsx(V,{children:!ua(a)&&(a.panel||"---")})}),C({columnId:"variable",renderHeaderCell:()=>e.exports.jsxs("div",{className:ae,onClick:()=>da("variable"),children:[e.exports.jsx("span",{children:"Variable"}),"variable"===oa?"ascending"===na?e.exports.jsx(g,{}):e.exports.jsx(f,{}):e.exports.jsx(m,{className:se})]}),renderCell:a=>{if(ua(a))return e.exports.jsx(V,{});const l=Le.has(a.variableIndex||"");return e.exports.jsx(V,{children:e.exports.jsxs("div",{className:re,children:[e.exports.jsx("button",{onClick:e=>{e.stopPropagation(),(async e=>{if(!me)return;const a=parseInt(e,10);if(isNaN(a))console.error("[VariablesPage] Invalid variable index:",e);else{Ee((a=>new Set(a).add(e)));try{console.log(`[VariablesPage] Refreshing variable ${a} from device via FFI...`);const l=await b.refreshSingleVariable(me.serialNumber,a);console.log("[VariablesPage] Refresh result:",l),await We()}catch(l){console.error(`[VariablesPage] Failed to refresh variable ${a}:`,l)}finally{Ee((a=>{const l=new Set(a);return l.delete(e),l}))}}})(a.variableIndex||"")},className:`${X} ${l?Z:""}`,title:"Refresh this variable from device",disabled:l,children:e.exports.jsx(n,{className:`${ie} ${l?ee:""}`})}),e.exports.jsx(i,{size:200,weight:"regular",children:a.variableId||(a.variableIndex?`VAR${parseInt(a.variableIndex)+1}`:"---")})]})})}}),C({columnId:"fullLabel",renderHeaderCell:()=>e.exports.jsxs("div",{className:ae,onClick:()=>da("fullLabel"),children:[e.exports.jsx("span",{children:"Full Label"}),"fullLabel"===oa?"ascending"===na?e.exports.jsx(g,{}):e.exports.jsx(f,{}):e.exports.jsx(m,{className:se})]}),renderCell:a=>{if(ua(a))return e.exports.jsx(V,{});const l=(null==qe?void 0:qe.serialNumber)===a.serialNumber&&(null==qe?void 0:qe.variableIndex)===a.variableIndex&&"fullLabel"===(null==qe?void 0:qe.field);return e.exports.jsx(V,{children:l?e.exports.jsxs("div",{className:te,children:[e.exports.jsx("input",{type:"text",className:`${q} ${oe}`,value:Xe,onChange:e=>Ze(e.target.value),onBlur:Je,onKeyDown:Ke,autoFocus:!0,disabled:ea,placeholder:"Enter label","aria-label":"Edit full label"}),e.exports.jsx("button",{onClick:e=>{e.stopPropagation(),Je()},disabled:ea,className:Q,title:"Save",children:e.exports.jsx(v,{className:ne})})]}):e.exports.jsx("div",{className:Y,onDoubleClick:()=>Oe(a,"fullLabel",a.fullLabel||""),title:"Double-click to edit",children:e.exports.jsx(i,{size:200,weight:"regular",children:a.fullLabel||"Unnamed"})})})}}),C({columnId:"label",renderHeaderCell:()=>e.exports.jsxs("div",{className:ae,onClick:()=>da("label"),children:[e.exports.jsx("span",{children:"Label"}),"label"===oa?"ascending"===na?e.exports.jsx(g,{}):e.exports.jsx(f,{}):e.exports.jsx(m,{className:se})]}),renderCell:a=>{if(ua(a))return e.exports.jsx(V,{});const l=(null==qe?void 0:qe.serialNumber)===a.serialNumber&&(null==qe?void 0:qe.variableIndex)===a.variableIndex&&"label"===(null==qe?void 0:qe.field);return e.exports.jsx(V,{children:l?e.exports.jsxs("div",{className:te,children:[e.exports.jsx("input",{type:"text",className:`${q} ${oe}`,value:Xe,onChange:e=>Ze(e.target.value),onBlur:Je,onKeyDown:Ke,autoFocus:!0,disabled:ea,placeholder:"Enter label","aria-label":"Edit label"}),e.exports.jsx("button",{onClick:e=>{e.stopPropagation(),Je()},disabled:ea,className:Q,title:"Save",children:e.exports.jsx(v,{className:ne})})]}):e.exports.jsx("div",{className:Y,onDoubleClick:()=>Oe(a,"label",a.label||""),title:"Double-click to edit",children:e.exports.jsx(i,{size:200,weight:"regular",children:a.label||"---"})})})}}),C({columnId:"autoManual",renderHeaderCell:()=>e.exports.jsx("div",{className:le,children:e.exports.jsx("span",{children:"Auto/Manual"})}),renderCell:a=>{var l;if(ua(a))return e.exports.jsx(V,{});const s=null==(l=a.autoManual)?void 0:l.toString().toLowerCase(),r="auto"===s||"1"===s;return e.exports.jsx(V,{children:e.exports.jsx("div",{onClick:async()=>{const e=r?"0":"1";console.log("Auto/Man toggled:",a.serialNumber,a.variableIndex,e);try{const l=Ie.find((e=>e.serialNumber===a.serialNumber&&e.variableIndex===a.variableIndex));if(!l)throw new Error("Current variable data not found");const s={fullLabel:l.fullLabel||"",label:l.label||"",value:parseFloat(l.fValue||"0"),range:parseInt(l.rangeField||"0"),autoManual:parseInt(e),control:0,filter:parseInt(l.filterField||"0"),digitalAnalog:"1"===l.digitalAnalog?1:0,calibrationSign:parseInt(l.sign||"0"),calibrationH:0,calibrationL:0};console.log("[Action 16] Updating Auto/Man:",s);const r=await fetch(`${t}/api/t3_device/variables/${a.serialNumber}/${a.variableIndex}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!r.ok){const e=await r.text();throw new Error(`HTTP ${r.status}: ${e}`)}const o=await r.json();console.log("[Action 16] Auto/Man updated successfully:",o),we((l=>l.map((l=>l.serialNumber===a.serialNumber&&l.variableIndex===a.variableIndex?{...l,autoManual:e}:l))))}catch(l){console.error("Failed to update Auto/Man:",l),alert(`Failed to update Auto/Man: ${l instanceof Error?l.message:"Unknown error"}`)}},className:ue,children:e.exports.jsx(j,{checked:r,className:xe})})})}}),C({columnId:"value",renderHeaderCell:()=>e.exports.jsxs("div",{className:ae,onClick:()=>da("value"),children:[e.exports.jsx("span",{children:"Value"}),"value"===oa?"ascending"===na?e.exports.jsx(g,{}):e.exports.jsx(f,{}):e.exports.jsx(m,{className:se})]}),renderCell:a=>{if(ua(a))return e.exports.jsx(V,{});const l=(null==qe?void 0:qe.serialNumber)===a.serialNumber&&(null==qe?void 0:qe.variableIndex)===a.variableIndex&&"fValue"===(null==qe?void 0:qe.field);return e.exports.jsx(V,{children:l?e.exports.jsxs("div",{className:te,children:[e.exports.jsx("input",{type:"number",step:"0.01",className:`${q} ${oe}`,value:Xe,onChange:e=>Ze(e.target.value),onBlur:Je,onKeyDown:Ke,autoFocus:!0,disabled:ea,placeholder:"Enter value","aria-label":"Edit value"}),e.exports.jsx("button",{onClick:e=>{e.stopPropagation(),Je()},disabled:ea,className:Q,title:"Save",children:e.exports.jsx(v,{className:ne})})]}):e.exports.jsx("div",{className:Y,onDoubleClick:()=>Oe(a,"fValue",a.fValue?(parseFloat(a.fValue)/1e3).toFixed(2):"0"),title:"Double-click to edit",children:e.exports.jsx(i,{size:200,weight:"regular",children:a.fValue?(parseFloat(a.fValue)/1e3).toFixed(2):"---"})})})}}),C({columnId:"units",renderHeaderCell:()=>e.exports.jsxs("div",{className:ae,onClick:()=>da("units"),children:[e.exports.jsx("span",{children:"Units"}),"units"===oa?"ascending"===na?e.exports.jsx(g,{}):e.exports.jsx(f,{}):e.exports.jsx(m,{className:se})]}),renderCell:a=>{if(ua(a))return e.exports.jsx(V,{});const l=a.rangeField?parseInt(a.rangeField):0,s="1"===a.digitalAnalog?1:0,r=N(l,s);return e.exports.jsx(V,{children:e.exports.jsx("div",{onClick:()=>(e=>{ta(e),sa(!0)})(a),className:pe,title:"Click to change range/units",children:e.exports.jsx(i,{size:200,weight:"regular",children:r})})})}})];return e.exports.jsxs("div",{className:k,children:[e.exports.jsx("div",{className:L,children:e.exports.jsx("div",{className:E,children:e.exports.jsx("div",{className:A,children:e.exports.jsxs("div",{className:P,children:[$e&&e.exports.jsxs("div",{className:he,children:[e.exports.jsx(o,{className:ce}),e.exports.jsx(i,{className:de,children:$e})]}),me&&e.exports.jsxs(e.exports.Fragment,{children:[e.exports.jsx("div",{className:D,children:e.exports.jsxs("div",{className:T,children:[e.exports.jsxs("button",{className:R,onClick:async()=>{if(me){ke(!0),Ce("Refreshing variables from device...","info");try{console.log("[VariablesPage] Refreshing all variables from device via FFI...");const e=await b.refreshFromDevice({serialNumber:me.serialNumber,type:"variable",onLoadingChange:e=>{e&&Ce("Loading data from device (Action 17)...","info")}});console.log("[VariablesPage] Refresh result:",e),Ce(e.message,"success")}catch(e){console.error("[VariablesPage] Failed to refresh from device:",e);const a=e instanceof Error?e.message:"Failed to refresh from device";Fe(a),Ce(a,"error")}finally{await We(),ke(!1)}}},disabled:Ve,title:"Refresh all variables from device","aria-label":"Refresh from Device",children:[e.exports.jsx(n,{}),e.exports.jsx("span",{children:Ve?"Refreshing...":"Refresh from Device"})]}),e.exports.jsxs("button",{className:R,onClick:()=>{console.log("Export variables to CSV")},title:"Export to CSV","aria-label":"Export to CSV",children:[e.exports.jsx(c,{}),e.exports.jsx("span",{children:"Export to CSV"})]}),e.exports.jsx("div",{className:U,role:"separator"}),e.exports.jsxs("button",{className:R,onClick:()=>{console.log("Settings clicked")},title:"Settings","aria-label":"Settings",children:[e.exports.jsx(d,{}),e.exports.jsx("span",{children:"Settings"})]}),e.exports.jsxs("div",{className:M,children:[e.exports.jsx(x,{className:W}),e.exports.jsx("input",{className:H,type:"text",placeholder:"Search variables...",value:Ge,onChange:e=>{Ye(e.target.value),console.log("Search query:",e.target.value)},spellCheck:"false",role:"searchbox","aria-label":"Search variables"})]}),e.exports.jsx(u,{content:`Showing variable points for ${me.nameShowOnTree} (SN: ${me.serialNumber}). This table displays all configured variable points used for internal calculations, logic operations, and data storage within the building automation system.`,relationship:"description",children:e.exports.jsx("button",{className:`${R} ${fe}`,title:"Information","aria-label":"Information about this page",children:e.exports.jsx(p,{})})})]})}),e.exports.jsx("div",{className:be,children:e.exports.jsx("hr",{className:z})})]}),e.exports.jsxs("div",{className:B,children:[Se&&0===Ie.length&&e.exports.jsxs("div",{className:K,children:[e.exports.jsx(h,{size:"tiny"}),e.exports.jsx(i,{size:200,weight:"regular",children:"Loading variables..."})]}),!me&&!Se&&e.exports.jsx("div",{className:J,children:e.exports.jsxs("div",{className:ge,children:[e.exports.jsx(i,{size:400,weight:"semibold",children:"No device selected"}),e.exports.jsx("br",{}),e.exports.jsx(i,{size:200,children:"Please select a device from the tree to view variables"})]})}),me&&!Se&&e.exports.jsxs("div",{ref:Te,className:O,onScroll:ze,onWheel:Be,children:[e.exports.jsxs(I,{items:xa,columns:pa,sortable:!0,resizableColumns:!0,columnSizingOptions:{variable:{minWidth:60,defaultWidth:80},panel:{minWidth:60,defaultWidth:75},fullLabel:{minWidth:180,defaultWidth:250},label:{minWidth:130,defaultWidth:170},autoManual:{minWidth:90,defaultWidth:120},value:{minWidth:120,defaultWidth:180},units:{minWidth:100,defaultWidth:150}},children:[e.exports.jsx(w,{children:e.exports.jsx(S,{children:({renderHeaderCell:a})=>e.exports.jsx(y,{children:a()})})}),e.exports.jsx($,{children:({item:a,rowId:l})=>e.exports.jsx(S,{children:({renderCell:l})=>e.exports.jsx(F,{children:l(a)})},l)})]}),Re&&e.exports.jsxs("div",{className:G,children:[e.exports.jsx(h,{size:"tiny"}),e.exports.jsx(i,{size:200,weight:"regular",children:"Loading next device..."})]})]}),"              "]})]})})})}),ra&&e.exports.jsx(_,{isOpen:la,onClose:()=>{sa(!1),ta(null)},currentRange:ra.rangeField?parseInt(ra.rangeField):0,digitalAnalog:"1"===ra.digitalAnalog?1:0,onSave:async e=>{if(ra)try{console.log(`[Action 16] Updating Range/Units for Variable ${ra.variableIndex} (SN: ${ra.serialNumber})`);const a={fullLabel:ra.fullLabel||"",label:ra.label||"",value:parseFloat(ra.fValue||"0"),range:e,autoManual:parseInt(ra.autoManual||"0"),control:0,filter:parseInt(ra.filterField||"0"),digitalAnalog:"1"===ra.digitalAnalog?1:0,calibrationSign:parseInt(ra.sign||"0"),calibrationH:0,calibrationL:0};console.log("[Action 16] Full payload:",a);const l=await fetch(`${t}/api/t3_device/variables/${ra.serialNumber}/${ra.variableIndex}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!l.ok){const e=await l.text();throw new Error(`HTTP ${l.status}: ${e}`)}const s=await l.json();console.log("[Action 16] Range/Units updated successfully:",s),we((a=>a.map((a=>a.serialNumber===ra.serialNumber&&a.variableIndex===ra.variableIndex?{...a,rangeField:e.toString()}:a))))}catch(a){console.error("Failed to update Range/Units:",a),alert(`Failed to update Range/Units: ${a instanceof Error?a.message:"Unknown error"}`)}},inputLabel:ra.fullLabel||"Variable"})]})};export{me as VariablesPage,me as default};

import{j as e}from"./react.1acd1a13.js";import{r as a,R as s}from"./client.58f92968.js";import{l as r,L as l,M as t,n as i,T as n,y as o,N as c,z as d,P as x,Q as u,I as p,S as h,R as b,U as m,V as f,X as v,Y as j,Z as g}from"./App.3fe38e41.js";import{R as _,g as N}from"./RangeSelectionDrawer.b80e2e52.js";import{c as C,D as I,a as w,b as S,d as y,e as k,f as $}from"./DataGridHeaderCell.f7016832.js";import{T as L}from"./TableCellLayout.9e29eb07.js";import"./index.2479820c.js";import"./Serializer.f6a5f515.js";import"./T3Data.5fdf3c76.js";import"./_commonjsHelpers.a5007c1f.js";import"./RadioGroup.34e0e018.js";import"./Input.037b8c53.js";var F="_container_1chco_18",E="_bladeContentContainer_1chco_30",T="_bladeContentWrapper_1chco_38",D="_bladeContent_1chco_30",V="_partContent_1chco_54",H="_toolbar_1chco_63",R="_toolbarContainer_1chco_72",A="_toolbarButton_1chco_80",W="_toolbarSeparator_1chco_119",M="_searchInputWrapper_1chco_127",z="_searchIcon_1chco_134",P="_searchInput_1chco_127",U="_overviewHr_1chco_194",B="_dockingBody_1chco_202",O="_scrollContainer_1chco_211",J="_noData_1chco_242",K="_loadingBar_1chco_251",G="_autoLoadIndicator_1chco_265",Y="_editableCell_1chco_406",Q="_editInput_1chco_420",X="_saveButton_1chco_456",Z="_refreshIconButton_1chco_487",q="_isRefreshing_1chco_522",ee="_rotating_1chco_538",ae="_headerCellSort_1chco_543",se="_headerCell_1chco_543",re="_sortIconFaded_1chco_556",le="_cellFlexContainer_1chco_560",te="_editInputContainer_1chco_565",ie="_flex1_1chco_572",ne="_iconSmall_1chco_576",oe="_iconMedium_1chco_580",ce="_iconError_1chco_584",de="_textError_1chco_590",xe="_switchScale_1chco_596",ue="_switchContainer_1chco_600",pe="_rangeLink_1chco_606",he="_errorNotice_1chco_611",be="_noPadding_1chco_621",me="_centerText_1chco_625",fe="_marginLeft8_1chco_659";const ve=()=>{const{selectedDevice:ve,treeData:je,selectDevice:ge,getNextDevice:_e,getFilteredDevices:Ne}=r(),Ce=l((e=>e.setMessage)),[Ie,we]=a.exports.useState([]),[Se,ye]=a.exports.useState(!1),[ke,$e]=a.exports.useState(null),[Le,Fe]=a.exports.useState(!1),[Ee,Te]=a.exports.useState(new Set),[De,Ve]=a.exports.useState(!1),He=a.exports.useRef(!1),Re=a.exports.useRef(null),[Ae,We]=a.exports.useState(!1),Me=a.exports.useRef(!1),ze=a.exports.useCallback((async()=>{if(ve){ye(!0),$e(null);try{const e=`${t}/api/t3_device/devices/${ve.serialNumber}/variable-points`,a=await fetch(e);if(!a.ok)throw new Error(`Failed to fetch variables: ${a.statusText}`);const s=(await a.json()).variable_points||[];we(s)}catch(e){const a=e instanceof Error?e.message:"Failed to load variables";$e(a)}finally{ye(!1)}}else we([])}),[ve]);a.exports.useEffect((()=>{ze()}),[ze]),a.exports.useEffect((()=>{we([]),Ve(!1),He.current=!1}),[null==ve?void 0:ve.serialNumber]),a.exports.useEffect((()=>{if(Se||!ve||De||He.current)return;(async()=>{if(He.current=!0,Ie.length>0)Ve(!0);else{ye(!0);try{const e=await b.refreshFromDevice({serialNumber:ve.serialNumber,type:"variable",onLoadingChange:e=>{e&&Ce(`Loading variables from ${ve.nameShowOnTree} (Action 17)...`,"info")}});Ce(`âœ“ Synced ${e.itemCount} variables from ${ve.nameShowOnTree}`,"success")}catch(e){Ce(`Failed to sync variables: ${e instanceof Error?e.message:"Unknown error"}`,"error")}finally{await ze(),Ve(!0),ye(!1)}}})()}),[Se,ve,De,ze,Ie.length,Ce]);const Pe=a.exports.useCallback((async()=>{const e=_e();e&&(We(!0),ge(e),setTimeout((()=>{We(!1)}),500))}),[_e,ge]),Ue=a.exports.useCallback((e=>{if(Ae||Se)return;const a=e.currentTarget;a.scrollHeight-a.scrollTop-a.clientHeight<=1&&Ie.length>0?Me.current=!0:Me.current=!1}),[Ae,Se,Ie.length]),Be=a.exports.useCallback((e=>{Ae||Se||0===Ie.length||e.deltaY>0&&Me.current&&(Me.current=!1,Pe())}),[Ae,Se,Ie.length,Pe]);a.exports.useEffect((()=>{ve&&Re.current&&Re.current.scrollTo({top:0,behavior:Ae?"smooth":"auto"})}),[ve,Ae]);const Oe=(e,a,s)=>{Xe({serialNumber:e.serialNumber,variableIndex:e.variableIndex||"",field:a}),qe(s||"")},Je=async()=>{if(Qe)if("fValue"===Qe.field||Ze.trim()){aa(!0);try{if(ve&&["fullLabel","fValue"].includes(Qe.field)){const e=Ie.find((e=>e.serialNumber===Qe.serialNumber&&e.variableIndex===Qe.variableIndex));if(!e)throw new Error("Current variable data not found");const a={fullLabel:"fullLabel"===Qe.field?Ze:e.fullLabel||"",label:e.label||"",value:"fValue"===Qe.field?parseFloat(Ze||"0"):parseFloat(e.fValue||"0"),range:parseInt(e.rangeField||"0"),autoManual:parseInt(e.autoManual||"0"),control:0,filter:parseInt(e.filterField||"0"),digitalAnalog:"1"===e.digitalAnalog?1:0,decom:0},s=await fetch(`${t}/api/t3_device/variables/${ve.serialNumber}/${Qe.variableIndex}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!s.ok){const e=await s.text();throw new Error(`HTTP ${s.status}: ${e}`)}await s.json()}we((e=>e.map((e=>e.serialNumber===Qe.serialNumber&&e.variableIndex===Qe.variableIndex?{...e,[Qe.field]:Ze}:e)))),Xe(null)}catch(e){alert(`Failed to update: ${e instanceof Error?e.message:"Unknown error"}`)}finally{aa(!1)}}else Xe(null);else Xe(null)},Ke=e=>{"Enter"===e.key?(e.preventDefault(),Je()):"Escape"===e.key&&(e.preventDefault(),Xe(null),qe(""))},[Ge,Ye]=a.exports.useState(""),[Qe,Xe]=a.exports.useState(null),[Ze,qe]=a.exports.useState(""),[ea,aa]=a.exports.useState(!1),[sa,ra]=a.exports.useState(!1),[la,ta]=a.exports.useState(null),[ia,na]=a.exports.useState(null),[oa,ca]=a.exports.useState("ascending"),da=e=>{ia===e?ca("ascending"===oa?"descending":"ascending"):(na(e),ca("ascending"))},xa=s.useMemo((()=>0===Ie.length?Array(10).fill(null).map(((e,a)=>({serialNumber:(null==ve?void 0:ve.serialNumber)||0,variableId:"",variableIndex:"",panel:"",fullLabel:"",autoManual:"",fValue:"",units:"",rangeField:"",calibration:"",sign:"",filterField:"",status:"",digitalAnalog:"",label:"",typeField:""}))):Ie),[Ie,ve]),ua=e=>!e.variableIndex&&!e.variableId&&0===Ie.length,pa=[C({columnId:"panel",renderHeaderCell:()=>e.exports.jsxs("div",{className:ae,onClick:()=>da("panel"),children:[e.exports.jsx("span",{children:"Panel"}),"panel"===ia?"ascending"===oa?e.exports.jsx(m,{}):e.exports.jsx(f,{}):e.exports.jsx(v,{className:re})]}),renderCell:a=>e.exports.jsx(L,{children:!ua(a)&&(a.panel||"---")})}),C({columnId:"variable",renderHeaderCell:()=>e.exports.jsxs("div",{className:ae,onClick:()=>da("variable"),children:[e.exports.jsx("span",{children:"Variable"}),"variable"===ia?"ascending"===oa?e.exports.jsx(m,{}):e.exports.jsx(f,{}):e.exports.jsx(v,{className:re})]}),renderCell:a=>{if(ua(a))return e.exports.jsx(L,{});const s=Ee.has(a.variableIndex||"");return e.exports.jsx(L,{children:e.exports.jsxs("div",{className:le,children:[e.exports.jsx("button",{onClick:e=>{e.stopPropagation(),(async e=>{if(!ve)return;const a=parseInt(e,10);if(!isNaN(a)){Te((a=>new Set(a).add(e)));try{await b.refreshSingleVariable(ve.serialNumber,a),await ze()}catch(s){}finally{Te((a=>{const s=new Set(a);return s.delete(e),s}))}}})(a.variableIndex||"")},className:`${Z} ${s?q:""}`,title:"Refresh this variable from device",disabled:s,children:e.exports.jsx(o,{className:`${ne} ${s?ee:""}`})}),e.exports.jsx(n,{size:200,weight:"regular",children:a.variableId||(a.variableIndex?`VAR${parseInt(a.variableIndex)+1}`:"---")})]})})}}),C({columnId:"fullLabel",renderHeaderCell:()=>e.exports.jsxs("div",{className:ae,onClick:()=>da("fullLabel"),children:[e.exports.jsx("span",{children:"Full Label"}),"fullLabel"===ia?"ascending"===oa?e.exports.jsx(m,{}):e.exports.jsx(f,{}):e.exports.jsx(v,{className:re})]}),renderCell:a=>{if(ua(a))return e.exports.jsx(L,{});const s=(null==Qe?void 0:Qe.serialNumber)===a.serialNumber&&(null==Qe?void 0:Qe.variableIndex)===a.variableIndex&&"fullLabel"===(null==Qe?void 0:Qe.field);return e.exports.jsx(L,{children:s?e.exports.jsxs("div",{className:te,children:[e.exports.jsx("input",{type:"text",className:`${Q} ${ie}`,value:Ze,onChange:e=>qe(e.target.value),onBlur:Je,onKeyDown:Ke,autoFocus:!0,disabled:ea,placeholder:"Enter label","aria-label":"Edit full label"}),e.exports.jsx("button",{onClick:e=>{e.stopPropagation(),Je()},disabled:ea,className:X,title:"Save",children:e.exports.jsx(j,{className:oe})})]}):e.exports.jsx("div",{className:Y,onDoubleClick:()=>Oe(a,"fullLabel",a.fullLabel||""),title:"Double-click to edit",children:e.exports.jsx(n,{size:200,weight:"regular",children:a.fullLabel||"Unnamed"})})})}}),C({columnId:"label",renderHeaderCell:()=>e.exports.jsxs("div",{className:ae,onClick:()=>da("label"),children:[e.exports.jsx("span",{children:"Label"}),"label"===ia?"ascending"===oa?e.exports.jsx(m,{}):e.exports.jsx(f,{}):e.exports.jsx(v,{className:re})]}),renderCell:a=>{if(ua(a))return e.exports.jsx(L,{});const s=(null==Qe?void 0:Qe.serialNumber)===a.serialNumber&&(null==Qe?void 0:Qe.variableIndex)===a.variableIndex&&"label"===(null==Qe?void 0:Qe.field);return e.exports.jsx(L,{children:s?e.exports.jsxs("div",{className:te,children:[e.exports.jsx("input",{type:"text",className:`${Q} ${ie}`,value:Ze,onChange:e=>qe(e.target.value),onBlur:Je,onKeyDown:Ke,autoFocus:!0,disabled:ea,placeholder:"Enter label","aria-label":"Edit label"}),e.exports.jsx("button",{onClick:e=>{e.stopPropagation(),Je()},disabled:ea,className:X,title:"Save",children:e.exports.jsx(j,{className:oe})})]}):e.exports.jsx("div",{className:Y,onDoubleClick:()=>Oe(a,"label",a.label||""),title:"Double-click to edit",children:e.exports.jsx(n,{size:200,weight:"regular",children:a.label||"---"})})})}}),C({columnId:"autoManual",renderHeaderCell:()=>e.exports.jsx("div",{className:se,children:e.exports.jsx("span",{children:"Auto/Manual"})}),renderCell:a=>{var s;if(ua(a))return e.exports.jsx(L,{});const r=null==(s=a.autoManual)?void 0:s.toString().toLowerCase(),l="auto"===r||"1"===r;return e.exports.jsx(L,{children:e.exports.jsx("div",{onClick:async()=>{const e=l?"0":"1";try{const s=Ie.find((e=>e.serialNumber===a.serialNumber&&e.variableIndex===a.variableIndex));if(!s)throw new Error("Current variable data not found");const r={fullLabel:s.fullLabel||"",label:s.label||"",value:parseFloat(s.fValue||"0"),range:parseInt(s.rangeField||"0"),autoManual:parseInt(e),control:0,filter:parseInt(s.filterField||"0"),digitalAnalog:"1"===s.digitalAnalog?1:0,calibrationSign:parseInt(s.sign||"0"),calibrationH:0,calibrationL:0},l=await fetch(`${t}/api/t3_device/variables/${a.serialNumber}/${a.variableIndex}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!l.ok){const e=await l.text();throw new Error(`HTTP ${l.status}: ${e}`)}await l.json();we((s=>s.map((s=>s.serialNumber===a.serialNumber&&s.variableIndex===a.variableIndex?{...s,autoManual:e}:s))))}catch(s){alert(`Failed to update Auto/Man: ${s instanceof Error?s.message:"Unknown error"}`)}},className:ue,children:e.exports.jsx(g,{checked:l,className:xe})})})}}),C({columnId:"value",renderHeaderCell:()=>e.exports.jsxs("div",{className:ae,onClick:()=>da("value"),children:[e.exports.jsx("span",{children:"Value"}),"value"===ia?"ascending"===oa?e.exports.jsx(m,{}):e.exports.jsx(f,{}):e.exports.jsx(v,{className:re})]}),renderCell:a=>{if(ua(a))return e.exports.jsx(L,{});const s=(null==Qe?void 0:Qe.serialNumber)===a.serialNumber&&(null==Qe?void 0:Qe.variableIndex)===a.variableIndex&&"fValue"===(null==Qe?void 0:Qe.field);return e.exports.jsx(L,{children:s?e.exports.jsxs("div",{className:te,children:[e.exports.jsx("input",{type:"number",step:"0.01",className:`${Q} ${ie}`,value:Ze,onChange:e=>qe(e.target.value),onBlur:Je,onKeyDown:Ke,autoFocus:!0,disabled:ea,placeholder:"Enter value","aria-label":"Edit value"}),e.exports.jsx("button",{onClick:e=>{e.stopPropagation(),Je()},disabled:ea,className:X,title:"Save",children:e.exports.jsx(j,{className:oe})})]}):e.exports.jsx("div",{className:Y,onDoubleClick:()=>{var e;return Oe(a,"fValue",(null==(e=a.fValue)?void 0:e.toString())||"0")},title:"Double-click to edit",children:e.exports.jsx(n,{size:200,weight:"regular",children:a.fValue||"---"})})})}}),C({columnId:"units",renderHeaderCell:()=>e.exports.jsxs("div",{className:ae,onClick:()=>da("units"),children:[e.exports.jsx("span",{children:"Units"}),"units"===ia?"ascending"===oa?e.exports.jsx(m,{}):e.exports.jsx(f,{}):e.exports.jsx(v,{className:re})]}),renderCell:a=>{if(ua(a))return e.exports.jsx(L,{});const s=a.rangeField?parseInt(a.rangeField):0,r="1"===a.digitalAnalog?1:0,l=N(s,r);return e.exports.jsx(L,{children:e.exports.jsx("div",{onClick:()=>(e=>{ta(e),ra(!0)})(a),className:pe,title:"Click to change range/units",children:e.exports.jsx(n,{size:200,weight:"regular",children:l})})})}})];return e.exports.jsxs("div",{className:F,children:[e.exports.jsx("div",{className:E,children:e.exports.jsx("div",{className:T,children:e.exports.jsx("div",{className:D,children:e.exports.jsxs("div",{className:V,children:[ke&&e.exports.jsxs("div",{className:he,children:[e.exports.jsx(i,{className:ce}),e.exports.jsx(n,{className:de,children:ke})]}),ve&&e.exports.jsxs(e.exports.Fragment,{children:[e.exports.jsx("div",{className:H,children:e.exports.jsxs("div",{className:R,children:[e.exports.jsxs("button",{className:A,onClick:async()=>{if(ve){Fe(!0),Ce("Refreshing variables from device...","info");try{const e=await b.refreshFromDevice({serialNumber:ve.serialNumber,type:"variable",onLoadingChange:e=>{e&&Ce("Loading data from device (Action 17)...","info")}});Ce(e.message,"success")}catch(e){const a=e instanceof Error?e.message:"Failed to refresh from device";$e(a),Ce(a,"error")}finally{await ze(),Fe(!1)}}},disabled:Le,title:"Refresh all variables from device","aria-label":"Refresh from Device",children:[e.exports.jsx(o,{}),e.exports.jsx("span",{children:Le?"Refreshing...":"Refresh from Device"})]}),e.exports.jsxs("button",{className:A,onClick:()=>{},title:"Export to CSV","aria-label":"Export to CSV",children:[e.exports.jsx(c,{}),e.exports.jsx("span",{children:"Export to CSV"})]}),e.exports.jsx("div",{className:W,role:"separator"}),e.exports.jsxs("button",{className:A,onClick:()=>{},title:"Settings","aria-label":"Settings",children:[e.exports.jsx(d,{}),e.exports.jsx("span",{children:"Settings"})]}),e.exports.jsxs("div",{className:M,children:[e.exports.jsx(x,{className:z}),e.exports.jsx("input",{className:P,type:"text",placeholder:"Search variables...",value:Ge,onChange:e=>{Ye(e.target.value)},spellCheck:"false",role:"searchbox","aria-label":"Search variables"})]}),e.exports.jsx(u,{content:`Showing variable points for ${ve.nameShowOnTree} (SN: ${ve.serialNumber}). This table displays all configured variable points used for internal calculations, logic operations, and data storage within the building automation system.`,relationship:"description",children:e.exports.jsx("button",{className:`${A} ${fe}`,title:"Information","aria-label":"Information about this page",children:e.exports.jsx(p,{})})})]})}),e.exports.jsx("div",{className:be,children:e.exports.jsx("hr",{className:U})})]}),e.exports.jsxs("div",{className:B,children:[Se&&0===Ie.length&&e.exports.jsxs("div",{className:K,children:[e.exports.jsx(h,{size:"tiny"}),e.exports.jsx(n,{size:200,weight:"regular",children:"Loading variables..."})]}),!ve&&!Se&&e.exports.jsx("div",{className:J,children:e.exports.jsxs("div",{className:me,children:[e.exports.jsx(n,{size:400,weight:"semibold",children:"No device selected"}),e.exports.jsx("br",{}),e.exports.jsx(n,{size:200,children:"Please select a device from the tree to view variables"})]})}),ve&&!Se&&e.exports.jsxs("div",{ref:Re,className:O,onScroll:Ue,onWheel:Be,children:[e.exports.jsxs(I,{items:xa,columns:pa,sortable:!0,resizableColumns:!0,columnSizingOptions:{variable:{minWidth:60,defaultWidth:80},panel:{minWidth:60,defaultWidth:75},fullLabel:{minWidth:180,defaultWidth:250},label:{minWidth:130,defaultWidth:170},autoManual:{minWidth:90,defaultWidth:120},value:{minWidth:120,defaultWidth:180},units:{minWidth:100,defaultWidth:150}},children:[e.exports.jsx(w,{children:e.exports.jsx(S,{children:({renderHeaderCell:a})=>e.exports.jsx(y,{children:a()})})}),e.exports.jsx(k,{children:({item:a,rowId:s})=>e.exports.jsx(S,{children:({renderCell:s})=>e.exports.jsx($,{children:s(a)})},s)})]}),Ae&&e.exports.jsxs("div",{className:G,children:[e.exports.jsx(h,{size:"tiny"}),e.exports.jsx(n,{size:200,weight:"regular",children:"Loading next device..."})]})]}),"              "]})]})})})}),la&&e.exports.jsx(_,{isOpen:sa,onClose:()=>{ra(!1),ta(null)},currentRange:la.rangeField?parseInt(la.rangeField):0,digitalAnalog:"1"===la.digitalAnalog?1:0,onSave:async e=>{if(la)try{const a={fullLabel:la.fullLabel||"",label:la.label||"",value:parseFloat(la.fValue||"0"),range:e,autoManual:parseInt(la.autoManual||"0"),control:0,filter:parseInt(la.filterField||"0"),digitalAnalog:"1"===la.digitalAnalog?1:0,calibrationSign:parseInt(la.sign||"0"),calibrationH:0,calibrationL:0},s=await fetch(`${t}/api/t3_device/variables/${la.serialNumber}/${la.variableIndex}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!s.ok){const e=await s.text();throw new Error(`HTTP ${s.status}: ${e}`)}await s.json();we((a=>a.map((a=>a.serialNumber===la.serialNumber&&a.variableIndex===la.variableIndex?{...a,rangeField:e.toString()}:a))))}catch(a){alert(`Failed to update Range/Units: ${a instanceof Error?a.message:"Unknown error"}`)}},inputLabel:la.fullLabel||"Variable"})]})};export{ve as VariablesPage,ve as default};
